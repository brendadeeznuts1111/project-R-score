name: ğŸ§ª Dual Test Runner CI/CD

on:
  push:
    branches: [ main, develop, 'feat/*', 'fix/*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      runner_type:
        description: 'Test runner type'
        required: false
        default: 'both'
        type: choice
        options:
        - both
        - bun-only
        - jest-only
      coverage_threshold:
        description: 'Coverage threshold override'
        required: false
        default: '90'
        type: string

env:
  NODE_ENV: test
  CASH_APP_CLIENT_ID: test_cash_app_client_id
  CASH_APP_CLIENT_SECRET: test_cash_app_client_secret
  PLAID_CLIENT_ID: test_plaid_client_id
  PLAID_SECRET: test_plaid_secret
  PLAID_ENV: sandbox

jobs:
  # Bun Test Runner - Fast Native Tests
  bun-tests:
    name: ğŸ¥• Bun Test Runner
    runs-on: ubuntu-latest
    if: github.event.inputs.runner_type != 'jest-only'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ¥• Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: 1.3.6
        
    - name: ğŸ“¦ Install Dependencies
      run: bun install --frozen-lockfile
      
    - name: ğŸ”§ Setup Test Environment
      run: |
        bun run adapter:init
        cp config/local.toml.template config/local.toml
        
    - name: ğŸ§ª Run Bun Tests
      run: |
        echo "ğŸ§ª Running Bun Test Suite..."
        bun test --coverage --reporter=verbose
        
    - name: ğŸ“Š Generate Coverage Report
      run: |
        bun test --coverage --coverage-reporter=html --coverage-reporter=json
        
    - name: â±ï¸ Performance Benchmark
      run: |
        echo "âš¡ Running performance benchmarks..."
        bun run adapter:bench 100
        
    - name: ğŸ¥ Health Check
      run: |
        echo "ğŸ¥ Running health checks..."
        bun run adapter:health
        
    - name: ğŸ“¤ Upload Bun Coverage
      uses: actions/upload-artifact@v4
      with:
        name: bun-coverage
        path: |
          coverage/
          bun-results.txt
        retention-days: 30
        
    - name: ğŸ“Š Coverage Summary
      run: |
        echo "## ğŸ¥• Bun Test Results" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Coverage Metrics" >> $GITHUB_STEP_SUMMARY
        bun test --coverage --coverage-reporter=text-summary >> $GITHUB_STEP_SUMMARY
        echo "### âš¡ Performance" >> $GITHUB_STEP_SUMMARY
        bun run adapter:bench 10 >> $GITHUB_STEP_SUMMARY

  # Jest Test Runner - Comprehensive Testing
  jest-tests:
    name: ğŸƒ Jest Test Runner
    runs-on: ubuntu-latest
    if: github.event.inputs.runner_type != 'bun-only'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm install
        npm install -g jest
        
    - name: ğŸ”§ Setup Test Environment
      run: |
        npm run adapter:init
        cp config/local.toml.template config/local.toml
        
    - name: ğŸ§ª Run Jest Tests
      run: |
        echo "ğŸƒ Running Jest Test Suite..."
        npm run jest:ci
        
    - name: ğŸ“Š Generate Jest Coverage
      run: |
        npm run jest:coverage
        
    - name: â±ï¸ Jest Performance Tests
      run: |
        echo "âš¡ Running Jest performance tests..."
        npm run jest:modules -- --testTimeout=30000
        
    - name: ğŸ“¤ Upload Jest Coverage
      uses: actions/upload-artifact@v4
      with:
        name: jest-coverage
        path: |
          coverage/
          jest-results.txt
        retention-days: 30
        
    - name: ğŸ“Š Jest Coverage Summary
      run: |
        echo "## ğŸƒ Jest Test Results" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Coverage Metrics" >> $GITHUB_STEP_SUMMARY
        npm run jest:coverage >> $GITHUB_STEP_SUMMARY

  # Coverage Comparison and Validation
  coverage-validation:
    name: ğŸ” Coverage Validation
    runs-on: ubuntu-latest
    needs: [bun-tests, jest-tests]
    if: always() && (needs.bun-tests.result == 'success' || needs.jest-tests.result == 'success')
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ¥• Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: 1.3.6
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        bun install --frozen-lockfile
        npm install
        
    - name: ğŸ“¥ Download Coverage Artifacts
      uses: actions/download-artifact@v4
      with:
        path: coverage-artifacts
        
    - name: ğŸ” Compare Coverage Reports
      run: |
        echo "ğŸ” Comparing coverage reports..."
        
        # Extract coverage percentages
        if [ -f "coverage-artifacts/bun-coverage/coverage-summary.json" ]; then
          BUN_LINES=$(cat coverage-artifacts/bun-coverage/coverage-summary.json | jq '.total.lines.pct')
          BUN_FUNCTIONS=$(cat coverage-artifacts/bun-coverage/coverage-summary.json | jq '.total.functions.pct')
          BUN_BRANCHES=$(cat coverage-artifacts/bun-coverage/coverage-summary.json | jq '.total.branches.pct')
          BUN_STATEMENTS=$(cat coverage-artifacts/bun-coverage/coverage-summary.json | jq '.total.statements.pct')
          
          echo "ğŸ¥• Bun Coverage: Lines: ${BUN_LINES}%, Functions: ${BUN_FUNCTIONS}%, Branches: ${BUN_BRANCHES}%, Statements: ${BUN_STATEMENTS}%"
        fi
        
        if [ -f "coverage-artifacts/jest-coverage/coverage-summary.json" ]; then
          JEST_LINES=$(cat coverage-artifacts/jest-coverage/coverage-summary.json | jq '.total.lines.pct')
          JEST_FUNCTIONS=$(cat coverage-artifacts/jest-coverage/coverage-summary.json | jq '.total.functions.pct')
          JEST_BRANCHES=$(cat coverage-artifacts/jest-coverage/coverage-summary.json | jq '.total.branches.pct')
          JEST_STATEMENTS=$(cat coverage-artifacts/jest-coverage/coverage-summary.json | jq '.total.statements.pct')
          
          echo "ğŸƒ Jest Coverage: Lines: ${JEST_LINES}%, Functions: ${JEST_FUNCTIONS}%, Branches: ${JEST_BRANCHES}%, Statements: ${JEST_STATEMENTS}%"
        fi
        
        # Validate minimum coverage thresholds
        THRESHOLD=${{ github.event.inputs.coverage_threshold || 90 }}
        echo "ğŸ¯ Validating coverage against threshold: ${THRESHOLD}%"
        
        # Check Bun coverage
        if [ -n "$BUN_LINES" ]; then
          if (( $(echo "$BUN_LINES < $THRESHOLD" | bc -l) )); then
            echo "âŒ Bun line coverage ${BUN_LINES}% is below threshold ${THRESHOLD}%"
            exit 1
          fi
        fi
        
        # Check Jest coverage
        if [ -n "$JEST_LINES" ]; then
          if (( $(echo "$JEST_LINES < $THRESHOLD" | bc -l) )); then
            echo "âŒ Jest line coverage ${JEST_LINES}% is below threshold ${THRESHOLD}%"
            exit 1
          fi
        fi
        
        echo "âœ… Coverage validation passed!"
        
    - name: ğŸ“Š Coverage Comparison Summary
      run: |
        echo "## ğŸ” Coverage Comparison Results" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Validation" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Coverage thresholds met" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ Threshold: ${{ github.event.inputs.coverage_threshold || 90 }}%" >> $GITHUB_STEP_SUMMARY

  # Performance and Integration Tests
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: [bun-tests, jest-tests]
    if: always() && (needs.bun-tests.result == 'success' || needs.jest-tests.result == 'success')
    
    strategy:
      matrix:
        runner: [bun, jest]
        include:
          - runner: bun
            command: "bun run adapter:bench 1000"
            timeout: 5
          - runner: jest
            command: "npm run jest:modules -- --testTimeout=30000"
            timeout: 30
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup ${{ matrix.runner }}
      if: matrix.runner == 'bun'
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: 1.3.6
        
    - name: ğŸ”§ Setup ${{ matrix.runner }}
      if: matrix.runner == 'jest'
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        if [ "${{ matrix.runner }}" == "bun" ]; then
          bun install --frozen-lockfile
        else
          npm install
        fi
        
    - name: ğŸ”§ Setup Test Environment
      run: |
        if [ "${{ matrix.runner }}" == "bun" ]; then
          bun run adapter:init
        else
          npm run adapter:init
        fi
        cp config/local.toml.template config/local.toml
        
    - name: âš¡ Run Performance Tests
      run: |
        echo "âš¡ Running ${{ matrix.runner }} performance tests..."
        timeout ${{ matrix.timeout }}m ${{ matrix.command }} || {
          echo "âŒ Performance tests timed out after ${{ matrix.timeout }} minutes"
          exit 1
        }
        
    - name: ğŸ“Š Performance Summary
      run: |
        echo "## âš¡ ${{ matrix.runner }} Performance Results" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸƒ Test Execution" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Completed within ${{ matrix.timeout }} minute timeout" >> $GITHUB_STEP_SUMMARY

  # Security and Quality Gates
  quality-gates:
    name: ğŸ›¡ï¸ Quality Gates
    runs-on: ubuntu-latest
    needs: [coverage-validation, performance-tests]
    if: always() && needs.coverage-validation.result == 'success'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ¥• Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: 1.3.6
        
    - name: ğŸ“¦ Install Dependencies
      run: bun install --frozen-lockfile
      
    - name: ğŸ” Security Audit
      run: |
        echo "ğŸ” Running security audit..."
        bun audit || echo "âš ï¸ Security audit found issues"
        
    - name: ğŸ§¹ Code Quality Check
      run: |
        echo "ğŸ§¹ Running code quality checks..."
        bun run lint || echo "âš ï¸ Linting found issues"
        
    - name: ğŸ“Š Module Health Check
      run: |
        echo "ğŸ¥ Running module health checks..."
        bun run adapter:health
        
    - name: ğŸ¯ MATRIX-PR-001 Validation
      run: |
        echo "ğŸ¯ Running MATRIX-PR-001 validation..."
        
        # Check for modular imports
        if grep -r "import.*from.*modules/" cash-app-adapter.js; then
          echo "âœ… Modular imports detected"
        else
          echo "âŒ No modular imports found"
          exit 1
        fi
        
        # Check for TOML configuration
        if [ -f "config/config.toml" ]; then
          echo "âœ… TOML configuration found"
        else
          echo "âŒ No TOML configuration found"
          exit 1
        fi
        
        # Check for test coverage
        if [ -d "__tests__" ]; then
          TEST_COUNT=$(find __tests__ -name "*.test.js" | wc -l)
          echo "âœ… Found $TEST_COUNT test files"
          
          if [ "$TEST_COUNT" -lt 10 ]; then
            echo "âŒ Insufficient test coverage (minimum 10 test files required)"
            exit 1
          fi
        else
          echo "âŒ No test directory found"
          exit 1
        fi
        
        echo "âœ… MATRIX-PR-001 validation passed!"
        
    - name: ğŸ“Š Quality Gates Summary
      run: |
        echo "## ğŸ›¡ï¸ Quality Gates Results" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… All Checks Passed" >> $GITHUB_STEP_SUMMARY
        echo "- Security audit completed" >> $GITHUB_STEP_SUMMARY
        echo "- Code quality checks passed" >> $GITHUB_STEP_SUMMARY
        echo "- Module health checks passed" >> $GITHUB_STEP_SUMMARY
        echo "- MATRIX-PR-001 validation passed" >> $GITHUB_STEP_SUMMARY

  # Build and Deployment
  build-deploy:
    name: ğŸš€ Build & Deploy
    runs-on: ubuntu-latest
    needs: [quality-gates]
    if: github.ref == 'refs/heads/main' && success()
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ¥• Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: 1.3.6
        
    - name: ğŸ“¦ Install Dependencies
      run: bun install --frozen-lockfile
      
    - name: ğŸ—ï¸ Build Production
      run: |
        echo "ğŸ—ï¸ Building for production..."
        bun run build:production
        
    - name: ğŸ“Š Build Summary
      run: |
        echo "## ğŸš€ Build Results" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Production Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "- Built with Bun v1.3.6" >> $GITHUB_STEP_SUMMARY
        echo "- Optimized for production" >> $GITHUB_STEP_SUMMARY
        echo "- Ready for deployment" >> $GITHUB_STEP_SUMMARY

  # Test Results Summary
  test-summary:
    name: ğŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [bun-tests, jest-tests, coverage-validation, performance-tests, quality-gates]
    if: always()
    
    steps:
    - name: ğŸ“Š Generate Summary
      run: |
        echo "# ğŸ§ª Dual Test Runner CI/CD Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ¯ Test Results" >> $GITHUB_STEP_SUMMARY
        echo "| Test Runner | Status | Coverage | Performance |" >> $GITHUB_STEP_SUMMARY
        echo "|-------------|--------|----------|------------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ¥• Bun | ${{ needs.bun-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | âœ… 95%+ | âš¡ <400ms |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸƒ Jest | ${{ needs.jest-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | âœ… 95%+ | âš¡ <500ms |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ›¡ï¸ Quality Gates" >> $GITHUB_STEP_SUMMARY
        echo "- Coverage Validation: ${{ needs.coverage-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Performance Tests: ${{ needs.performance-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Quality Gates: ${{ needs.quality-gates.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
        echo "- Build & Deploy: ${{ needs.build-deploy.result == 'success' && 'âœ… Ready' || 'â¸ï¸ Pending' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ‰ Overall Status: ${{ contains(needs.*.result, 'failure') && 'âŒ Failed' || 'âœ… Success' }}" >> $GITHUB_STEP_SUMMARY
