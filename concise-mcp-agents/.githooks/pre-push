#!/bin/bash

echo "üöÄ PRE-PUSH SECURITY VALIDATION v2.11"
echo "====================================="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

FAILED_CHECKS=0

# Run full security enforcement
echo "üîí Running security enforcement..."
if command -v bun &> /dev/null; then
    bun run gov:security >/dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ Security enforcement passed${NC}"
    else
        echo -e "${RED}‚ùå Security violations detected${NC}"
        echo "   Run: bun gov:security"
        FAILED_CHECKS=$((FAILED_CHECKS + 1))
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  Bun not found - skipping security enforcement${NC}"
fi

# Run access control enforcement
echo ""
echo "üîê Running access control enforcement..."
if command -v bun &> /dev/null; then
    bun run gov:access >/dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ Access control enforcement passed${NC}"
    else
        echo -e "${RED}‚ùå Access control violations detected${NC}"
        echo "   Run: bun gov:access"
        FAILED_CHECKS=$((FAILED_CHECKS + 1))
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  Bun not found - skipping access enforcement${NC}"
fi

# Check for large files
echo ""
echo "üìÅ Checking for large files..."
LARGE_FILES=$(find . -type f -size +50M -not -path "./.git/*" -not -path "./node_modules/*" 2>/dev/null)
if [ -n "$LARGE_FILES" ]; then
    echo -e "${RED}‚ùå Large files detected:${NC}"
    echo "$LARGE_FILES"
    FAILED_CHECKS=$((FAILED_CHECKS + 1))
else
    echo -e "${GREEN}‚úÖ No large files found${NC}"
fi

# Check for sensitive data in committed files
echo ""
echo "üîç Scanning for sensitive data patterns..."
SENSITIVE_PATTERNS=(
    "password.*="
    "secret.*="
    "key.*="
    "token.*="
    "api_key.*="
    "private_key"
    "BEGIN.*PRIVATE"
)

for pattern in "${SENSITIVE_PATTERNS[@]}"; do
    MATCHES=$(git grep -l "$pattern" -- . ":(exclude).git/*" ":(exclude)node_modules/*" ":(exclude)*.log" 2>/dev/null || true)
    if [ -n "$MATCHES" ]; then
        echo -e "${RED}‚ùå Potential sensitive data found with pattern '$pattern':${NC}"
        echo "$MATCHES"
        FAILED_CHECKS=$((FAILED_CHECKS + 1))
    fi
done

if [ $FAILED_CHECKS -eq 0 ]; then
    echo -e "${GREEN}‚úÖ No sensitive patterns detected${NC}"
fi

# Verify audit log integrity
echo ""
echo "üìã Checking audit log integrity..."
if [ -d "logs/audit" ]; then
    TODAY=$(date +%Y-%m-%d)
    AUDIT_FILE="logs/audit/${TODAY}.audit.json"
    HASH_FILE="logs/audit/${TODAY}.audit.sha256"

    if [ -f "$AUDIT_FILE" ] && [ -f "$HASH_FILE" ]; then
        # Run audit integrity check
        if command -v bun &> /dev/null; then
            bun run secrets-manager.ts audit-verify "$TODAY" >/dev/null 2>&1
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}‚úÖ Audit log integrity verified${NC}"
            else
                echo -e "${RED}‚ùå Audit log integrity compromised${NC}"
                FAILED_CHECKS=$((FAILED_CHECKS + 1))
            fi
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  No audit logs for today${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  No audit directory found${NC}"
fi

# Final summary
echo ""
echo "üìä PRE-PUSH VALIDATION SUMMARY"
echo "=============================="

if [ $FAILED_CHECKS -eq 0 ]; then
    echo -e "${GREEN}üéâ All pre-push checks passed! Push authorized.${NC}"
    exit 0
else
    echo -e "${RED}üö® $FAILED_CHECKS validation check(s) failed. Push blocked.${NC}"
    echo ""
    echo "üîß To bypass this check (for emergencies only):"
    echo "   git push --no-verify"
    echo ""
    echo "‚ö†Ô∏è  WARNING: Bypassing security checks may compromise system integrity"
    exit 1
fi
