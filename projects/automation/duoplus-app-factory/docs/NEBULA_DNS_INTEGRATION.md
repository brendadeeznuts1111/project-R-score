# üß¨ Nebula-Flow‚Ñ¢ DNS Cache Integration Guide\n\nOptimize DNS performance for Lightning Network integration and DuoPlus Cloud Phone API connectivity.\n\n## Quick Start\n\n```bash\n# Monitor DNS cache in real-time\nbun nebula-dns-live.ts\n\n# With custom TTL (5 seconds for frequently changing DNS)\nBUN_CONFIG_DNS_TIME_TO_LIVE_SECONDS=5 bun nebula-dns-live.ts\n\n# With longer TTL (60 seconds for stable infrastructure)\nBUN_CONFIG_DNS_TIME_TO_LIVE_SECONDS=60 bun nebula-dns-live.ts\n```\n\n## Nebula-Flow‚Ñ¢ API Endpoints to Prefetch\n\n### Lightning Network (LND)\n```html\n<!-- DNS prefetch for LND gRPC gateway -->\n<link rel=\"dns-prefetch\" href=\"//lnd.duoplus.local\">\n<link rel=\"dns-prefetch\" href=\"//lnd-api.duoplus.local\">\n<link rel=\"preconnect\" href=\"//lnd.duoplus.local\">\n```\n\n### DuoPlus Cloud Phone API\n```html\n<!-- DNS prefetch for production API -->\n<link rel=\"dns-prefetch\" href=\"//openapi.duoplus.net\">\n<link rel=\"dns-prefetch\" href=\"//api.duoplus.net\">\n<link rel=\"preconnect\" href=\"//openapi.duoplus.net\">\n```\n\n### Content Management System\n```html\n<!-- DNS prefetch for CMS and storage -->\n<link rel=\"dns-prefetch\" href=\"//cms.duoplus.local\">\n<link rel=\"dns-prefetch\" href=\"//r2.duoplus.local\">\n<link rel=\"preconnect\" href=\"//cms.duoplus.local\">\n```\n\n### Analytics & Monitoring\n```html\n<!-- DNS prefetch for telemetry -->\n<link rel=\"dns-prefetch\" href=\"//analytics.duoplus.local\">\n<link rel=\"dns-prefetch\" href=\"//metrics.duoplus.local\">\n```\n\n## Bun Server Configuration\n\n### Enable DNS Prefetch in web-app/server.js\n\n```javascript\nconst server = Bun.serve({\n  hostname: \"0.0.0.0\",\n  port: 3000,\n  fetch(req) {\n    const url = new URL(req.url);\n\n    // Serve HTML with DNS prefetch hints\n    if (url.pathname === \"/\") {\n      return new Response(`\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <!-- DNS Prefetch for Nebula-Flow‚Ñ¢ APIs -->\n          <link rel=\"dns-prefetch\" href=\"//openapi.duoplus.net\">\n          <link rel=\"dns-prefetch\" href=\"//lnd.duoplus.local\">\n          <link rel=\"dns-prefetch\" href=\"//cms.duoplus.local\">\n          <link rel=\"preconnect\" href=\"//openapi.duoplus.net\">\n          <link rel=\"preconnect\" href=\"//lnd.duoplus.local\">\n          <title>Nebula-Flow‚Ñ¢ Dashboard</title>\n        </head>\n        <body>\n          <!-- Dashboard content -->\n        </body>\n        </html>\n      `, {\n        headers: { \"content-type\": \"text/html\" }\n      });\n    }\n  }\n});\n```\n\n## Performance Targets\n\n### Hit Ratio Interpretation\n\n| Hit Ratio | Status | Action |\n|-----------|--------|--------|\n| ‚â• 90% | ‚úÖ Excellent | Prefetch strategy working well |\n| 70-89% | ‚ö†Ô∏è Good | Add more prefetch hints |\n| < 70% | ‚ùå Needs Work | Implement comprehensive prefetch |\n\n### Cache Size Management\n\n- **< 50 entries**: Plenty of room, cache is underutilized\n- **50-200 entries**: Optimal range for most applications\n- **> 200 entries**: Consider lowering TTL or reducing unique domains\n- **255 entries**: Cache is full, entries being evicted\n\n## Optimization Strategies\n\n### 1. Connection Pooling for LND\n\n```typescript\nclass LNDConnectionPool {\n  private pool = new Map<string, any>();\n\n  async getConnection(endpoint: string) {\n    if (this.pool.has(endpoint)) {\n      return this.pool.get(endpoint);\n    }\n    const conn = await this.createConnection(endpoint);\n    this.pool.set(endpoint, conn);\n    return conn;\n  }\n\n  private async createConnection(endpoint: string) {\n    // Create gRPC connection to LND\n    return await fetch(`https://${endpoint}/v1/getinfo`);\n  }\n}\n```\n\n### 2. Batch API Requests\n\n```typescript\n// Instead of sequential requests\nconst [lndInfo, phoneData, cmsContent] = await Promise.all([\n  fetch(\"https://lnd.duoplus.local/v1/getinfo\"),\n  fetch(\"https://openapi.duoplus.net/v1/devices\"),\n  fetch(\"https://cms.duoplus.local/api/content\"),\n]);\n```\n\n### 3. DNS Prefetch Timing\n\n```typescript\n// Prefetch critical domains on app startup\nasync function prefetchCriticalDomains() {\n  const domains = [\n    \"openapi.duoplus.net\",\n    \"lnd.duoplus.local\",\n    \"cms.duoplus.local\",\n  ];\n\n  // Trigger DNS lookups without waiting for responses\n  domains.forEach(domain => {\n    fetch(`https://${domain}/health`, { method: \"HEAD\" })\n      .catch(() => {}); // Ignore errors, just warm the cache\n  });\n}\n```\n\n## Monitoring Dashboard\n\nRun the Nebula-Flow‚Ñ¢ DNS monitor alongside your app:\n\n```bash\n# Terminal 1: Start Nebula-Flow‚Ñ¢ API\nbun web-app/server.js\n\n# Terminal 2: Monitor DNS cache\nbun nebula-dns-live.ts\n\n# Terminal 3: Generate test traffic (optional)\nbun bun-dns-demo-app.ts\ncurl http://localhost:3003/auto\n```\n\n## Expected Performance\n\n### Initial Startup (0-30 seconds)\n- Hit ratio: 0% ‚Üí 90%\n- Cache fills with first lookups\n- Sparkline shows rapid climb\n\n### Steady State (30+ seconds)\n- Hit ratio: 90%+ (stable)\n- Cache hits dominate\n- Sparkline shows flat line at top\n\n### After TTL Expiry\n- Hit ratio: Dips temporarily\n- Recovers quickly with new lookups\n- Sparkline shows sawtooth pattern\n\n## Troubleshooting\n\n### Low Hit Ratio\n1. Check if DNS prefetch hints are in HTML\n2. Verify domains are correct\n3. Increase TTL if domains are stable\n4. Check for DNS errors in monitor\n\n### High Error Count\n1. Verify domain names are resolvable\n2. Check network connectivity\n3. Investigate failed hosts (they're evicted)\n4. Review DNS configuration\n\n### Cache Size Issues\n1. Lower TTL to evict stale entries\n2. Reduce number of unique domains\n3. Use connection pooling to reuse connections\n4. Batch requests to minimize lookups\n\n## Integration with Nebula-Flow‚Ñ¢ Components\n\n### Lightning Network (LND)\n- Prefetch: `lnd.duoplus.local`\n- Preconnect: Critical for payment processing\n- TTL: 60 seconds (stable infrastructure)\n\n### DuoPlus Cloud Phone API\n- Prefetch: `openapi.duoplus.net`\n- Preconnect: Critical for device management\n- TTL: 30 seconds (may change)\n\n### Content Management System\n- Prefetch: `cms.duoplus.local`\n- Preconnect: For content delivery\n- TTL: 60 seconds (stable)\n\n### Analytics & Monitoring\n- Prefetch: `analytics.duoplus.local`\n- Preconnect: Optional (non-critical)\n- TTL: 30 seconds\n\n## See Also\n\n- [nebula-dns-live.ts](./nebula-dns-live.ts) - Nebula-branded monitor\n- [BUN_DNS_CACHE_GUIDE.md](./BUN_DNS_CACHE_GUIDE.md) - Detailed DNS guide\n- [bun-dns-demo-app.ts](./bun-dns-demo-app.ts) - Demo app for testing\n- [web-app/server.js](./web-app/server.js) - Main Nebula-Flow‚Ñ¢ server\n"
