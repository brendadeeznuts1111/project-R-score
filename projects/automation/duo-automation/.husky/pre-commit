#!/usr/bin/env bash
# .husky/pre-commit
# [DUOPLUS][HOOK][ENFORCE][CRITICAL][#REF:HOOK-PRECOMMIT][BUN:6.1-NATIVE]

echo "ğŸš« Enforcing NO PURPLE AI SLOP policy..."

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# E-027: Toolchain Purity Check - Prevent npm in Bun ecosystem
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ğŸ”§ [E-027] Checking toolchain purity..."

# Check for npm publish in package.json scripts (excluding prepublishOnly which is a lifecycle hook)
if grep -E '"(package|publish)".*npm (publish|pack)' package.json 2>/dev/null; then
  echo "âŒ [E-027] Found 'npm publish/pack' in Bun-native ecosystem"
  echo "â†’ Use 'bun publish' or 'bun pm pack' instead"
  echo "â†’ Docs: https://bun.sh/docs/cli/publish"
  exit 1
fi

# Check for npm commands in shell scripts (excluding node_modules)
if grep -r "npm publish\|npm pack" . --include="*.sh" --exclude-dir=node_modules 2>/dev/null; then
  echo "âŒ [E-027] Found 'npm publish/pack' in shell scripts"
  echo "â†’ Use 'bun publish' or 'bun pm pack' instead"
  exit 1
fi

echo "âœ… [E-027] Toolchain purity verified (Bun-native)"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# E-028: Frozen Lockfile Check - Ensure bun.lockb exists
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ğŸ”’ [E-028] Checking frozen lockfile..."

if [ ! -f "bun.lockb" ]; then
  echo "âŒ [E-028] bun.lockb not found"
  echo "â†’ Run 'bun install' to generate lockfile"
  echo "â†’ CI requires --frozen-lockfile for reproducible builds"
  exit 1
fi

echo "âœ… [E-028] Lockfile exists (bun.lockb)"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Run DuoPlus Tag Enforcement v6.1
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "ğŸ”’ Running DuoPlus Tag Enforcement..."
ENFORCEMENT_STAGE=pre-commit bun run scripts/git/tag-enforcer-v6.ts

echo "âœ… Purple-free repo and tag compliance verified"
