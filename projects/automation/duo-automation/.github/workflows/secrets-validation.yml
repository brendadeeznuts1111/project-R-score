name: Secrets Scoping Validation
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  secrets-scoping-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        bun-version: ['1.3.6']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ matrix.bun-version }}
          
      - name: Install dependencies
        run: bun install
        
      - name: Run secrets scoping tests
        run: bun tests/secrets-scoping.test.ts
        
      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: secrets-test-results-${{ matrix.os }}
          path: reports/secrets-scoping-test-results.json
          
      - name: Run setup-check validation
        run: bun bench/scripts/setup-check.ts --json > setup-results.json
        
      - name: Validate agent output organization
        run: |
          if [ -f "agents/outputs/agent_*.json" ]; then
            echo "‚úÖ Agent outputs properly organized"
          else
            echo "‚ùå Agent outputs not found in expected location"
            exit 1
          fi
          
      - name: Security validation
        run: |
          # Ensure no secrets in root directory
          if ls agent_*.json 2>/dev/null; then
            echo "‚ùå Found agent files in root directory"
            exit 1
          fi
          echo "‚úÖ No secrets in root directory - proper scoping maintained"

  performance-benchmark:
    runs-on: ubuntu-latest
    needs: secrets-scoping-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: '1.3.6'
          
      - name: Run performance benchmarks
        run: bun bench/scripts/setup-check.ts --verbose
        
      - name: Generate performance report
        run: |
          echo "## Performance Summary" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat reports/setup-results.json | jq '.summary' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  security-audit:
    runs-on: ubuntu-latest
    needs: secrets-scoping-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: '1.3.6'
          
      - name: Security audit
        run: |
          echo "üîí Running security audit for CRED_PERSIST_ENTERPRISE"
          bun tests/secrets-scoping.test.ts
          
      - name: Verify no hardcoded secrets
        run: |
          # Check for potential hardcoded secrets
          if grep -r "R2_.*=" src/ --exclude-dir=node_modules | grep -v "import\|export\|Bun.env"; then
            echo "‚ùå Potential hardcoded secrets found"
            exit 1
          fi
          echo "‚úÖ No hardcoded secrets detected"
