name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  BUN_CONFIG_DNS_TIME_TO_LIVE_SECONDS: 5

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: 1.3.0        # pinned to the version we showcase

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Run tests
      run: bun test

    - name: Run Bun 1.3 DX showcase tests
      run: bun test src/shared/bun-dx-showcase.test.ts

    - name: Start server and test DX showcase
      run: |
        bun run src/entry-point/cli/security-arena.bun.ts &
        SERVER_PID=$!
        sleep 5

        # Test that the showcase loads
        curl -f http://localhost:3000/ | grep -q "Bun 1.3 Advanced Testing Lab" || exit 1

        # Test API endpoints
        curl -f http://localhost:3000/api/health | grep -q '"status":"healthy"' || exit 1

        # Kill server
        kill $SERVER_PID || true

    - name: Build SPA Lab
      run: bun run build:spa-lab

    - name: Security audit
      run: bun audit