# Hyper-Bun v1.3.3: Centralized Logging & Observability Subsystem

**Version**: 16.0.0.0.0.0.0  
**Feature**: Centralized Logging & Observability Subsystem  
**Status**: ✅ **IMPLEMENTED**  
**Priority**: P0 Critical Feature  
**Date**: 2024-12-XX  
**Last Updated**: 2024-12-XX

---

## **Overview**

This subsystem provides standardized, clean log formatting optimized for both human readability and machine parsing. All log messages follow a consistent pipe-delimited format, making them immediately parseable by log aggregation tools (ELK stack, Splunk, etc.) while remaining readable in terminal output.

**Key Principle**: Clean, structured logs with machine-readable codes enable rapid incident response and debugging through `ripgrep` discoverability.

---

## **Quick Reference: Ripgrep Commands**

### **Find Log Code Definitions**

```bash
# Find log code definition in documentation
rg "HBCB-002" docs/logging/log-codes.md

# Find all log codes for a subsystem
rg "HBCB-" docs/logging/log-codes.md
```

### **Find Log Code Usage**

```bash
# Find all source code locations where a log code is emitted
rg "HBCB-002" src/

# Find log code in specific module
rg "HBCB-002" src/utils/production-circuit-breaker.ts
```

### **Search Log Files**

```bash
# Find all log entries with a specific code
rg "HBCB-002" /var/log/hyper-bun/*.log

# Find all errors for a specific bookmaker
rg "HBCB-002.*draftkings" /var/log/hyper-bun/*.log
```

---

## **16.1.0.0.0.0.0 Standardized Clean Log Format & Structure**

### **16.1.1.0.0.0.0 Log Line Structure**

All log messages adhere to a concise, pipe-delimited format:

```
YYYY-MM-DD HH:MM:SS.ms | LEVEL | CODE | SOURCE | MESSAGE
```

**Field Descriptions**:

- **`YYYY-MM-DD HH:MM:SS.ms`**: High-precision UTC timestamp (millisecond precision)
- **`LEVEL`**: Log severity level (uppercase): `DEBUG`, `INFO`, `WARN`, `ERROR`, `FATAL`
- **`CODE`**: Unique machine-readable log code (e.g., `HBCB-001`). Use `N/A` if no specific code applies
- **`SOURCE`**: Module or class responsible for emitting the log (e.g., `ProductionCircuitBreaker`)
- **`MESSAGE`**: Concise, human-readable description of the event

**Example Output**:

```
2025-12-07 09:35:30.000 | INFO | HBCB-001 | ProductionCircuitBreaker | Circuit breaker recovered for draftkings. Latency: 150ms. Failure count reset to 0.
2025-12-07 09:35:31.250 | ERROR | HBCB-002 | ProductionCircuitBreaker | Circuit breaker tripped for fanduel after 10.0 failures. Manual intervention required. Error: Network timeout
```

### **16.1.1.1.0.0.0 Bun-Native Implementation**

**Location**: `src/utils/standardized-logger.ts`

The logger leverages Bun's fast I/O:
- `console.log` for stdout (with optional ANSI colors)
- `Bun.write()` for structured file logs (non-blocking, async)
- High-precision UTC timestamps using native `Date` API

**Performance**: Direct stdout writes bypass console wrapper overhead, providing optimal performance for high-frequency logging.

### **16.1.1.1.1.0.0 Example: INFO Logging**

**Test Formula**:
```typescript
import { createStandardizedLogger } from "./utils/standardized-logger";

const logger = createStandardizedLogger("MarketOfferingService");
logger.info("HBMO-001", "Successfully initialized bookmaker configuration.");
```

**Expected Output**:
```
2025-12-07 09:35:30.000 | INFO | HBMO-001 | MarketOfferingService | Successfully initialized bookmaker configuration.
```

### **16.1.1.1.2.0.0 Example: ERROR Logging**

**Test Formula**:
```typescript
const logger = createStandardizedLogger("MarketOfferingService");
logger.error(
  "HBMO-002",
  "Failed to retrieve required server configuration.",
  new Error("Network timeout")
);
```

**Expected Output**:
```
2025-12-07 09:35:30.000 | ERROR | HBMO-002 | MarketOfferingService | Failed to retrieve required server configuration. Error: Network timeout
  Stack: Error: Network timeout
    at ...
```

---

## **16.2.0.0.0.0.0 Defined Log Levels & Usage**

### **16.2.1.0.0.0.0 DEBUG**

**Purpose**: Detailed info, verbose for development.

**When to Use**:
- Function entry/exit points
- Variable state dumps
- Detailed algorithm steps
- Development-only diagnostics

**Example**:
```typescript
logger.debug("HBCB-008", "Checking circuit breaker state", { bookmaker, failures: state.failureCount });
```

### **16.2.2.0.0.0.0 INFO**

**Purpose**: General runtime information, state changes, successful operations.

**When to Use**:
- Successful initialization
- State transitions (circuit breaker recovery)
- Successful API calls
- Configuration changes

**Example**:
```typescript
logger.info("HBCB-001", "Circuit breaker recovered for draftkings");
```

### **16.2.3.0.0.0.0 WARN**

**Purpose**: Potentially problematic situations, non-critical errors, deviations from best practice.

**When to Use**:
- Circuit breaker rejections (expected behavior)
- Load shedding (system protection)
- Deprecated API usage
- Performance degradation warnings

**Example**:
```typescript
logger.warn("HBCB-003", "Request rejected: circuit tripped");
```

### **16.2.4.0.0.0.0 ERROR**

**Purpose**: Critical runtime errors, failures in core functionality, unhandled exceptions.

**When to Use**:
- Circuit breaker trips
- API failures
- Configuration errors
- Data corruption detected

**Example**:
```typescript
logger.error("HBCB-002", "Circuit breaker tripped", new Error("API timeout"));
```

### **16.2.5.0.0.0.0 FATAL**

**Purpose**: Imminent application crash or irrecoverable state. Triggers emergency shutdown.

**When to Use**:
- Database corruption
- Critical resource exhaustion
- Security breach detected
- Unrecoverable system state

**Example**:
```typescript
logger.fatal("HBSEC-001", "Critical security violation detected", securityError);
```

---

## **16.3.0.0.0.0.0 Log Code Registry & Discoverability**

### **16.3.1.0.0.0.0 Log Code Naming Convention**

All structured log codes follow: `HB<SUBSYSTEM>-<NUMBER>`

- **`HB`**: Hyper-Bun prefix
- **`<SUBSYSTEM>`**: 3-4 letter abbreviation (e.g., `CB` = Circuit Breaker, `MO` = Market Offerings)
- **`<NUMBER>`**: 3-digit incrementing ID unique within subsystem

**Examples**:
- `HBCB-001` = Hyper-Bun Circuit Breaker - 001
- `HBMO-001` = Hyper-Bun Market Offerings - 001
- `HBSEC-010` = Hyper-Bun Security - 010

### **16.3.2.0.0.0.0 Centralized Log Code Documentation**

**Location**: `docs/logging/log-codes.md`

Each log code entry includes:
- **CODE**: Unique log code
- **Expected Level**: Typical log level
- **Summary**: Brief description
- **Context**: When this code is emitted
- **Common Causes**: Frequent root causes
- **Resolution Steps**: Actionable debugging guidance
- **Cross-Reference**: Links to relevant granular section numbers

### **16.3.3.0.0.0.0 Ripgrep Log Code Discoverability**

**Workflow**: From log message → full documentation → resolution

1. **Observe log**: `2025-12-07 09:35:30.000 | ERROR | HBCB-002 | ProductionCircuitBreaker | Circuit breaker tripped...`
2. **Extract code**: `HBCB-002`
3. **Find definition**: `rg "HBCB-002" docs/logging/log-codes.md`
4. **Find usages**: `rg "HBCB-002" src/`
5. **Find in logs**: `rg "HBCB-002" /var/log/hyper-bun/*.log`

**Impact**: Enables immediate pivot from observed log message to full documentation, common causes, and resolution steps.

---

## **Usage Examples**

### **Creating a Logger**

```typescript
import { createStandardizedLogger } from "./utils/standardized-logger";

// Create logger for a specific module
const logger = createStandardizedLogger("MarketOfferingService");

// Use pre-configured loggers
import { circuitBreakerLogger } from "./utils/standardized-logger";
circuitBreakerLogger.info("HBCB-001", "Circuit breaker recovered");
```

### **Logging with Context**

```typescript
// Simple info log
logger.info("HBMO-001", "Successfully initialized bookmaker configuration.");

// Error with exception
logger.error("HBMO-002", "Failed to retrieve server configuration", new Error("Network timeout"));

// Warning with data
logger.warn("HBCB-004", "Load shedding triggered", { systemLoad: 0.95, operationLoad: 200 });
```

### **Configuration**

```typescript
// Create logger with custom config
const logger = createStandardizedLogger("MyModule", {
  minLevel: StandardizedLogLevel.WARN, // Only log WARN and above
  enableColors: true, // Enable ANSI colors
  filePath: "./logs/my-module.log", // Also write to file
});
```

---

## **Integration with Circuit Breaker**

The Production Circuit Breaker subsystem (12.0.0.0.0.0.0) uses standardized logging:

- **HBCB-001**: Circuit breaker recovery
- **HBCB-002**: Circuit breaker trip
- **HBCB-003**: Request rejected (tripped)
- **HBCB-004**: Load shedding
- **HBCB-005**: Manual reset
- **HBCB-006**: Manual trip
- **HBCB-007**: Alert callback failure

See `docs/logging/log-codes.md` for complete documentation.

---

## **Migration Guide**

### **From Old Logger Format**

**Before**:
```typescript
logger.error("[CIRCUIT_BREAKER] TRIPPED: draftkings after 10 failures");
```

**After**:
```typescript
import { circuitBreakerLogger } from "./utils/standardized-logger";
circuitBreakerLogger.error(
  "HBCB-002",
  "Circuit breaker tripped for draftkings after 10 failures",
  error
);
```

### **Benefits**

1. **Machine Parseable**: Pipe-delimited format works with standard log parsers
2. **Ripgrep Discoverable**: Log codes enable instant code → documentation lookup
3. **Consistent**: All logs follow same format across entire codebase
4. **Actionable**: Each code links to resolution steps

---

## **Related Documentation**

- `docs/logging/log-codes.md` - Complete log code registry
- `src/utils/standardized-logger.ts` - Implementation
- `docs/12.0.0.0.0.0.0-PRODUCTION-CIRCUIT-BREAKER-SUBSYSTEM.md` - Circuit breaker integration

---

## **Changelog**

- **16.0.0.0.0.0.0** (2024-12-XX): Initial centralized logging subsystem
  - Standardized pipe-delimited format
  - Log code registry
  - Bun-native implementation
  - Circuit breaker integration
