# Master Control Program (MCP) & Alerting Subsystem (4.0.0.0.0.0.0)

**Version**: 4.0.0.0.0.0.0  
**Feature**: Model Context Protocol Server & Alerting Infrastructure  
**Status**: ‚úÖ Integrated  
**Date**: 2024-12-06  
**Last Updated**: 2025-12-07 (Added 4.2.2.0.0.0.0 Multi-Layer Correlation Graph Documentation)

---

## Overview

The Master Control Program (MCP) & Alerting Subsystem provides AI-accessible tools and monitoring infrastructure for Hyper-Bun. It integrates with various subsystems including security, research, tooling, and frontend configuration to provide centralized control and observability.

### Key Components

- **MCP Server**: Model Context Protocol server for AI tool integration
- **MCP Tools**: Domain-specific tools for various subsystems
- **Alerting Infrastructure**: Health monitoring and alerting capabilities
- **Metrics Integration**: Prometheus-compatible metrics export

---

## 4.1.0.0.0.0.0: Frontend Configuration & Policy Management

The Master Control Program (MCP) serves as the operational heart of Hyper-Bun, orchestrating various subsystems, managing alerts, and providing critical internal dashboards. Within this subsystem, the management of frontend policies is crucial to ensure that operators and analysts interact with secure, feature-gated, and consistently configured interfaces.

This section defines the declarative manifests and associated policies that govern Hyper-Bun's web-based interfaces, including operational dashboards and the registry. This centralized approach ensures consistency, security, and auditability for how frontend elements are presented and managed.

### 4.1.1.0.0.0.0: `HyperBunUIPolicyManifest` Definition (YAML Structure)

#### 4.1.1.1.0.0.0: Purpose

A central, version-controlled YAML file (`config/ui-policy-manifest.yaml`) that explicitly declares the policies and configurations applied to Hyper-Bun's frontend HTML streams. This manifest serves as the primary input to the `UIPolicyManager` service (8.2.0.0.0.0.0) and subsequently influences `HTMLRewriter` transformations.

**Key Characteristics**:
- Human-readable YAML format (or JSON)
- Version-controlled alongside code
- Validated against schema
- Hot-reloadable (optional)
- Environment-aware (supports overrides)

#### 4.1.1.2.0.0.0: Placement Rationale

Placing this manifest under the MCP's domain underscores that frontend presentation and access (e.g., feature flags, RBAC for dashboards) are integral aspects of operational control and alerting management within Hyper-Bun. The MCP orchestrates how dashboards, alerts, and registry interfaces are rendered, making frontend policy management a core MCP responsibility.

#### 4.1.1.3.0.0.0: Example Manifest Structure

```yaml
# config/ui-policy-manifest.yaml - Example Manifest Structure

# 4.1.1.3.1.0.0: Manifest Metadata
metadata:
  version: "1.0.0"
  last_updated: "2025-12-07T09:00:00Z"
  description: "Centralized policies for Hyper-Bun Dashboard and Registry frontend."
  schema_version: "8.0.0.0.0.0.0"

# 4.1.1.3.2.0.0: Global UI Context Defaults
ui_context_defaults:
  apiBaseUrl: "AUTO_DETECT" # Indicates dynamic detection by the server (6.1.1.2.2.1.2.1)
  debugMode: false # Default state for HYPERBUN_UI_CONTEXT.debugMode (6.1.1.2.2.1.2.4)
  defaultUserRole: "guest"
  # currentTimestamp is always runtime-generated (6.1.1.2.2.1.2.5)

# 4.1.1.3.3.0.0: Feature Flag Management Policies
feature_flags:
  shadowGraph:
    enabled: true # Default state; can be overridden by env vars or health checks (6.1.1.2.2.1.2.2)
    description: "Interactive visualization of dark pool market graphs."
    dependencies: ["performanceMonitor.shadowGraphViz"] # Optional: links to health checks or service dependencies
    requires_env: null # Optional: "HYPERBUN_FEATURE_SHADOW_GRAPH=true"
  
  covertSteamAlerts:
    enabled: true
    description: "Real-time alerts for hidden market movements."
    dependencies: []
    requires_env: null
  
  debugPanel:
    enabled: false
    description: "Developer-only panel for UI debugging."
    requires_env: "HYPERBUN_DEBUG_UI=true" # Explicit environment variable override to enable
    dependencies: []
    # ... other feature flags as needed for Hyper-Bun's UI

# 4.1.1.3.4.0.0: HTMLRewriter Transformation Policies
html_rewriter_policies:
  # 4.1.1.3.4.1.0: Context Injection Policy (Core)
  inject_context_script: true # Controls 6.1.1.2.2.2.1.0: window.HYPERBUN_UI_CONTEXT Injection
  
  # Alternative: Advanced format (object) - for custom configuration
  # inject_context_script:
  #   enabled: true
  #   target: "body" # Injection target element (optional)
  #   position: "prepend" # prepend, append, before, after (optional)
  #   script_template: "window.HYPERBUN_UI_CONTEXT = {{CONTEXT_JSON}};" # (optional)

  # 4.1.1.3.4.2.0: Conditional Element Pruning Policies (data-feature)
  data_feature_pruning:
    enabled: true # Master switch for 6.1.1.2.2.2.2.0: Feature Flag-Based Conditional Rendering
    target_attribute: "data-feature"
    action: "remove_if_flag_false"
    preserve_content: false # If true, removes element but keeps inner content
    # Actual flags come from resolved feature_flags (4.1.1.3.3.0.0)

  # 4.1.1.3.4.3.0: Role-Based Access Control Pruning Policies (data-access)
  data_access_pruning:
    enabled: true # Master switch for 6.1.1.2.2.2.3.0: Role-Based Access Control Pruning
    target_attribute: "data-access"
    action: "remove_if_role_mismatch"
    allowed_roles: ["admin", "analyst", "viewer"] # Valid roles
    default_role: "guest" # Role used if not specified in request
    # Roles come from runtime detected ui_context_defaults.userRole (6.1.1.2.2.1.2.3)

  # 4.1.1.3.4.4.0: Dynamic Content Implantation Policies (data-server-timestamp)
  dynamic_content_implantation:
    enabled: true # Master switch for 6.1.1.2.2.2.4.0: Server-Authoritative Timestamp Implantation
    policies:
      - attribute: "data-server-timestamp"
        source_context_key: "currentTimestamp"
        format_function: "toLocaleString" # Specifies client-side or server-side (if implemented) formatting
        fallback: "Loading..." # Text shown if context unavailable

# 4.1.1.3.5.0.0: Security Policies (Optional)
security_policies:
  content_security_policy:
    enabled: true
    report_only: false
    directives:
      default_src: "'self'"
      script_src: "'self' 'unsafe-inline'"
      style_src: "'self' 'unsafe-inline'"
      img_src: "'self' data: https:"
  
  xss_protection:
    enabled: true
    mode: "block"
  
  context_validation:
    enabled: true
    validate_api_url: true
    validate_feature_flags: true
    validate_user_role: true

# 4.1.1.3.6.0.0: Performance Policies (Optional)
performance_policies:
  enable_metrics: true
  log_transformation_time: false
  log_size_reduction: false
  enable_caching: false
```

**Cross-References**:
- `6.1.1.2.2.1.2.1` - API Base URL detection mechanism
- `6.1.1.2.2.1.2.2` - Feature flags in UI context
- `6.1.1.2.2.1.2.3` - User role in UI context
- `6.1.1.2.2.1.2.4` - Debug mode in UI context
- `6.1.1.2.2.1.2.5` - Current timestamp in UI context
- `6.1.1.2.2.2.1.0` - Context injection mechanism
- `6.1.1.2.2.2.2.0` - Feature flag-based conditional rendering
- `6.1.1.2.2.2.3.0` - Role-based access control pruning
- `6.1.1.2.2.2.4.0` - Server-authoritative timestamp implantation

**See**: [Full Manifest Documentation](./8.0.0.0.0.0.0-FRONTEND-CONFIG-POLICY.md#810000000-hyperbunuipolicymanifest-definition) for complete schema details.

### 4.1.2.0.0.0.0: UIPolicyManager Service

**Location**: `src/services/ui-policy-manager.ts`

**Purpose**: A Bun-native service responsible for loading, parsing, validating, and applying the `HyperBunUIPolicyManifest`. It acts as the primary interface for other services (like `UIContextRewriter` and route handlers) to retrieve current UI policies.

**Core Functionality**:
- **4.1.2.1.0.0.0 Load & Parse Manifest**: Uses `Bun.file()` and `Bun.YAML.parse()` (Bun v1.3+) to load and parse the manifest
- **4.1.2.2.0.0.0 Schema Validation**: Validates the loaded manifest structure
- **4.1.2.3.0.0.0 Policy Resolution**: Resolves feature flags by combining manifest defaults with runtime overrides
- **4.1.2.4.0.0.0 Provide Policies**: Exposes methods for `UIContextRewriter` to query which transformations are enabled

**See**: [Full UIPolicyManager Documentation](./8.0.0.0.0.0.0-FRONTEND-CONFIG-POLICY.md#820000000-uipolicymanager-service) for complete implementation details.

### 4.1.3.0.0.0.0: Integration with HTMLRewriter & Route Handlers

**UIContextRewriter Adaptation**: The `UIContextRewriter` queries `UIPolicyManager` for active policies instead of hardcoding transformation rules.

**Route Handler Orchestration**: Route handlers use the `UIPolicyManager` to build context and obtain policies.

**See**: [Full Integration Documentation](./8.0.0.0.0.0.0-FRONTEND-CONFIG-POLICY.md#830000000-integration-with-htmlrewriter--route-handlers) for complete integration details.

### 4.1.4.0.0.0.0: Strategic Benefits

- **Declarative Control**: Frontend behavior defined in human-readable, auditable YAML
- **Centralized Policy Management**: Single source of truth for all UI policies
- **Enhanced Auditability**: Version-controlled policy changes provide clear audit trail
- **Dynamic Deployability**: Policies can be updated without code changes
- **Improved Developer Experience**: Clear, consultable manifest instead of code diving
- **Stronger Security Posture**: Declarative RBAC and feature pruning policies

**See**: [Full Strategic Benefits Documentation](./8.0.0.0.0.0.0-FRONTEND-CONFIG-POLICY.md#840000000-strategic-benefits-for-hyper-bun) for detailed explanations.

### 4.1.5.0.0.0.0: MCP Tools Integration

**Location**: `src/mcp/tools/ui-policy-management.ts`

**Available Tools**:
- `ui-policy-get-manifest` - Get current UI Policy Manifest configuration
- `ui-policy-get-metrics` - Get UI Policy Manager metrics and health status
- `ui-policy-validate-manifest` - Validate UI Policy Manifest file
- `ui-policy-reload-manifest` - Hot-reload manifest without restart
- `ui-policy-get-feature-flags` - Get feature flag states
- `ui-policy-check-health` - Check health status and alert on issues

**Alerting Integration**:
- Health status monitoring (`ui-policy-check-health`)
- Error rate tracking via `policyMetrics` service
- Prometheus metrics export (`/api/ui-policy/metrics?format=prometheus`)
- WebSocket real-time alerts (`/ws/ui-policy-metrics`)

---

## 4.2.0.0.0.0.0: Operational Dashboard Enhancements & Tooling

This section focuses on improving the utility and clarity of Hyper-Bun's internal operational dashboards, including the direct integration of vital developer tooling and testing explanations. Effective testing methodologies are paramount to ensuring the MCP's reliability and the integrity of its outputs.

### 4.2.1.0.0.0.0: Snapshot Testing UI & Examples Integration

This enhancement integrates comprehensive explanations and practical code examples for Bun's snapshot testing capabilities directly into Hyper-Bun's internal dashboard. This serves as a self-documenting resource, accelerating developer onboarding and promoting robust testing practices across the team.

#### 4.2.1.1.0.0.0: Integration into API Examples (`src/api/examples.ts`)

A new, detailed example card dedicated to snapshot testing has been added to the API examples, providing actionable code for developers.

##### 4.2.1.1.1.0.0: New Example Entry: "Snapshot Testing - `toMatchSnapshot` & `toMatchInlineSnapshot`"

**Location**: `src/api/examples.ts`

**4.2.1.1.1.1.0 Category**: Categorized under "Testing & Benchmarking" for logical grouping within the dashboard UI.

**4.2.1.1.1.2.0 Comprehensive Code Examples**: The example card now includes runnable code snippets demonstrating key `Bun.test` snapshot functionalities:

- **4.2.1.1.1.2.1 File-Based Snapshots (`toMatchSnapshot()`)**: Demonstrates usage for larger, external snapshot files stored in `__snapshots__/` directories.
- **4.2.1.1.1.2.2 Inline Snapshots (`toMatchInlineSnapshot()`)**: Shows how to embed smaller snapshots directly within the test file for immediate context, with automatic indentation alignment (Bun 1.3+).
- **4.2.1.1.1.2.3 Error Snapshots**: Illustrates capturing and comparing error messages using `toThrowErrorMatchingSnapshot()` and `toThrowErrorMatchingInlineSnapshot()`, crucial for robust error handling testing in Hyper-Bun's critical paths.
- **4.2.1.1.1.2.4 Variable Substitution in `test.each`**: Provides an example of data-driven snapshot testing, where multiple test cases can be run against a template using Bun's `test.each` utility with `$variable` and `$object.property` syntax (Bun 1.3+).

**4.2.1.1.1.3.0 Reference**: Explicitly links to `test/snapshot-examples.test.ts` to guide developers to the corresponding executable test file in the codebase.

**4.2.1.1.1.4.0 Related APIs**: Links to `bun:test`, `toMatchSnapshot`, and `toMatchInlineSnapshot` for cross-referencing.

**4.2.1.1.1.5.0 Usage Commands**: Includes practical CLI commands:
- `bun test test/snapshot-examples.test.ts` - Run snapshot tests
- `bun test --update-snapshots` - Update snapshots when output intentionally changes
- `bun test -u` - Short form for updating snapshots
- `CI=true bun test` - Stricter CI mode (errors on new snapshots)

#### 4.2.1.2.0.0.0: Integration into Dashboard UI (`dashboard/examples.html`)

A user-friendly, non-technical explanation of snapshot testing is now accessible directly from the dashboard, ensuring broad understanding across technical and non-technical stakeholders (e.g., analysts, QA).

##### 4.2.1.2.1.0.0: Layman's Terms Explanation: "Snapshot Testing - Simple Explanation"

This section simplifies complex concepts for immediate comprehension.

**4.2.1.2.1.1.0 Core Concept**: Clearly defines "What snapshots are" (capturing expected output) and "How they work" (first run captures baseline, subsequent runs compare).

**4.2.1.2.1.2.0 Types of Snapshots**: Differentiates between "File snapshots vs inline snapshots" for distinct use cases:
- **File Snapshots**: Stored in `__snapshots__/` folder (good for large/complex data)
- **Inline Snapshots**: Stored right in the test file (good for small values, easier to read)

**4.2.1.2.1.3.0 Walkthrough Example**: Provides a conceptual example walk-through to illustrate the workflow:
- First run: Saves snapshot
- Later runs: Compares new output to saved snapshot
- Match: Test passes ‚úÖ
- Mismatch: Test fails ‚ùå (shows what changed)

**4.2.1.2.1.4.0 Bun 1.3+ Specific Features**: Highlights Bun's advanced capabilities that enhance snapshot testing:
- **4.2.1.2.1.4.1 Automatic Indentation**: Improves readability of generated snapshots by automatically aligning with code indentation level.
- **4.2.1.2.1.4.2 Better Diffs**: Provides clearer visual comparisons for changes with whitespace highlighting (green for added, red for removed, yellow for changed).

**4.2.1.2.1.5.0 Usage Commands**: Explains practical CLI commands for managing snapshots:
- `bun test` - Run all tests
- `bun test --update-snapshots` - Update snapshots when output intentionally changes
- `bun test -u` - Short form
- `CI=true bun test` - Stricter CI mode

**4.2.1.2.1.6.0 Storage Location**: Specifies where snapshots are stored (`__snapshots__/` directory), aiding discoverability:
- File snapshots: `test/__snapshots__/snapshot-examples.test.ts.snap`
- Inline snapshots: Embedded directly in test file

#### 4.2.1.3.0.0.0: Access Instructions for Dashboard UI

Clear, step-by-step guidance ensures that developers, QA, and analysts can easily access and explore the snapshot testing documentation within the running Hyper-Bun application.

**4.2.1.3.1.0.0 Step 1: Start API Server**: `bun run dev`

**4.2.1.3.2.0.0 Step 2: Open Dashboard URL**: `http://localhost:3001/dashboard/examples.html`

**4.2.1.3.3.0.0 Step 3: Filter Examples**: Click "Testing & Benchmarking" category button or search for "Snapshot" in the search interface.

**4.2.1.3.4.0.0 Step 4: View Code Example**: Click the "Snapshot Testing - toMatchSnapshot & toMatchInlineSnapshot" card to view the comprehensive code example with syntax highlighting.

**4.2.1.3.5.0.0 Step 5: View Explanation**: Click the "üí° Simple Explanation" toggle button for the layman's terms description, making complex concepts accessible to non-technical stakeholders.

**4.2.1.3.6.0.0 Alternative Access**: The snapshot testing example is also accessible via the API endpoint at `GET /api/examples` and can be filtered by category "Testing & Benchmarking".

### 4.2.2.0.0.0.0: Multi-Layer Correlation Graph - Developer Dashboard

This new interactive visualization component within the Hyper-Bun Developer Dashboard (`dashboard/examples.html`) provides a powerful tool for understanding complex interdependencies. It allows developers and researchers to visually correlate various layers of data‚Äîfrom raw line movements and derived anomalies to system performance metrics‚Äîhelping to uncover hidden relationships and diagnose system behavior.

#### 4.2.2.1.0.0.0: Purpose

To visualize the correlation strength and patterns between diverse data sets (e.g., `ShadowMovementGraph` nodes, `CovertSteamEventRecord` occurrences, `6.7.1A.0.0.0.0` performance metrics) in a multi-layered, interactive graph format. This aids in root cause analysis, pattern discovery, and system optimization.

#### 4.2.2.2.0.0.0: Data Structures & Properties for Graphing (`MultiLayerCorrelationGraphData`)

This component utilizes a specialized data structure, `MultiLayerCorrelationGraphData`, to represent the nodes and edges of correlation relationships across different data layers.

**Location**: `src/types/dashboard-correlation-graph.ts`

**Type Definitions**:

```typescript
// 4.2.2.2.0.0.0: MultiLayerCorrelationGraphData

/**
 * 4.2.2.2.0.0.0: Interface representing the data structure for the Multi-Layer Correlation Graph.
 * This graph visualizes relationships between nodes from different Hyper-Bun subsystems.
 */
export interface MultiLayerCorrelationGraphData {
  /**
   * 4.2.2.2.0.0.0.1: A unique identifier for this specific instance of the correlation graph.
   */
  graph_id: string;

  /**
   * 4.2.2.2.0.0.0.2: The primary event or context identifier this graph is focused on (e.g., an `event_identifier`).
   */
  primary_context_id: string;

  /**
   * 4.2.2.2.0.0.0.3: An array of all nodes present in the correlation graph.
   * Nodes can represent various entities (market nodes, anomaly events, performance tests).
   * @see CorrelationGraphNode
   */
  nodes: CorrelationGraphNode[];

  /**
   * 4.2.2.2.0.0.0.4: An array of all edges (correlations) between the nodes in the graph.
   * @see CorrelationGraphEdge
   */
  edges: CorrelationGraphEdge[];

  /**
   * 4.2.2.2.0.0.0.5: Metadata about the layers represented in the graph (e.g., 'Market Data', 'Anomalies', 'System Metrics').
   * @see GraphLayerMetadata
   */
  layers_metadata: GraphLayerMetadata[];
}

// Referenced Type: CorrelationGraphNode
/**
 * 4.2.2.2.0.0.0.6: Interface for a single node within the Multi-Layer Correlation Graph.
 * Each node represents an entity from a Hyper-Bun subsystem.
 */
export interface CorrelationGraphNode {
  /**
   * 4.2.2.2.0.0.0.6.1: Unique identifier for this node (e.g., 'market_node:dk:nfl-001:total_q1', 'anomaly:covert-steam-X').
   */
  node_id: string;

  /**
   * 4.2.2.2.0.0.0.6.2: The user-friendly label for display on the graph.
   */
  label: string;

  /**
   * 4.2.2.2.0.0.0.6.3: The Hyper-Bun subsystem or layer this node belongs to.
   * @example 'market_data', 'anomaly_detection', 'performance_monitoring', 'external_feed'
   */
  layer: string;

  /**
   * 4.2.2.2.0.0.0.6.4: An icon or color hint for visual identification on the graph.
   */
  icon_hint?: string;

  /**
   * 4.2.2.2.0.0.0.6.5: Optional deep-link URL to view detailed information about this node's source.
   * @example Link to a specific `CovertSteamEventRecord` in the dashboard, or a `MarketOfferingNode`.
   */
  deeplink_url?: string;

  /**
   * 4.2.2.2.0.0.0.6.6: Optional summary statistics or key values for quick display (e.g., average latency, anomaly count).
   */
  summary_data?: Record<string, string | number>;
}

// Referenced Type: CorrelationGraphEdge
/**
 * 4.2.2.2.0.0.0.7: Interface for an edge (correlation) between two nodes in the graph.
 * Represents a measured statistical or logical relationship.
 */
export interface CorrelationGraphEdge {
  /**
   * 4.2.2.2.0.0.0.7.1: The source node's ID.
   */
  source_node_id: string;

  /**
   * 4.2.2.2.0.0.0.7.2: The target node's ID.
   */
  target_node_id: string;

  /**
   * 4.2.2.2.0.0.0.7.3: The strength of the correlation (e.g., Pearson correlation coefficient, p-value inverse).
   * @example `0.85` for strong positive, `-0.6` for moderate negative.
   */
  correlation_strength: number;

  /**
   * 4.2.2.2.0.0.0.7.4: The type of correlation (e.g., 'statistical_mean', 'temporal_lag', 'causal_inference').
   */
  correlation_type: string;

  /**
   * 4.2.2.2.0.0.0.7.5: The statistical significance (p-value) of this correlation.
   * @see 6.7.1A.0.0.0.0 for statistical methods.
   */
  p_value?: number;

  /**
   * 4.2.2.2.0.0.0.7.6: Directionality of the relationship if known (e.g., 'A influences B').
   * @example 'source_to_target', 'bidirectional', 'undirected'
   */
  direction?: 'source_to_target' | 'target_to_source' | 'bidirectional' | 'undirected';

  /**
   * 4.2.2.2.0.0.0.7.7: Optional descriptive text for the correlation.
   */
  description?: string;
}

// Referenced Type: GraphLayerMetadata
/**
 * 4.2.2.2.0.0.0.8: Interface for metadata about each layer in the graph.
 */
export interface GraphLayerMetadata {
  /**
   * 4.2.2.2.0.0.0.8.1: The unique identifier for the layer (matches `CorrelationGraphNode.layer`).
   */
  id: string;

  /**
   * 4.2.2.2.0.0.0.8.2: A user-friendly name for the layer (e.g., "Market Data Flows").
   */
  name: string;

  /**
   * 4.2.2.2.0.0.0.8.3: A default color to use for nodes/edges in this layer.
   */
  color_hex?: string;

  /**
   * 4.2.2.2.0.0.0.8.4: Description of the data type represented by this layer.
   */
  description?: string;
}
```

**Cross-References**:
- `src/types/dashboard-correlation-graph.ts` - Type definitions implementation
- `6.7.1A.0.0.0.0` - Statistical Significance Testing for correlation methods
- `9.1.1.9.1.0.0` - Deep-Link Standard for `deeplink_url` format

#### 4.2.2.3.0.0.0: Data Sources & Integration

The graph component draws its data from various Hyper-Bun intelligence subsystems.

##### 4.2.2.3.1.0.0: Market Data Layer (Cross-reference: `1.0.0.0.0.0.0 Sub-Market Shadow Graphing`)

- **Nodes**: `MarketOfferingNode`s (visible, API-exposed, dark pool).
- **Edges**: `MarketPropagationLink`s (line propagation, hidden arbitrage).
- **Data Points**: `line_differential_from_parent`, `observed_line_correlation_to_parent`, `propagation_delay_ms`.

##### 4.2.2.3.2.0.0: Anomaly Detection Layer (Cross-reference: `2.0.0.0.0.0.0 Covert Steam Event Detection`)

- **Nodes**: `CovertSteamEventRecord`s, `UrlAnomalyPattern`s.
- **Edges**: Correlation between anomaly occurrences and subsequent market movements.
- **Data Points**: `impact_severity_score`, `covert_line_movement_magnitude`, `visible_market_response_lag_ms`.

##### 4.2.2.3.3.0.0: System Performance Layer (Cross-reference: `6.7.1A.0.0.0.0 Statistical Significance Testing`)

- **Nodes**: Performance metrics from critical functions (e.g., `deepProbeMarketOfferings` latency, `TelegramMessageRouter` queue size).
- **Edges**: Statistical correlation (p-value, effect size) between code changes, performance metric shifts, and market data processing latency.
- **Data Points**: `avg_propagation_delay_ms`, `avg_processing_time`.

##### 4.2.2.3.4.0.0: External Intelligence Layer (Future Expansion)

- **Nodes**: Relevant external data points (e.g., news sentiment, weather events).
- **Edges**: Correlation between external factors and Hyper-Bun's detected market anomalies.

**Cross-References**:
- `1.0.0.0.0.0.0` - Sub-Market Shadow Graphing subsystem
- `2.0.0.0.0.0.0` - Covert Steam Event Detection subsystem
- `6.7.1A.0.0.0.0` - Statistical Significance Testing subsystem

#### 4.2.2.4.0.0.0: Frontend Implementation & Interaction

The graph will be rendered client-side using a lightweight JavaScript graphing library (e.g., `Vis.js`, `D3.js` with custom rendering, or a custom Bun-native WebGL renderer for extreme performance) for interactivity.

##### 4.2.2.4.1.0.0: API Endpoint

`GET /api/dashboard/correlation-graph?event_id=<id>&time_window=<hours>` will serve `MultiLayerCorrelationGraphData`.

**Location**: `src/api/dashboard-correlation-graph.ts`

**Query Parameters**:
- `event_id` (required): The event identifier to generate the correlation graph for
- `time_window` (optional, default: 24): Number of hours to look back for correlation data

**Response**: JSON object matching `MultiLayerCorrelationGraphData` interface

##### 4.2.2.4.2.0.0: Interactive Filtering

Users can filter nodes by `layer`, `bookmaker_name`, `severity`, or correlation strength.

##### 4.2.2.4.3.0.0: Node Details on Hover/Click

Display `summary_data` and provide a link to `deeplink_url` (Cross-reference: `9.1.1.9.1.0.0` Deep-Link Standard) for detailed investigation in the main dashboard.

##### 4.2.2.4.4.0.0: Bun-Native Data Pre-processing

The backend API for this graph (`/api/dashboard/correlation-graph`) leverages Bun's speed to perform complex SQL joins (across `line_movement_audit_v2`, `url_anomaly_audit`, `performance_metrics_audit`) and statistical calculations to aggregate data into `MultiLayerCorrelationGraphData` efficiently.

**Implementation Details**:
- Uses Bun's native SQLite for fast database queries
- Performs correlation calculations in-memory using Bun's optimized JavaScript runtime
- Implements caching to reduce repeated calculations
- Provides performance metrics for query optimization

**Cross-References**:
- `9.1.1.9.1.0.0` - Deep-Link Standard for `deeplink_url` format
- `src/api/dashboard-correlation-graph.ts` - API endpoint implementation

#### 4.2.2.5.0.0.0: Strategic Benefits for Hyper-Bun

##### 4.2.2.5.1.0.0: Holistic Insight

Provides an unparalleled, consolidated view of complex relationships across previously siloed data, enabling a holistic understanding of Hyper-Bun's operational dynamics and market interactions.

##### 4.2.2.5.2.0.0: Accelerated Root Cause Analysis

Visually identifying strong correlations between (e.g.) a sudden spike in `deepProbeMarketOfferings` latency and a subsequent `CovertSteamEvent` simplifies root cause analysis for anomalous system or market behavior.

##### 4.2.2.5.3.0.0: Enhanced Pattern Discovery

Facilitates the discovery of new, multi-layered correlation patterns that might not be evident from individual data streams.

##### 4.2.2.5.4.0.0: Improved Debugging & Optimization

Developers can use the graph to understand the impact of code changes or system events on a wider range of metrics, leading to more targeted optimizations.

**Cross-References**:
- `src/api/dashboard-correlation-graph.ts` - API implementation
- `src/types/dashboard-correlation-graph.ts` - Type definitions
- `dashboard/examples.html` - Frontend dashboard integration
- [Performance Validation & Production Hardening Report](./MULTI-LAYER-CORRELATION-PERFORMANCE-VALIDATION.md) (4.2.2.6.0.0.0) - Performance metrics and production readiness
- [Performance Metrics Analysis](./4.2.2.9-PERFORMANCE-METRICS-ANALYSIS.md) (4.2.2.9.0.0.0) - Detailed performance analysis and optimization recommendations
- [Ripgrep Verification Report](./4.2.2-RIPGREP-VERIFICATION.md) (4.2.2.7.0.0.0) - Comprehensive version verification

**Ripgrep Pattern**: `4\.2\.2\.0\.0\.0\.0|4\.2\.2\.6\.0\.0\.0|MULTI-LAYER-CORRELATION-GRAPH|MultiLayerCorrelationGraphData|CorrelationGraphNode|CorrelationGraphEdge`

### 4.3.0.0.0.0.0: Operational Dashboard Benefits for Snapshot Testing

The integration of snapshot testing documentation into the dashboard provides significant advantages for Hyper-Bun's development and operational practices.

#### 4.3.1.0.0.0.0: Accelerated Onboarding

New developers can rapidly understand and apply snapshot testing methodologies, contributing to more robust code faster. The dashboard serves as a self-documenting resource that eliminates the need to search external documentation or ask team members for guidance.

**Impact**: Reduces onboarding time for testing practices from days to hours, enabling immediate contribution to test coverage.

#### 4.3.2.0.0.0.0: Enhanced UI/Data Consistency Confidence

Critical for Hyper-Bun's UI (`HTMLRewriter` output, graph renderings) and structured data (`HyperBunUIContext` serialization), ensuring unintended changes are caught immediately. Snapshot testing provides automated verification of complex outputs that would be impractical to assert manually.

**Impact**: Prevents regressions in UI transformations and data serialization, maintaining consistency across deployments.

#### 4.3.3.0.0.0.0: Streamlined Regression Detection

Automates verification of complex outputs, reducing manual assertion burden and improving test reliability across subsystems. Snapshot tests catch unexpected changes in:
- API response structures
- HTML transformation outputs
- Complex data structures
- Error message formats

**Impact**: Reduces false positives in manual testing and catches regressions that might be missed in code review.

#### 4.3.4.0.0.0.0: Promotes Test-Driven Documentation Culture

Fosters an environment where testing best practices are not just coded but also clearly explained and easily discoverable within the application itself. The dashboard integration makes testing documentation a first-class citizen alongside code examples.

**Impact**: Encourages consistent testing practices across the team and makes testing knowledge accessible to all stakeholders.

#### 4.3.5.0.0.0.0: Reinforces Bun-Native Development

Directly showcases and promotes the use of Bun's powerful, built-in testing features, aligning with Hyper-Bun's core platform strategy. By highlighting Bun 1.3+ enhancements (automatic indentation, better diffs, variable substitution), the dashboard reinforces the value of staying current with Bun's native capabilities.

**Impact**: Ensures the team leverages Bun's full testing potential rather than relying on external testing frameworks.

**Cross-References**:
- `test/snapshot-examples.test.ts` - Comprehensive snapshot testing examples
- `docs/BUN-1.3-TEST-IMPROVEMENTS.md` - Complete Bun 1.3 test framework documentation
- `docs/STORE-CONSTANTS-REGISTRIES-DATABASES.md` - Snapshot storage locations (Section 11)
- `COMPONENT-SITEMAP.md` - Snapshot testing section (Section 11)
- `src/api/examples.ts` - API examples integration
- `dashboard/examples.html` - Dashboard UI integration

**Ripgrep Pattern**: `4\.2\.1\.0\.0\.0\.0|SNAPSHOT-TESTING-UI|toMatchSnapshot|toMatchInlineSnapshot`

---

## 4.4.0.0.0.0.0: MCP Server Architecture

### 4.4.1.0.0.0.0: Core Server

**Location**: `src/mcp/server.ts`

**Features**:
- JSON-RPC 2.0 protocol
- stdio mode communication
- Tool registration and execution
- Resource management
- Compliance logging integration

### 4.4.2.0.0.0.0: Tool Categories

#### 4.4.2.1.0.0.0: Bun Tooling Tools
- **File**: `src/mcp/tools/bun-tooling.ts`
- **Tools**: Diagnostics, health checks, profiling, metrics
- **Purpose**: Bun runtime monitoring and diagnostics

#### 4.4.2.2.0.0.0: Bun Shell Tools
- **File**: `src/mcp/tools/bun-shell-tools.ts`
- **Tools**: Shell command execution, file operations
- **Purpose**: Cross-platform shell scripting

#### 4.4.2.3.0.0.0: Documentation Integration Tools
- **File**: `src/mcp/tools/docs-integration.ts`
- **Tools**: Documentation headers, footers, Bun docs integration
- **Purpose**: Documentation management and generation

#### 4.4.2.4.0.0.0: Security Dashboard Tools
- **File**: `src/mcp/tools/security-dashboard.ts`
- **Tools**: Threat monitoring, incident response, compliance
- **Purpose**: Security monitoring and alerting

#### 4.4.2.5.0.0.0: Research Tools

---

## 4.7.0.0.0.0.0: Cursor IDE Integration

**Version**: 4.7.0.0.0.0.0  
**Purpose**: Cursor IDE MCP server configuration and setup  
**Status**: ‚úÖ Complete

### 4.7.1.0.0.0.0: Overview

The Cursor IDE integration provides seamless access to Hyper-Bun's MCP server and external MCP services directly from the Cursor editor. This enables AI-assisted development workflows with access to Hyper-Bun's domain-specific tools and Bun's official MCP services.

**Configuration File**: `.cursor/mcp.json`  
**Documentation**: `.cursor/mcp-config.md`

### 4.7.2.0.0.0.0: Available MCP Servers

#### 4.7.2.1.0.0.0: Bun MCP Server (External)

- **Name**: `bun`
- **Transport**: HTTP
- **URL**: `https://mcp.bun.sh`
- **API Key**: Optional (set in `apiKey` field)
- **Tools**: 
  - `SearchBun` - Search Bun's knowledge base

**API Key Setup**:
- Obtain API key from [Bun's MCP service](https://mcp.bun.sh) if required
- Add to `apiKey` field in `.cursor/mcp.json`
- Or use secure storage via `Bun.secrets` (see `4.7.3.0.0.0.0`)

#### 4.7.2.2.0.0.0: NEXUS MCP Server (Local)

- **Name**: `nexus`
- **Command**: `bun run scripts/mcp-server.ts`
- **Tools**: See `docs/api/MCP-SERVER.md` for full list
- **Requirements**: 
  - Bun runtime installed
  - Project dependencies installed (`bun install`)
  - Optional: `./data/research.db` for research tools

**Bun Utilities Used** (`7.0.0.0.0.0.0`):
- `7.5.5.0.0.0.0` - Bun.stdin (standard input for JSON-RPC)
- `7.5.6.0.0.0.0` - Bun.stdout (standard output for JSON-RPC)
- `7.5.7.0.0.0.0` - Bun.stderr (diagnostic messages)

**Cross-Reference**: `src/mcp/server.ts` for stdio protocol communication

### 4.7.3.0.0.0.0: Secure API Key Storage

For enhanced security, MCP API keys can be stored using `Bun.secrets` instead of plain text in JSON configuration files.

**Bun Utility**: `7.11.5.0.0.0.0` - Bun.secrets (OS-native encrypted credential storage)

**Implementation**:
```typescript
import { mcpApiKeys } from "./src/secrets/mcp";

// Store API key securely (macOS Keychain, Linux libsecret, Windows Credential Manager)
await mcpApiKeys.set("bun", "your-api-key-here");

// The NEXUS MCP server automatically loads keys from Bun.secrets on startup
```

**Benefits**:
- API keys encrypted at rest using OS-native credential storage
- Keys separate from configuration files (not committed to git)
- Automatically loaded by the NEXUS MCP server

**Cross-Reference**: `docs/MCP-SECRETS-INTEGRATION.md` for complete details

### 4.7.4.0.0.0.0: Setup Instructions

1. **Initial Setup**:
   ```bash
   # Copy template to actual config
   cp .cursor/mcp.json.template .cursor/mcp.json
   
   # Edit mcp.json and add your Bun API key if needed
   # Then restart Cursor
   ```

2. **Verify Configuration**:
   - Ensure `.cursor/mcp.json` exists with proper configuration
   - Check that `scripts/mcp-server.ts` is executable
   - Verify Bun is installed: `bun --version`

3. **Load Servers**:
   - Restart Cursor to load MCP servers
   - MCP tools will be available in Cursor's tool palette

4. **Troubleshooting**:
   - Check Cursor's MCP server logs for connection errors
   - Verify the nexus server starts: `bun run scripts/mcp-server.ts`
   - Ensure all project dependencies are installed: `bun install`

### 4.7.5.0.0.0.0: Integration with CLI Commands

The Cursor MCP configuration integrates with the MCP CLI commands (`11.2.0.0.0.0.0`):

**CLI Cross-Reference**:
- `11.2.1.0.0.0.0` - Tool Listing (`bun run mcp list`)
- `11.2.2.0.0.0.0` - Tool Execution (`bun run mcp exec <tool>`)
- `11.2.3.0.0.0.0` - Tool Categories

**Usage Example**:
```bash
# List available MCP tools
bun run mcp list

# Execute tooling diagnostics
bun run mcp exec tooling-diagnostics

# Research patterns
bun run mcp exec research-discover-patterns --sport=NBA --hours=24
```

**Cross-Reference**: `commands/mcp.md` for complete CLI documentation

---

**See**: `.cursor/mcp-config.md` for complete Cursor IDE integration documentation

---

## 4.5.0.0.0.0.0: Cursor IDE Integration

**Version**: 4.5.0.0.0.0.0  
**Purpose**: Cursor IDE MCP server configuration and setup  
**Status**: ‚úÖ Complete

### 4.5.1.0.0.0.0: Overview

The Cursor IDE integration provides seamless access to Hyper-Bun's MCP server and external MCP services directly from the Cursor editor. This enables AI-assisted development workflows with access to Hyper-Bun's domain-specific tools and Bun's official MCP services.

**Configuration File**: `.cursor/mcp.json`  
**Documentation**: `.cursor/mcp-config.md`

### 4.5.2.0.0.0.0: Available MCP Servers

#### 4.5.2.1.0.0.0: Bun MCP Server (External)

- **Name**: `bun`
- **Transport**: HTTP
- **URL**: `https://mcp.bun.sh`
- **API Key**: Optional (set in `apiKey` field)
- **Tools**: 
  - `SearchBun` - Search Bun's knowledge base

**API Key Setup**:
- Obtain API key from [Bun's MCP service](https://mcp.bun.sh) if required
- Add to `apiKey` field in `.cursor/mcp.json`
- Or use secure storage via `Bun.secrets` (see `4.5.3.0.0.0.0`)

#### 4.5.2.2.0.0.0: NEXUS MCP Server (Local)

- **Name**: `nexus`
- **Command**: `bun run scripts/mcp-server.ts`
- **Tools**: See `docs/api/MCP-SERVER.md` for full list
- **Requirements**: 
  - Bun runtime installed
  - Project dependencies installed (`bun install`)
  - Optional: `./data/research.db` for research tools

**Bun Utilities Used** (`7.0.0.0.0.0.0`):
- `7.5.5.0.0.0.0` - Bun.stdin (standard input for JSON-RPC)
- `7.5.6.0.0.0.0` - Bun.stdout (standard output for JSON-RPC)
- `7.5.7.0.0.0.0` - Bun.stderr (diagnostic messages)

**Cross-Reference**: `src/mcp/server.ts` for stdio protocol communication

### 4.5.3.0.0.0.0: Secure API Key Storage

For enhanced security, MCP API keys can be stored using `Bun.secrets` instead of plain text in JSON configuration files.

**Bun Utility**: `7.11.5.0.0.0.0` - Bun.secrets (OS-native encrypted credential storage)

**Implementation**:
```typescript
import { mcpApiKeys } from "./src/secrets/mcp";

// Store API key securely (macOS Keychain, Linux libsecret, Windows Credential Manager)
await mcpApiKeys.set("bun", "your-api-key-here");

// The NEXUS MCP server automatically loads keys from Bun.secrets on startup
```

**Benefits**:
- API keys encrypted at rest using OS-native credential storage
- Keys separate from configuration files (not committed to git)
- Automatically loaded by the NEXUS MCP server

**Cross-Reference**: `docs/MCP-SECRETS-INTEGRATION.md` for complete details

### 4.5.4.0.0.0.0: Setup Instructions

1. **Initial Setup**:
   ```bash
   # Copy template to actual config
   cp .cursor/mcp.json.template .cursor/mcp.json
   
   # Edit mcp.json and add your Bun API key if needed
   # Then restart Cursor
   ```

2. **Verify Configuration**:
   - Ensure `.cursor/mcp.json` exists with proper configuration
   - Check that `scripts/mcp-server.ts` is executable
   - Verify Bun is installed: `bun --version`

3. **Load Servers**:
   - Restart Cursor to load MCP servers
   - MCP tools will be available in Cursor's tool palette

4. **Troubleshooting**:
   - Check Cursor's MCP server logs for connection errors
   - Verify the nexus server starts: `bun run scripts/mcp-server.ts`
   - Ensure all project dependencies are installed: `bun install`

### 4.5.5.0.0.0.0: Integration with CLI Commands

The Cursor MCP configuration integrates with the MCP CLI commands (`11.2.0.0.0.0.0`):

**CLI Cross-Reference**:
- `11.2.1.0.0.0.0` - Tool Listing (`bun run mcp list`)
- `11.2.2.0.0.0.0` - Tool Execution (`bun run mcp exec <tool>`)
- `11.2.3.0.0.0.0` - Tool Categories

**Usage Example**:
```bash
# List available MCP tools
bun run mcp list

# Execute tooling diagnostics
bun run mcp exec tooling-diagnostics

# Research patterns
bun run mcp exec research-discover-patterns --sport=NBA --hours=24
```

**Cross-Reference**: `commands/mcp.md` for complete CLI documentation

---

**See**: `.cursor/mcp-config.md` for complete Cursor IDE integration documentation
- **File**: `src/research/mcp/tools/research-explorer.ts`
- **Tools**: Pattern discovery, tension exploration, correlation analysis
- **Purpose**: Research and pattern analysis

#### 4.4.2.6.0.0.0: Anomaly Research Tools
- **File**: `src/mcp/tools/anomaly-research.ts`
- **Tools**: URL anomaly detection, pattern analysis
- **Purpose**: Anomaly detection and research

#### 4.4.2.7.0.0.0: UI Policy Management Tools (4.1.5.0.0.0.0)
- **File**: `src/mcp/tools/ui-policy-management.ts`
- **Tools**:
  - `ui-policy-get-manifest` - Get manifest configuration
  - `ui-policy-get-metrics` - Get metrics and health
  - `ui-policy-validate-manifest` - Validate manifest file
  - `ui-policy-reload-manifest` - Hot-reload manifest
  - `ui-policy-get-feature-flags` - Get feature flag states
  - `ui-policy-check-health` - Health check with alerts
- **Purpose**: Frontend policy management and monitoring
- **Integration**: Frontend Configuration & Policy Management (4.1.0.0.0.0.0)

---

## 4.5.0.0.0.0.0: Alerting Infrastructure

### 4.5.1.0.0.0.0: Health Monitoring

MCP tools provide health monitoring capabilities:

- **Security Health**: `security-threat-summary`, `security-incident-status`
- **UI Policy Health**: `ui-policy-check-health` (4.1.5.0.0.0.0)
- **System Health**: `tooling-check-health`

### 4.5.2.0.0.0.0: Metrics Integration

All subsystems expose Prometheus-compatible metrics:

- **Security Metrics**: `/api/security/metrics`
- **UI Policy Metrics**: `/api/ui-policy/metrics` (4.1.5.0.0.0.0)
- **System Metrics**: `/api/metrics`

### 4.5.3.0.0.0.0: Real-Time Alerts

WebSocket endpoints for real-time monitoring:

- **Security Alerts**: `/ws/security-alerts`
- **UI Policy Metrics**: `/ws/ui-policy-metrics` (4.1.5.0.0.0.0)

---

---

## 4.6.0.0.0.0.0: Integration Points

### 4.6.1.0.0.0.0: Frontend Configuration & Policy Management (4.1.0.0.0.0.0)

**Integration**: UI Policy Management tools integrated into MCP server

**Tools Available**:
- Manifest management and validation
- Feature flag monitoring
- Policy health checks
- Metrics export

**Alerting**:
- Health status monitoring (`ui-policy-check-health`)
- Error rate tracking
- Latency monitoring
- Automatic alerts for unhealthy states

### 4.6.2.0.0.0.0: Security Subsystem

**Integration**: Security Dashboard tools provide threat monitoring

**Tools Available**:
- Threat summary
- Incident status
- Compliance reporting

### 4.6.3.0.0.0.0: Research Subsystem

**Integration**: Research tools for pattern discovery

**Tools Available**:
- Pattern discovery
- Tension exploration
- Correlation analysis

---

## Usage

### Start MCP Server

```bash
bun run mcp-server
```

### Use MCP Tools

Tools are accessible via MCP protocol clients (e.g., Claude Desktop):

```json
{
  "method": "tools/call",
  "params": {
    "name": "ui-policy-get-manifest",
    "arguments": {}
  }
}
```

---

## Related Documentation

- [MCP Server Documentation](../MCP-SERVER.md) - MCP server implementation
- [Frontend Configuration & Policy Subsystem](./8.0.0.0.0.0.0-FRONTEND-CONFIG-POLICY.md) - UI Policy management
- [Communication & Notification Subsystem](./9.0.0.0.0.0.0-COMMUNICATION-NOTIFICATION.md) - Telegram integration and notification setup (9.0.0.0.0.0.0)
- [Bun 1.3 Test Improvements](./BUN-1.3-TEST-IMPROVEMENTS.md) - Snapshot testing and test framework enhancements (4.2.1.0.0.0.0)
- [Dashboard Correlation Graph](./DASHBOARD-CORRELATION-GRAPH.md) - Multi-Layer Correlation Graph implementation and usage guide (4.2.2.0.0.0.0)
- [Multi-Layer Correlation Performance Validation](./MULTI-LAYER-CORRELATION-PERFORMANCE-VALIDATION.md) - Performance metrics, production hardening, and DoD compliance (4.2.2.6.0.0.0)
- [Multi-Layer Correlation System Specification](./1.1.1.1.4-MULTI-LAYER-CORRELATION-SYSTEM-SPECIFICATION.md) - Complete technical specification (1.1.1.1.4.0.0.0)
- [Production Deployment Guide](./4.2.2-PRODUCTION-DEPLOYMENT-GUIDE.md) - Complete deployment checklist, integration steps, and monitoring setup (4.2.2.18.0.0.0)
- [Security Architecture](./SECURITY-ARCHITECTURE.md) - Security subsystem
- [Component Sitemap](../COMPONENT-SITEMAP.md) - Snapshot storage locations and examples

---

**Ripgrep Pattern**: `4\.0\.0\.0\.0\.0\.0|4\.2\.1\.0\.0\.0\.0|4\.2\.2\.0\.0\.0\.0|4\.2\.2\.6\.0\.0\.0|4\.2\.0\.0\.0\.0\.0|SNAPSHOT-TESTING-UI|MULTI-LAYER-CORRELATION-GRAPH|PERFORMANCE-VALIDATION|OPERATIONAL-DASHBOARD|MCP-ALERTING|Master Control Program`

**Key Sections**:
- **4.1.0.0.0.0.0**: Frontend Configuration & Policy Management
- **4.2.0.0.0.0.0**: Operational Dashboard Enhancements & Tooling
  - **4.2.1.0.0.0.0**: Snapshot Testing UI & Examples Integration
  - **4.2.2.0.0.0.0**: Multi-Layer Correlation Graph - Developer Dashboard
    - **4.2.2.6.0.0.0**: Performance Validation & Production Hardening
    - **4.2.2.7.0.0.0**: Ripgrep Verification Report
    - **4.2.2.8.0.0.0**: Materialized View Optimization (Anomaly Candidates)
    - **4.2.2.9.0.0.0**: Performance Metrics Analysis
    - **4.2.2.18.0.0.0**: Production Deployment Guide
  - **4.3.0.0.0.0.0**: Operational Dashboard Benefits for Snapshot Testing
- **10.0.0.0.0.0.0**: Authentication & Session Management Subsystem
  - **10.1.0.0.0.0.0**: Cookie Management with Bun's Native APIs
  - **10.2.0.0.0.0.0**: Strategic Impact & Benefits
- **4.4.0.0.0.0.0**: MCP Server Architecture
- **4.5.0.0.0.0.0**: Alerting Infrastructure
- **4.6.0.0.0.0.0**: Integration Points
