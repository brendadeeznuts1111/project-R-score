# Profiling Multi-Layer Graph System v17

**Version**: 17.16.1.0.0.0.0  
**Status**: âœ… **PRODUCTION READY**  
**Last Updated**: 2025-01-15

---

## Overview

The **Profiling Multi-Layer Graph System v17** (`ProfilingMultiLayerGraphSystem17`) is a profiling-enabled wrapper around the core multi-layer correlation graph system. It provides CPU profiling integration, performance monitoring, and enhanced error handling for Hyper-Bun's arbitrage detection and correlation analysis.

**ðŸ“Š Related Dashboards**:
- [MLGS Developer Dashboard](./../dashboard/mlgs-developer-dashboard.html) - Monitor profiling metrics and performance
- [Multi-Layer Graph](./../dashboard/multi-layer-graph.html) - Visualize correlation graphs
- [Main Dashboard](./../dashboard/index.html) - System health and metrics

**Code Reference**: `src/arbitrage/shadow-graph/profiling/17.16.1-profiling-multilayer-graph.system.ts`

---

## Features

### Core Capabilities

1. **Layer 1 Correlations** (17.16.1.1.0.0.0)
   - Direct market correlations with confidence filtering
   - Time range filtering
   - Related market detection

2. **Layer 2 Correlations** (17.16.1.2.0.0.0)
   - Cross-market correlations
   - Event and market type filtering
   - Confidence threshold enforcement

3. **Hidden Edge Detection** (17.16.1.3.0.0.0)
   - Statistical analysis across all 4 layers
   - Confidence threshold filtering
   - Minimum observation requirements
   - Time window constraints

4. **Profile Management** (17.16.1.4.0.0.0)
   - Session-based profiling
   - Performance metrics tracking
   - Memory usage monitoring

5. **Market Management** (17.16.1.5.0.0.0)
   - Market data storage and retrieval
   - Duplicate prevention
   - Bulk operations

---

## Architecture

### System Components

```
ProfilingMultiLayerGraphSystem17
â”œâ”€â”€ ProfilingMultiLayerGraphSystem (underlying system)
â”‚   â”œâ”€â”€ PerformanceMonitor (CPU profiling)
â”‚   â”œâ”€â”€ MultiLayerCorrelationGraph (graph structure)
â”‚   â””â”€â”€ Database (SQLite for persistence)
â”œâ”€â”€ Markets (Market17[]) - Market data storage
â””â”€â”€ Profiles (Map<string, Profile17>) - Session profiles
```

### Integration Points

- **MarketDataRouter17**: Primary integration point for API routes
- **Layer4TickCorrelationDetector**: Cross-sport correlation detection
- **Performance Dashboard**: Metrics visualization

---

## Usage

### Basic Setup

```typescript
import { ProfilingMultiLayerGraphSystem17 } from './src/arbitrage/shadow-graph/profiling/17.16.1-profiling-multilayer-graph.system';

// Initialize with profiling enabled
const system = new ProfilingMultiLayerGraphSystem17({
  enableProfiling: true,
  profilingConfig: {
    name: "production",
    dir: "./profiles"
  }
});
```

### Layer 1 Correlations

```typescript
const result = await system.computeLayer1Correlations17({
  marketId: "nba-lakers-warriors-2024-01-15",
  selectionId: "LAKERS-PLUS-7.5",
  timeRange: {
    start: Date.now() - 86400000, // 24 hours ago
    end: Date.now()
  },
  minConfidence: 0.7
});

console.log(`Found ${result.correlations.length} correlations`);
console.log(`Related markets: ${result.relatedMarkets.join(', ')}`);
```

### Layer 2 Correlations

```typescript
const result = await system.computeLayer2Correlations17({
  marketType: "moneyline",
  eventId: "nba-lakers-warriors-2024-01-15",
  minConfidence: 0.75
});

console.log(`Cross-market correlations: ${result.correlations.length}`);
```

### Hidden Edge Detection

```typescript
const edges = await system.detectHiddenEdges17({
  layer: 2,
  confidenceThreshold: 0.85,
  minObservations: 10,
  timeWindow: 3600000 // 1 hour in milliseconds
});

console.log(`Detected ${edges.length} hidden edges`);
edges.forEach(edge => {
  console.log(`${edge.from} -> ${edge.to} (confidence: ${edge.confidence})`);
});
```

### Profile Management

```typescript
// Get profile by session ID
const profile = await system.getProfile17("session-123");
if (profile) {
  console.log(`Duration: ${profile.data.duration}ms`);
  console.log(`Memory: ${profile.data.memoryUsage} bytes`);
}

// Delete profile
await system.deleteProfile17("session-123");
```

### Market Management

```typescript
// Add markets
system.addMarket({
  id: "nba-lakers-warriors-2024-01-15",
  name: "Lakers vs Warriors",
  type: "moneyline",
  timestamp: Date.now()
});

// Get all markets
const markets = await system.getAllMarkets17();
console.log(`Total markets: ${markets.length}`);

// Get statistics
const stats = system.getStatistics();
console.log(`Markets: ${stats.marketCount}, Profiles: ${stats.profileCount}`);
```

---

## API Integration

### MarketDataRouter17 Integration

The profiling system is integrated into `MarketDataRouter17` for API endpoint handling:

```typescript
// In MarketDataRouter17 constructor
this.graphSystem = new ProfilingMultiLayerGraphSystem17({
  enableProfiling: process.env.BUN_PROFILING === "true"
});

// Used in route handlers
const correlations = await this.graphSystem.computeLayer1Correlations17({
  marketId,
  selectionId: "",
  timeRange: { start, end },
  minConfidence: 0.7
});
```

### API Endpoints

The following endpoints use the profiling system:

- `GET /api/v17/layer1/correlation/:marketId/:selectionId` - Layer 1 correlations
- `GET /api/v17/layer2/correlation/:marketType/:eventId` - Layer 2 correlations
- `GET /api/v17/hidden/edges/:layer/:confidenceThreshold` - Hidden edge detection
- `GET /api/v17/profiles/:sessionId` - Get profile
- `DELETE /api/v17/profiles/:sessionId` - Delete profile
- `GET /api/v17/markets` - List all markets

---

## Performance Monitoring

### CPU Profiling

Enable CPU profiling via environment variable:

```bash
BUN_PROFILING=true bun run dev
```

Or programmatically:

```typescript
const system = new ProfilingMultiLayerGraphSystem17({
  enableProfiling: true,
  profilingConfig: {
    name: "graph-analysis",
    dir: "./profiles"
  }
});
```

### Performance Metrics

The system tracks:

- **Duration**: Operation execution time
- **Memory Usage**: Heap memory consumption
- **Recursion Depth**: For recursive operations
- **Correlation Pairs**: Number of pairs processed
- **Session Metrics**: Per-session performance data

### Accessing Metrics

```typescript
const stats = system.getStatistics();
console.log(stats.performanceSummary);
// {
//   totalSessions: 10,
//   activeSessions: 2,
//   totalMetrics: 150,
//   averageDuration: 45.2
// }
```

---

## Error Handling

All methods include comprehensive error handling:

- **Input Validation**: Validates all parameters before processing
- **Graceful Degradation**: Returns empty results on error instead of throwing
- **Error Logging**: Logs errors to console for debugging
- **Type Safety**: TypeScript types ensure correct usage

### Example Error Handling

```typescript
try {
  const result = await system.computeLayer1Correlations17({
    marketId: "invalid",
    selectionId: "",
    timeRange: { start: 0, end: 0 },
    minConfidence: -1 // Invalid
  });
  // Returns empty result instead of throwing
  console.log(result.correlations.length); // 0
} catch (error) {
  // Only throws on critical errors
  console.error("Critical error:", error);
}
```

---

## Testing

### Unit Tests

See `test/profiling/multilayer-performance.test.ts` for comprehensive test coverage.

### Integration Tests

See `test/api/17.16.9-market-router.test.ts` for API integration tests.

### Running Tests

```bash
# Run profiling tests
bun test test/profiling/multilayer-performance.test.ts

# Run API integration tests
bun test test/api/17.16.9-market-router.test.ts
```

---

## Configuration

### SystemConfig Interface

```typescript
interface SystemConfig {
  data?: unknown[];              // Initial data
  enableProfiling?: boolean;     // Enable CPU profiling
  profilingConfig?: {
    name?: string;              // Profile name
    dir?: string;                // Profile directory
  };
  testMode?: boolean;            // Test mode flag
  db?: Database;                 // SQLite database instance
}
```

### Environment Variables

- `BUN_PROFILING` - Enable CPU profiling (default: `false`)
- `BUN_CPU_PROF` - Enable CPU profiler output (default: `false`)

---

## Related Documentation

- [`instrumented-system.ts`](./../src/arbitrage/shadow-graph/profiling/instrumented-system.ts) - Underlying profiling system
- [`performance-monitor.ts`](./../src/arbitrage/shadow-graph/profiling/performance-monitor.ts) - Performance monitoring
- [`MarketDataRouter17`](./MARKET-DATA-ROUTER-17-COMPLETE.md) - API router integration
- [`Multi-Layer Correlation Graph`](./MULTI-LAYER-GRAPH-DASHBOARD-INTEGRATION.md) - Graph visualization

---

## Quick Reference

### Method Summary

| Method | Description | Returns |
|--------|-------------|---------|
| `computeLayer1Correlations17()` | Compute Layer 1 correlations | `Layer1CorrelationResult17` |
| `computeLayer2Correlations17()` | Compute Layer 2 correlations | `Layer2CorrelationResult17` |
| `detectHiddenEdges17()` | Detect hidden edges | `HiddenEdgeResult17[]` |
| `getProfile17()` | Get profile by session ID | `Profile17 \| null` |
| `deleteProfile17()` | Delete profile | `void` |
| `getAllMarkets17()` | Get all markets | `Market17[]` |
| `addMarket()` | Add market | `void` |
| `addProfile()` | Add profile | `void` |
| `getStatistics()` | Get system statistics | `Statistics` |
| `cleanup()` | Cleanup resources | `void` |

---

**Quick Links**: [MLGS Developer Dashboard](./../dashboard/mlgs-developer-dashboard.html) | [Multi-Layer Graph](./../dashboard/multi-layer-graph.html) | [Documentation Index](./DOCUMENTATION-INDEX.md)

**Author**: NEXUS Team  
**Version**: 17.16.1.0.0.0.0  
**Last Updated**: 2025-01-15
