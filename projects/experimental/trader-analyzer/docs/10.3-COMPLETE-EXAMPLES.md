# Complete Examples: Authentication & Session Management

**Version**: 10.3.0.0.0.0  
**Component**: Complete Integration Examples  
**Status**: ✅ Ready

---

## Overview

Complete, production-ready examples demonstrating all Bun 1.3 authentication and session management features working together.

---

## Available Examples

### 1. Basic Features Example

**File**: `examples/bun-1.3-features.ts`

Demonstrates individual Bun 1.3 features:
- YAML parsing
- CSRF protection
- Secrets management
- DisposableStack
- Zstandard compression
- ReadableStream convenience methods

**Run**:
```bash
bun example:bun-1.3
```

---

### 2. Complete Server Example

**File**: `examples/bun-1.3-server.ts`

Full HTTP server with:
- Authentication (login/logout)
- Session management
- CSRF protection
- Zstandard compression
- ReadableStream responses
- YAML configuration
- Disposable resources
- WebSocket with compression

**Run**:
```bash
bun example:bun-1.3:server
```

**Endpoints**:
- `POST /api/auth/login` - Login
- `POST /api/auth/logout` - Logout
- `POST /api/compressed` - Zstandard compression
- `GET /api/stream` - ReadableStream example
- `GET /api/config` - YAML config
- `GET /api/disposable` - DisposableStack example
- `GET /health` - Health check

---

### 3. Complete Auth Integration

**File**: `examples/complete-auth-integration.ts`

Production-ready authentication system:
- Session management
- CSRF protection
- Middleware composition
- UI preferences
- Protected routes

**Run**:
```bash
bun example:bun-1.3:auth
```

**Endpoints**:
- `POST /api/auth/login` - Login (sets session + CSRF)
- `POST /api/auth/logout` - Logout
- `GET /api/csrf` - Get CSRF token
- `GET /api/protected` - Protected resource (requires session + CSRF)
- `GET /api/preferences` - Get UI preferences
- `POST /api/preferences` - Set UI preferences

**Usage Flow**:
1. `POST /api/auth/login` → Get session cookie
2. `GET /api/csrf` → Get CSRF token
3. `GET /api/protected` with `X-CSRF-Token` header → Access protected resource

---

### 4. Middleware Composition

**File**: `examples/middleware-composition.ts`

Demonstrates middleware composition pattern:
- Session validation
- User attachment
- CSRF validation
- Clean handler composition

**Run**:
```bash
bun example:bun-1.3:middleware
```

---

### 5. Crypto Performance

**File**: `examples/crypto-performance.ts`

Benchmarks Bun 1.3 crypto improvements:
- DiffieHellman (~400x faster)
- AES-256-GCM (~400x faster)
- scrypt (~6x faster)
- X25519 key generation

**Run**:
```bash
bun example:bun-1.3:crypto
```

---

### 6. WebAssembly Streaming

**File**: `examples/webassembly-streaming.ts`

WebAssembly streaming examples:
- `compileStreaming()`
- `instantiateStreaming()`
- Efficient WASM loading

**Run**:
```bash
bun example:bun-1.3:wasm
```

---

## Quick Start Guide

### 1. Start Complete Auth Server

```bash
bun example:bun-1.3:auth
```

### 2. Test Login

```bash
curl -X POST http://localhost:3002/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test"}' \
  -c cookies.txt -v
```

### 3. Get CSRF Token

```bash
curl http://localhost:3002/api/csrf \
  -b cookies.txt \
  -v
```

### 4. Access Protected Resource

```bash
curl http://localhost:3002/api/protected \
  -b cookies.txt \
  -H "X-CSRF-Token: <token-from-step-3>" \
  -v
```

---

## Testing Examples

### Test Cookie Security

```bash
# Login
curl -X POST http://localhost:3002/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test"}' \
  -v 2>&1 | grep -i "set-cookie"

# Verify HttpOnly, Secure, SameSite attributes
```

### Test CSRF Protection

```bash
# Try without CSRF token (should fail)
curl -X POST http://localhost:3002/api/protected \
  -b cookies.txt \
  -v

# Should return 403 Forbidden
```

---

## Integration Patterns

### Pattern 1: Simple Protected Route

```typescript
const handler = withMiddleware(
  myHandler,
  SessionMiddleware.validate,
  CSRFMiddleware.validate
);
```

### Pattern 2: Protected Route with User Context

```typescript
const handler = withMiddleware(
  myHandler,
  SessionMiddleware.validate,
  SessionMiddleware.attachUser,
  CSRFMiddleware.validate
);
```

### Pattern 3: Public Route with CSRF Generation

```typescript
const handler = withMiddleware(
  myHandler,
  CSRFMiddleware.generate
);
```

---

## Best Practices

1. **Always use middleware composition** for protected routes
2. **Generate CSRF tokens** on GET requests that return forms
3. **Validate CSRF tokens** on all state-changing requests (POST, PUT, DELETE)
4. **Set UI preferences** with `SameSite: "lax"` for cross-site navigation
5. **Use Bun.secrets** for production secrets (with Bun.env fallback)

---

## Related Documentation

- [10.0.0.0.0.0.0-AUTHENTICATION-SESSION-MANAGEMENT.md](./10.0.0.0.0.0.0-AUTHENTICATION-SESSION-MANAGEMENT.md) - Main documentation
- [10.1-IMPLEMENTATION-GUIDE.md](./10.1-IMPLEMENTATION-GUIDE.md) - Implementation guide
- [10.2-MIDDLEWARE-GUIDE.md](./10.2-MIDDLEWARE-GUIDE.md) - Middleware guide
- [BUN-1.3-QUICK-REFERENCE.md](./BUN-1.3-QUICK-REFERENCE.md) - Quick reference

---

**Status**: ✅ Examples Complete  
**Next Steps**: Run examples and integrate into your application
