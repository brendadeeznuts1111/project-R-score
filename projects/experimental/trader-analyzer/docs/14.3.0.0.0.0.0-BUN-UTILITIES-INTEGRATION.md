# **[INTEGRATION] Hyper-Bun v1.3.3: Advanced Bun Utilities for Debugging, Observability & UI Interaction**

**Metadata**: `[[TECH][MODULE][INTEGRATION][META:{blueprint=BP-BUN-UTILITIES-INTEGRATION@1.3.3;instance-id=BUN-UTILITIES-INTEGRATION-001;version=1.3.3}][PROPERTIES:{integration={value:"bun-inspect-deep-dive";@root:"14.0.0.0.0.0.0";@chain:["BP-MLGS-DEBUGGING","BP-BUN-API"];@version:"1.3.3"}}][CLASS:BunUtilitiesIntegration][#REF:v-1.3.3.BP.BUN.UTILITIES.INTEGRATION.1.0.A.1.1.DOC.1.1]]`

---

### **14.0.0.0.0.0.0 Advanced MLGS Interactive Debugging & Observability**

This subsystem focuses on providing richer, real-time insights and control for developers and SREs within the `tmux` terminal environment and integrated web UIs.

---

#### **14.3.0.0.0.0.0 Interactive Data Exploration & Filtering**

---

##### **14.3.3.0.0.0.0 `Bun.inspect` for Deep Object Inspection**

*   **Mechanism**: `Bun.inspect` provides a powerful way to get a string representation of JavaScript objects, similar to `util.inspect` in Node.js. It's particularly useful for debugging complex data structures like `CmmsState` or `ShadowMovementGraph` nodes.
*   **Benefit**: In `bun-console.ts`, `console.log(Bun.inspect(mlgs.currentCmmsState))` can give a detailed, multi-line view of a CMMS object, crucial for understanding its current state without polluting the REPL with unreadable `[Object]` placeholders.
*   **Integration**: Used extensively in `bun-console.ts` REPL environment and `HyperBunLogger.debug()` calls for market intelligence structures.
*   **Direct Example**:
    ```typescript
    // In bun-console.ts or any debug context
    const arr = new Uint8Array([1, 2, 3]);
    const str = Bun.inspect(arr);
    console.log(str); // => "Uint8Array(3) [ 1, 2, 3 ]"

    // Hyper-Bun use case: Inspecting a complex CMMS state
    const complexCmms: CmmsState = await mlgs.cmmsAnalyzer.getCmmsState('dk-nfl-spread-47.5');
    console.log(Bun.inspect(complexCmms, { depth: 3, colors: true, sorted: true }));
    // Provides a colorized, deeply inspected, alphabetically sorted view of the CMMS object.
    ```
*   **`@example` Formula**: Inspect a `CmmsState` object and verify its top-level properties are visible.
    *   **Test Formula**: `const cmms = await mlgs.cmmsAnalyzer.computeCmmsState('dk-nfl-spread-47.5', 60000); const inspected = Bun.inspect(cmms, { depth: 1 });`
    *   **Expected Result**: `inspected` string contains `CmmsState { nodeId: 'dk-nfl-spread-47.5', timestamp: ..., tickMetrics: {...}, ... }`.

---

##### **14.3.4.0.0.0.0 `Bun.inspect.custom` for Tailored Console Output**

*   **Mechanism**: Developers can override the `[Bun.inspect.custom]` symbol on any class instance to customize its string representation when `Bun.inspect` (or `console.log`) is called. This is identical to `util.inspect.custom` in Node.js.
*   **Benefit**: Allows Hyper-Bun's custom classes (e.g., `MarketDataRouter17`, `CorrelationEngine17`, `CmmsAnalyzer17`, `NexusError`) to provide highly concise and domain-specific console output, preventing information overload during debugging and respecting `--console-depth` settings.
*   **Integration**: 
    *   `MarketDataRouter17` implements this for `BUN_IMPEC_DEBUG_ROUTING` (`6.1.1.2.2.8.1.1.2.7.2.1`)
    *   `NexusError` provides error code highlighting (`6.1.1.2.2.8.1.1.2.6`)
    *   `CorrelationEngine17` uses advanced formatting (`6.1.1.2.2.8.1.1.2.8.2`)
*   **Direct Example**:
    ```typescript
    // In a custom class definition (e.g., NexusError)
    class NexusError extends Error {
      code: string;
      // ... constructor ...
      [Bun.inspect.custom](depth: number, options: any) {
        if (depth < 0) return '[NexusError]'; // Concise when truncated
        return `[NexusError:${this.code}] ${this.message}`;
      }
    }

    const error = new NexusError('NX-MCP-404', 'Resource not found');
    console.error(error); // => "[NexusError:NX-MCP-404] Resource not found"
    
    // Hyper-Bun domain class example
    class MarketOfferingNode {
      nodeId: string;
      bookmaker: string;
      riskLevel: number;
      [Bun.inspect.custom](depth: number) {
        if (depth < 0) return `[MarketOfferingNode:${this.nodeId}]`;
        return `MarketOfferingNode {
  nodeId: "${this.nodeId}",
  bookmaker: "${this.bookmaker}",
  riskLevel: ${this.riskLevel}
}`;
      }
    }
    ```
*   **`@example` Formula**: Verify custom `NexusError` output respects depth truncation.
    *   **Test Formula**: `const err = new NexusError('NX-MCP-500', 'Calculation failed'); const shallow = Bun.inspect(err, { depth: 0 }); const deep = Bun.inspect(err);`
    *   **Expected Result**: `shallow` is `"[NexusError]"` and `deep` is `"[NexusError:NX-MCP-500] Calculation failed"`.

---

##### **14.3.5.0.0.0.0 `Bun.inspect.table(tabularData, properties, options)` for Structured Console Tables**

*   **Mechanism**: Formats arrays of objects (`tabularData`) into a clean, ASCII-rendered table string, similar to `console.table`. Supports selecting a subset of `properties` and enabling ANSI colors for enhanced readability.
*   **Benefit**: Indispensable for presenting structured data (e.g., lists of `CmmsStateEvent`s, `CorrelationPair`s, `CircuitBreakerStatus` for all bookmakers) directly in the `bun-console.ts` REPL. It provides immediate, organized views of complex data without needing a separate UI or manual formatting.
*   **Integration**: 
    *   Used in `mlgs.mcp.inspectErrors()` for error reporting (`6.1.1.2.2.8.1.1.2.6.3`)
    *   Powers `breaker.statusAll()` circuit breaker dashboards (`12.4.3.0.0.0.0`)
    *   Core tool for `HyperBunLogger.performance()` metrics display
*   **Direct Example**:
    ```typescript
    // In bun-console.ts (for displaying recent CMMS anomalies)
    const recentAnomalies: CmmsStateEvent[] = await mlgs.cmmsAnalyzer.getRecentCmmsEvents(10);
    console.log(
      Bun.inspect.table(
        recentAnomalies.map(e => ({
          nodeId: e.cmms.nodeId,
          riskScore: e.cmms.riskScore,
          type: e.type,
          summary: e.change_summary
        })),
        ['nodeId', 'riskScore', 'type', 'summary'],
        { colors: true } // Enable ANSI colors for severity
      )
    );
    // Renders as:
    // ┌─────────┬──────────────┬──────────┬─────────────────────────────────────┐
    // │ nodeId  │ riskScore    │ type     │ summary                             │
    // ├─────────┼──────────────┼──────────┼─────────────────────────────────────┤
    // │ dk-...  │ 7.8          │ ANOMALY  │ Line movement exceeds threshold...  │
    // │ fd-...  │ 3.2          │ NORMAL   │ Within expected parameters          │
    // └─────────┴──────────────┴──────────┴─────────────────────────────────────┘
    ```
*   **`@example` Formula**: Display `CircuitBreakerStatus` for multiple bookmakers in a table.
    *   **Test Formula**: `const statuses = await mlgs.circuitBreaker.statusAll(); const tableOutput = Bun.inspect.table(statuses, ['bookmaker', 'tripped', 'failureCount'], { colors: true });`
    *   **Expected Result**: `tableOutput` string contains `┌───┬─────────────┬─────────┬──────────────┐` and correctly formatted data for each bookmaker with colorized `tripped` status.

---

#### **14.3.6.0.0.0.0 Client-Side UI Interaction in TMUX Environment**

This snippet demonstrates basic client-side JavaScript for interacting with a web-based UI, typically rendered within a `tmux` window (e.g., the `Analytics window` or `Research window` displaying a Hyper-Bun dashboard).

*   **Mechanism**: Direct DOM manipulation within a dashboard interface, consuming `window.HYPERBUN_UI_CONTEXT` and other global APIs. The code activates a specific tab based on team name matching.
*   **Benefit**: Enables interactive navigation of multi-team dashboards without page reloads, maintaining the "tmux is the OS, CSS is the GUI standard" philosophy. Provides zero-latency UI state changes synchronized with backend MLGS data.
*   **Integration**:
    *   Consumes `window.HYPERBUN_UI_CONTEXT` populated by `UIContextRewriter` (`8.0.0.0.0.0.0`)
    *   Activates tabs styled by `.team-tab.active` CSS class (`2.1.2.0.0.0.0`)
    *   Works within `tmux` dashboard panels (`17.3.1.0.0.0.0 Multi-Panel Terminal Dashboards`)
*   **Direct Example**:
    ```typescript
    // In a dashboard's inline <script> tag or bundled JS
    // window.HYPERBUN_UI_CONTEXT is injected by UIContextRewriter
    
    function activateTeamTab(teamName: string) {
      const tabs = document.querySelectorAll('.team-tab');
      const targetIndex = Array.from(tabs).findIndex(t => 
        t.textContent?.toLowerCase().includes(teamName.toLowerCase())
      );
      
      if (targetIndex !== -1 && tabs[targetIndex + 1]) {
        // Activate adjacent tab (e.g., data view tab)
        tabs[targetIndex + 1].classList.add('active');
        
        // Trigger RSS feed update for the team
        const teamId = window.HYPERBUN_UI_CONTEXT.teams.find(
          t => t.name.toLowerCase().includes(teamName)
        )?.id;
        
        if (teamId && window.HYPERBUN_RSS_BRIDGE) {
          window.HYPERBUN_RSS_BRIDGE.queryTeamFeed(teamId);
        }
      }
    }
    
    // Usage: activateTeamTab('lakers'); // Activates Lakers data tab
    ```
*   **Integration with Design System (`17.0.0.0.0.0.0`)**:
    *   Active tab uses `17.1.2.5.0.0.0.0 Brand & UI Accent Pattern` (cyan gradient)
    *   Inactive tabs use `17.2.2.0.0.0.0` dark mode variables
    *   Tab switching triggers `17.2.5.0.0.0.0` CSS transitions
*   **`@example` Formula**: Simulate a user clicking a tab in a UI to filter by team.
    *   **Test Formula (Playwright/Puppeteer in tmux context)**: 
    ```typescript
    await page.goto('http://localhost:3000/dashboard/integrated');
    await page.evaluate((team) => {
      window.HYPERBUN_UI_CONTEXT = { teams: [{id: 'nba', name: 'NBA'}] };
      const tabs = document.querySelectorAll('.team-tab');
      tabs[Array.from(tabs).findIndex(t => t.textContent.toLowerCase().includes(team)) + 1].classList.add('active');
    }, 'nba');
    const activeTab = await page.$('.team-tab.active');
    ```
    *   **Expected Result**: `activeTab` element exists, `page.content()` contains `class="team-tab active"`, and RSS feed panel shows NBA team data.

---

### **Summary: Reinforcing Hyper-Bun's Observable Architecture**

These Bun utilities (`Bun.inspect`, `Bun.inspect.custom`, `Bun.inspect.table`) are not mere debugging aids—they are **first-class observability primitives** deeply woven into Hyper-Bun's philosophy:

1.  **`tmux`-First Debugging**: All utilities output readable, colorized text optimized for terminal REPLs (`bun-console.ts`), not just browser consoles.
2.  **Domain-Specific Clarity**: `inspect.custom` allows market intelligence objects (`MarketOfferingNode`, `CmmsState`) to present themselves intelligently, accelerating SRE diagnosis.
3.  **Zero-Overhead Observability**: `inspect.table` replaces ad-hoc formatting logic, reducing code footprint while improving debuggability.
4.  **Unified GUI Standard**: Client-side UI interactions respect the same CSS classes (`2.1.2.0`, `2.3.1.0`) and design tokens (`17.0.0.0`) as the backend-driven HTML, ensuring consistency across tmux panes and web dashboards.

**This integration solidifies that Hyper-Bun leverages Bun's powerful developer utilities to build highly observable and debuggable systems, both in the backend logic and in the interactive client-side UIs, all orchestrated within the tmux-as-OS paradigm.**

---

## Implementation Files

- `src/errors/index.ts` - `NexusError` with `Bun.inspect.custom`
- `src/api/routes/17.16.7-market-patterns.ts` - `MarketDataRouter17` with `Bun.inspect.custom`
- `scripts/bun-console.ts` - REPL with `Bun.inspect.table` examples
- `dashboard/index.html` - Client-side UI interaction examples

---

## Related Documentation

- [`docs/7.0.0.0.0.0.0-CONSOLE-DEPTH-DEBUGGING.md`](./7.0.0.0.0.0.0.0-CONSOLE-DEPTH-DEBUGGING.md) - Console depth configuration
- [`docs/11.0.0.0.0.0.0-TERMINAL-ENVIRONMENT.md`](./11.0.0.0.0.0.0.0-TERMINAL-ENVIRONMENT.md) - Terminal environment setup
- [`docs/bun/BUN-UTILS.md`](./bun/BUN-UTILS.md) - Bun utilities reference
