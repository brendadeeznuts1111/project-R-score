# ğŸ”¥ Fantasy42-Fire22 Security-First CI/CD Pipeline
# Implements Principle of Least Privilege with Scoped Registry Tokens

name: Security CI/CD Pipeline

on:
  push:
    branches: ['main', 'develop', 'enterprise']
  pull_request:
    branches: ['main', 'develop', 'enterprise']
  release:
    types: [published]

env:
  BUN_VERSION: '1.0.0'
  NODE_ENV: test

jobs:
  # ==========================================
  # READ-ONLY TOKEN: Package Installation
  # ==========================================
  install-dependencies:
    name: ğŸ“¦ Install Dependencies (Read-Only Token)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/bun-action@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Configure npm registry (Read-Only)
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.FIRE22_REGISTRY_TOKEN }}" >> ~/.npmrc
          echo "@fire22:registry=https://registry.npmjs.org/" >> ~/.npmrc
          echo "@fantasy42:registry=https://registry.npmjs.org/" >> ~/.npmrc

      - name: Install dependencies with scoped read token
        run: |
          echo "ğŸ” Using READ-ONLY token for package installation"
          echo "ğŸ“¦ User Agent: $(bun --version)"
          bun install --frozen-lockfile

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.bun
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}

  # ==========================================
  # QUALITY ASSURANCE
  # ==========================================
  quality-assurance:
    name: ğŸ§ª Quality Assurance
    runs-on: ubuntu-latest
    needs: install-dependencies
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/bun-action@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Load cached dependencies
        uses: actions/cache@v3
        with:
          path: ~/.bun
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}

      - name: Security audit with user agent tracking
        run: |
          echo "ğŸ” Security audit with user agent: $(bun --version)"
          bun run security:audit

      - name: Lint and format check
        run: |
          echo "ğŸ” Code quality check"
          bun run lint
          bun run format:check

      - name: TypeScript compilation
        run: |
          echo "ğŸ”§ TypeScript compilation check"
          bun run typecheck

  # ==========================================
  # DOMAIN TESTING
  # ==========================================
  domain-testing:
    name: ğŸ—ï¸ Domain Testing
    runs-on: ubuntu-latest
    needs: quality-assurance
    strategy:
      matrix:
        domain: [core, users, betting, gaming, finance, security, analytics]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/bun-action@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Run domain-specific tests
        run: |
          echo "ğŸ§ª Testing domain: ${{ matrix.domain }}"
          echo "ğŸ¤– User Agent: $(bun --version)"
          bun run test:domain ${{ matrix.domain }}

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results-${{ matrix.domain }}
          path: test-results/

  # ==========================================
  # PUBLISH TOKEN: Package Publishing
  # ==========================================
  publish-packages:
    name: ğŸš€ Publish Packages (Publish-Only Token)
    runs-on: ubuntu-latest
    needs: [quality-assurance, domain-testing]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/bun-action@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Configure npm registry (Publish-Only)
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.FIRE22_PUBLISH_TOKEN }}" >> ~/.npmrc
          echo "@fire22:registry=https://registry.npmjs.org/" >> ~/.npmrc
          echo "@fantasy42:registry=https://registry.npmjs.org/" >> ~/.npmrc

      - name: Build enterprise packages
        run: |
          echo "ğŸ—ï¸ Building enterprise packages"
          bun run enterprise:build

      - name: Publish with scoped publish token
        run: |
          echo "ğŸš€ Publishing with PUBLISH-ONLY token"
          echo "ğŸ“¦ User Agent: $(bun --version)"
          bun run enterprise:publish

      - name: Create deployment notification
        run: |
          echo "ğŸ“¢ Package published successfully"
          echo "ğŸ” Used scoped publish token with minimal privileges"
          echo "ğŸ“Š User agent logged for audit trail"

  # ==========================================
  # SECURITY MONITORING
  # ==========================================
  security-monitoring:
    name: ğŸ” Security Monitoring
    runs-on: ubuntu-latest
    needs: publish-packages
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Security audit with user agent tracking
        run: |
          echo "ğŸ” Final security audit"
          echo "ğŸ¤– User Agent: $(bun --version)"
          bun run security:audit:final

      - name: Dependency vulnerability check
        run: |
          echo "ğŸ›¡ï¸ Checking for vulnerabilities"
          bun run security:vulnerability-check

      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-report-${{ github.sha }}
          path: security-reports/
          retention-days: 90

  # ==========================================
  # DEPLOYMENT WITH TOKEN ROTATION
  # ==========================================
  deploy-production:
    name: ğŸ¯ Deploy to Production
    runs-on: ubuntu-latest
    needs: [publish-packages, security-monitoring]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: Configure deployment tokens
        run: |
          echo "ğŸ”‘ Configuring deployment tokens"
          echo "FIRE22_DEPLOY_TOKEN=${{ secrets.FIRE22_DEPLOY_TOKEN }}" >> $GITHUB_ENV

      - name: Deploy with scoped deployment token
        run: |
          echo "ğŸš€ Deploying to production"
          echo "ğŸ” Using DEPLOYMENT-ONLY token"
          bun run enterprise:deploy:production

      - name: Post-deployment verification
        run: |
          echo "âœ… Post-deployment health checks"
          bun run enterprise:verify:deployment

      - name: Token cleanup notification
        run: |
          echo "ğŸ§¹ Token rotation completed"
          echo "ğŸ”„ Scoped tokens rotated for security"
