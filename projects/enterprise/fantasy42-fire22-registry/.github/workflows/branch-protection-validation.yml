# ğŸ”¥ Fantasy42-Fire22 Branch Protection Validation
name: Branch Protection Validation

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

jobs:
  validate-branch-protection:
    name: ğŸ”’ Validate Branch Protection Rules
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/bun-action@v1
        with:
          bun-version: '1.0.0'

      - name: Validate branch naming convention
        run: |
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          echo "ğŸ” Validating branch: $BRANCH_NAME"

          # Validate branch naming patterns
          if [[ ! $BRANCH_NAME =~ ^(main|develop|staging|enterprise|feature/|pkg/|hotfix/|release/) ]]; then
            echo "âŒ Invalid branch name: $BRANCH_NAME"
            echo "ğŸ“‹ Valid patterns:"
            echo "  - main, develop, staging, enterprise"
            echo "  - feature/<domain>-<description>"
            echo "  - pkg/<package>-<description>"
            echo "  - hotfix/<issue>-<description>"
            echo "  - release/v1.2.3"
            exit 1
          fi

          # Extract domain for domain-specific validation
          if [[ $BRANCH_NAME =~ ^feature/([^/]+)- ]]; then
            DOMAIN="${BASH_REMATCH[1]}"
            echo "ğŸ·ï¸ Feature branch for domain: $DOMAIN"
          elif [[ $BRANCH_NAME =~ ^pkg/([^/]+)- ]]; then
            PACKAGE="${BASH_REMATCH[1]}"
            echo "ğŸ“¦ Package branch for: $PACKAGE"
          fi

          echo "âœ… Branch name validated: $BRANCH_NAME"

      - name: Validate CODEOWNERS requirements
        run: |
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          echo "ğŸ‘¥ Checking CODEOWNERS requirements for: $BRANCH_NAME"

          # Check if branch requires CODEOWNERS approval
          if [[ $BRANCH_NAME =~ ^(main|develop|enterprise|feature/(security|finance|betting|compliance)) ]]; then
            echo "ğŸ” This branch requires CODEOWNERS approval"
            # Additional CODEOWNERS validation could be added here
          else
            echo "âœ… Branch does not require CODEOWNERS approval"
          fi

  domain-validation:
    name: ğŸ—ï¸ Domain-Specific Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/bun-action@v1
        with:
          bun-version: '1.0.0'

      - name: Detect domain and validate requirements
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "ğŸ” Analyzing branch for domain requirements: $BRANCH_NAME"

          # Extract domain from branch name
          if [[ $BRANCH_NAME =~ ^feature/([^/]+)- ]]; then
            DOMAIN="${BASH_REMATCH[1]}"
            echo "ğŸ·ï¸ Domain detected: $DOMAIN"

            # Domain-specific validation
            case $DOMAIN in
              security|compliance|finance|betting)
                echo "ğŸ” High-security domain detected"
                echo "ğŸ“‹ Requirements:"
                echo "  - Security team approval required"
                echo "  - Compliance audit required"
                echo "  - Enhanced testing required"
                ;;
              users|communication|content)
                echo "ğŸ”’ Medium-security domain detected"
                echo "ğŸ“‹ Requirements:"
                echo "  - Domain team approval required"
                echo "  - Standard testing required"
                ;;
              *)
                echo "âœ… Standard domain detected"
                echo "ğŸ“‹ Requirements:"
                echo "  - Basic approval required"
                ;;
            esac
          fi

      - name: Validate domain-specific files
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "ğŸ“ Checking for domain-specific file changes"

          # Check if relevant domain files were modified
          if [[ $BRANCH_NAME =~ ^feature/([^/]+)- ]]; then
            DOMAIN="${BASH_REMATCH[1]}"
            echo "ğŸ” Looking for changes in src/domains/$DOMAIN/"

            if git diff --name-only HEAD~1 | grep -q "src/domains/$DOMAIN/"; then
              echo "âœ… Domain-specific files modified"
            else
              echo "âš ï¸ No domain-specific files modified - please verify branch purpose"
            fi
          fi
