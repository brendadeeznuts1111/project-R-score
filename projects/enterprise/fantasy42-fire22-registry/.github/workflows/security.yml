# ğŸ” Enterprise Security Pipeline
# Consolidated security scanning and compliance validation

name: ğŸ” Security Pipeline

on:
  push:
    branches: [main, develop, enterprise, staging]
  pull_request:
    branches: [main, develop, enterprise, staging]
  schedule:
    - cron: '0 2 * * 1' # Weekly security scan
  workflow_dispatch:

env:
  BUN_VERSION: '1.0.0'

jobs:
  # ğŸ” Security Scanning
  security-scan:
    name: ğŸ” Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Run security audit
        run: |
          echo "ğŸ” Running comprehensive security audit"
          bun run audit

      - name: CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Dependency Review
        uses: actions/dependency-review-action@v3

      - name: Security linting
        run: |
          echo "ğŸ” Running security-focused linting"
          bun run lint:security

      - name: Upload security results
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-results
          path: |
            security-reports/
            audit-results.json
          retention-days: 30

  # ğŸ“‹ Compliance Validation
  compliance-check:
    name: ğŸ“‹ Compliance Check
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: GDPR Compliance Check
        run: |
          echo "ğŸ‡ªğŸ‡º Checking GDPR compliance"
          bun run compliance:gdpr

      - name: PCI DSS Compliance Check
        run: |
          echo "ğŸ’³ Checking PCI DSS compliance"
          bun run compliance:pci

      - name: AML/KYC Compliance Check
        run: |
          echo "ğŸ’° Checking AML/KYC compliance"
          bun run compliance:aml

      - name: Responsible Gambling Check
        run: |
          echo "ğŸ® Checking responsible gambling compliance"
          bun run compliance:gambling

      - name: Generate compliance report
        run: |
          echo "ğŸ“‹ Generating compliance report"
          bun run compliance:report

      - name: Upload compliance results
        uses: actions/upload-artifact@v3
        with:
          name: compliance-report
          path: compliance-report.json
          retention-days: 90

  # ğŸš¨ Vulnerability Assessment
  vulnerability-assessment:
    name: ğŸš¨ Vulnerability Assessment
    runs-on: ubuntu-latest
    needs: [security-scan, compliance-check]
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: SAST (Static Application Security Testing)
        run: |
          echo "ğŸ”¬ Running Static Application Security Testing"
          bun run security:sast

      - name: Container Security Scan
        run: |
          echo "ğŸ³ Scanning container security"
          bun run security:container

      - name: Infrastructure as Code Security
        run: |
          echo "ğŸ—ï¸ Checking Infrastructure as Code security"
          bun run security:iac

      - name: Secret Detection
        run: |
          echo "ğŸ”‘ Scanning for secrets"
          bun run security:secrets

      - name: Generate vulnerability report
        run: |
          echo "ğŸ“Š Generating vulnerability assessment report"
          bun run security:vulnerability:report

      - name: Upload vulnerability assessment
        uses: actions/upload-artifact@v3
        with:
          name: vulnerability-assessment
          path: |
            vulnerability-report.json
            security-assessment.pdf
          retention-days: 90

  # ğŸ“Š Security Monitoring & Alerting
  security-monitoring:
    name: ğŸ“Š Security Monitoring
    runs-on: ubuntu-latest
    needs: vulnerability-assessment
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Update security dashboard
        run: |
          echo "ğŸ“ˆ Updating security dashboard"
          bun run security:dashboard:update

      - name: Check security thresholds
        run: |
          echo "âš–ï¸ Checking security thresholds"
          bun run security:thresholds:check

      - name: Send security alerts
        run: |
          echo "ğŸš¨ Sending security alerts if needed"
          bun run security:alerts:send

      - name: Archive security metrics
        run: |
          echo "ğŸ“š Archiving security metrics"
          bun run security:metrics:archive

  # ğŸ”„ Security Policy Updates
  security-policy-update:
    name: ğŸ”„ Security Policy Update
    runs-on: ubuntu-latest
    needs: [security-scan, compliance-check, vulnerability-assessment]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Update security policies
        run: |
          echo "ğŸ“‹ Updating security policies"
          bun run security:policy:update

      - name: Update dependency security advisories
        run: |
          echo "ğŸ”§ Updating dependency security advisories"
          bun run security:advisories:update

      - name: Commit security policy updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "ğŸ” chore: Update security policies and advisories" || echo "No changes to commit"
