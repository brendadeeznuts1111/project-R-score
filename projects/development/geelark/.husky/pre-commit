#!/bin/sh
# pre-commit hook for naming standards enforcement
# Validates constant naming conventions before commits

set -e

echo "üîç Running naming standards pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

FAILED=0

# Check for camelCase exported constants (should be UPPER_SNAKE_CASE)
echo "üìã Scanning for non-compliant constant names..."

# Find all TypeScript files with staged changes
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "${GREEN}‚úì No TypeScript files staged${NC}"
  exit 0
fi

# Pattern to detect exported constants
PATTERN='export\s+const\s+[a-z][a-zA-Z0-9]*\s*='

for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    # Check for camelCase exported constants
    if grep -E "$PATTERN" "$file" > /dev/null 2>&1; then
      echo "${YELLOW}‚Ñπ Checking $file for constant naming issues...${NC}"
      
      # Get violating lines
      VIOLATIONS=$(grep -nE "$PATTERN" "$file" || true)
      
      if [ ! -z "$VIOLATIONS" ]; then
        # Exclude known safe patterns (test utilities, functional exports)
        FILTERED=$(echo "$VIOLATIONS" | grep -vE "(test|mock|example|fixtures|helpers)" || true)
        
        if [ ! -z "$FILTERED" ]; then
          echo "${RED}‚úó Found potential camelCase constants in $file:${NC}"
          echo "$FILTERED"
          echo "${YELLOW}  ‚Üí Constants should use UPPER_SNAKE_CASE${NC}"
          echo "${YELLOW}  ‚Üí Run: npm run fix:constants${NC}"
          FAILED=1
        fi
      fi
    fi
  fi
done

# Run ESLint on staged files if available
if command -v eslint &> /dev/null; then
  echo ""
  echo "üîß Running ESLint naming convention checks..."
  
  LINT_FAILED=0
  for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
      if ! eslint "$file" --rule "@typescript-eslint/naming-convention: error" 2>/dev/null; then
        LINT_FAILED=1
      fi
    fi
  done
  
  if [ $LINT_FAILED -eq 1 ]; then
    echo "${YELLOW}‚ö† ESLint found naming issues. Run: npm run lint:fix${NC}"
    FAILED=1
  fi
fi

# Summary
echo ""
if [ $FAILED -eq 1 ]; then
  echo "${RED}‚ùå Pre-commit checks failed${NC}"
  echo ""
  echo "Fix options:"
  echo "  1. Rename constants to UPPER_SNAKE_CASE"
  echo "  2. Run: npm run lint:fix"
  echo "  3. Review: NAMING_STANDARDS.md"
  echo "  4. Bypass (not recommended): git commit --no-verify"
  echo ""
  exit 1
else
  echo "${GREEN}‚úì All naming standards checks passed!${NC}"
  exit 0
fi
