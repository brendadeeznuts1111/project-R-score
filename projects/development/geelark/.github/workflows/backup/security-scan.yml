name: Security Scanning
on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  snyk-security-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.3'

      - name: Install dependencies
        run: bun install

      - name: Snyk vulnerability scan
        if: env.SNYK_TOKEN
        uses: snyk/actions/setup@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --fail-on=upgradable

      - name: Run Snyk test
        if: env.SNYK_TOKEN
        run: |
          bunx snyk test --severity-threshold=high --json > snyk-report.json || true
          echo "Snyk scan completed"

      - name: Upload Snyk report
        if: env.SNYK_TOKEN
        uses: actions/upload-artifact@v3
        with:
          name: snyk-security-report
          path: snyk-report.json
          retention-days: 30

  dependency-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.3'

      - name: Install dependencies
        run: bun install

      - name: Audit dependencies
        run: |
          echo "Running dependency audit..."
          bun audit
          echo "Dependency audit completed"

      - name: Check for outdated dependencies
        run: |
          echo "Checking for outdated dependencies..."
          bun outdated || true
          echo "Outdated dependency check completed"

  code-quality-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.3'

      - name: Install dependencies
        run: bun install

      - name: Run TypeScript type checking
        run: bun x tsc --noEmit --strict

      - name: Run ESLint
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f ".eslintrc" ]; then
            bunx eslint src/ --ext .ts,.tsx --max-warnings=0
          else
            echo "No ESLint configuration found, skipping ESLint"
          fi

      - name: Check for code smells
        run: |
          echo "Running code quality checks..."
          # Check for TODO comments
          grep -r "TODO\|FIXME\|HACK\|XXX" src/ tests/ || true
          echo "Code quality checks completed"

  secret-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Detect secrets
        uses: trufflesecurity/trufflehog@latest
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || github.sha }}
          head: ${{ github.event.pull_request.head.sha || github.sha }}
          extra_args: --only-verified

  container-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build container image
        run: |
          docker build -f .devcontainer/Dockerfile -t geelark-security-scan .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'geelark-security-scan'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: actions/upload-artifact@v3
        with:
          name: trivy-container-scan
          path: trivy-results.sarif
          retention-days: 90

  license-compliance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2.3'

      - name: Install license checker
        run: npm install -g license-checker

      - name: Check licenses
        run: |
          echo "Checking dependency licenses..."
          license-checker --summary --onlyAllow "MIT;ISC;Apache-2.0;BSD-2-Clause;BSD-3-Clause" || true
          echo "License check completed"

  security-report:
    runs-on: ubuntu-latest
    needs: [snyk-security-scan, dependency-audit, code-quality-scan, secret-scan, container-scan, license-compliance]
    if: always()

    steps:
      - name: Generate security report
        run: |
          echo "# ðŸ”’ Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Snyk Vulnerability Scan | ${{ needs.snyk-security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality Scan | ${{ needs.code-quality-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Detection | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Security Scan | ${{ needs.container-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Compliance | ${{ needs.license-compliance.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All security scans have completed. Review any findings above." >> $GITHUB_STEP_SUMMARY

      - name: Send security alert
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_TITLE: "Security Scan Failure"
          SLACK_MESSAGE: "Security scan failed in ${{ github.repository }}"
          SLACK_COLOR: "danger"
          SLACK_FOOTER: "Review security report for details"
