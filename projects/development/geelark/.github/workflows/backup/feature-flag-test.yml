name: Feature Flag Testing
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      flags:
        description: 'Feature flags to test (comma separated)'
        required: false
        default: 'all'

jobs:
  feature-flag-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build-type: [dev, prod-lite, prod-standard, prod-premium, test, audit]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 'latest'

      - name: Install dependencies
        run: bun install

      - name: Run build for ${{ matrix.build-type }}
        run: |
          echo "Running build: ${{ matrix.build-type }}"
          bun run build:${{ matrix.build-type }}
          echo "Build completed successfully"

      - name: Run feature elimination tests
        run: |
          echo "Running feature flag elimination tests..."
          bun test tests/feature-elimination.test.ts
          echo "Feature elimination tests passed!"

      - name: Verify bundle sizes
        run: |
          echo "Verifying bundle sizes for ${{ matrix.build-type }}..."
          ls -lh dist/${{ matrix.build-type }}/
          echo "Bundle size verification complete"

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bundle-${{ matrix.build-type }}
          path: dist/${{ matrix.build-type }}/
          retention-days: 7

  security-scan:
    runs-on: ubuntu-latest
    needs: [feature-flag-tests]
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 'latest'

      - name: Install dependencies
        run: bun install

      - name: Security scan with Snyk
        if: env.SNYK_TOKEN
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --fail-on=upgradable

      - name: Run security tests
        run: |
          echo "Running security-focused tests..."
          bun test tests/security.test.ts --test-name-pattern="security"
          echo "Security tests completed"

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || github.sha }}
          head: ${{ github.event.pull_request.head.sha || github.sha }}

  type-safety:
    runs-on: ubuntu-latest
    needs: [feature-flag-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 'latest'

      - name: Install dependencies
        run: bun install

      - name: Type checking
        run: bun x tsc --noEmit --strict

      - name: Run type tests
        run: |
          echo "Running type safety tests..."
          bun test tests/type-testing.test.ts
          bun test tests/advanced-expectTypeOf.test.ts
          echo "Type safety tests passed!"

  performance-benchmarks:
    runs-on: ubuntu-latest
    needs: [feature-flag-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 'latest'

      - name: Install dependencies
        run: bun install

      - name: Run performance benchmarks
        run: |
          echo "Running performance benchmarks..."
          bun test bench/ --test-name-pattern="bench"
          echo "Performance benchmarks completed"

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            bench/results/
            bench/*.json
          retention-days: 30

  integration-tests:
    runs-on: ubuntu-latest
    needs: [feature-flag-tests, security-scan, type-safety]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 'latest'

      - name: Install dependencies
        run: bun install

      - name: Start dev-hq server
        run: |
          echo "Starting dev-hq automation server..."
          bun run dev-hq server &
          SERVER_PID=$!
          sleep 5
          echo "Server started with PID: $SERVER_PID"

      - name: Run integration tests
        run: |
          echo "Running integration tests..."
          bun test tests/server.test.ts tests/api-fixes.test.ts
          echo "Integration tests completed"

      - name: Stop dev-hq server
        if: always()
        run: |
          kill $SERVER_PID 2>/dev/null || true
          echo "Server stopped"

  notify:
    runs-on: ubuntu-latest
    needs: [feature-flag-tests, security-scan, type-safety, performance-benchmarks, integration-tests]
    if: always()

    steps:
      - name: Aggregate test results
        if: always()
        run: |
          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Feature Flag Tests | ${{ needs.feature-flag-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Safety | ${{ needs.type-safety.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Benchmarks | ${{ needs.performance-benchmarks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Send notification
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_TITLE: "Feature Flag Test Failure"
          SLACK_MESSAGE: "Feature flag tests failed in ${{ github.repository }}"
          SLACK_COLOR: "danger"
