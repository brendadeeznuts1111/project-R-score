#!/bin/bash

# [SECURITY][GIT][HOOK][META:{VERSION:1.0.0}][#REF:table-enforcement]{BUN-NATIVE}
# Pre-commit hook for table enforcement validation
# Prevents commits with table enforcement violations

set -e

echo "üè• Running table enforcement validation..."

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ No TypeScript files to validate"
  exit 0
fi

# Check if we're in the bun-inspect-utils directory
if [ ! -f "bun-inspect-utils/package.json" ]; then
  echo "‚ö†Ô∏è  bun-inspect-utils not found, skipping validation"
  exit 0
fi

cd bun-inspect-utils

# Run table-doctor analysis on staged files
echo "üìä Analyzing staged files..."

VIOLATIONS=0

for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    # Check for table calls without properties
    if grep -E "(table|tableMarkdown|tableCsv)\s*\(" "$file" | grep -v "\[" | grep -v "properties" > /dev/null; then
      echo "‚ö†Ô∏è  $file: Found table call without properties array"
      VIOLATIONS=$((VIOLATIONS + 1))
    fi
  fi
done

if [ $VIOLATIONS -gt 0 ]; then
  echo ""
  echo "‚ùå Table enforcement validation failed!"
  echo "   Found $VIOLATIONS file(s) with potential violations"
  echo ""
  echo "üí° To fix:"
  echo "   1. Run: bun table-doctor --analyze"
  echo "   2. Add properties array with 6+ meaningful columns"
  echo "   3. Or use: skipValidation: true (if intentional)"
  echo ""
  echo "To skip this check, use: git commit --no-verify"
  exit 1
fi

echo "‚úÖ Table enforcement validation passed!"
exit 0

