name: Matrix Analysis CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-typecheck:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Type check
        run: bun run typecheck

  test:
    name: Test (${{ matrix.os }})
    needs: lint-typecheck
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        bun-version: ["1.3.6", "latest"]
        exclude:
          # Only test latest on Windows to save CI minutes
          - os: windows-latest
            bun-version: "1.3.6"

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ matrix.bun-version }}

      - name: Bun version
        run: bun --version

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run tests
        run: bun test

      - name: Run matrix analysis (Unix)
        if: runner.os != 'Windows'
        run: |
          bun run ~/.claude/scripts/test-matrix.ts . --json > /dev/null || true
          echo "Matrix analysis completed on ${{ matrix.os }}"

      - name: Run matrix analysis (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          bun run $env:USERPROFILE\.claude\scripts\lockfile-matrix.ts . --json | Out-Null
          Write-Host "Matrix analysis completed on Windows"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run security audit
        run: bun pm audit || true

      - name: Check for secrets
        run: |
          # Scan for common secret patterns
          if grep -rE "(AKIA|ghp_|sk_live_|-----BEGIN PRIVATE KEY-----)" --include="*.ts" --include="*.js" --include="*.json" . 2>/dev/null; then
            echo "::warning::Potential secrets found in codebase"
          else
            echo "No secrets detected"
          fi

  benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install hyperfine
        run: |
          wget https://github.com/sharkdp/hyperfine/releases/download/v1.18.0/hyperfine_1.18.0_amd64.deb
          sudo dpkg -i hyperfine_1.18.0_amd64.deb

      - name: Run benchmark
        run: |
          echo "## Performance Benchmark" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Command | Mean | Min | Max |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|-----|-----|" >> $GITHUB_STEP_SUMMARY

          hyperfine \
            --warmup 2 \
            --runs 5 \
            --export-json benchmark.json \
            "bun run ~/.claude/scripts/test-matrix.ts . --json" \
            || true

          if [ -f benchmark.json ]; then
            MEAN=$(jq -r '.results[0].mean' benchmark.json)
            MIN=$(jq -r '.results[0].min' benchmark.json)
            MAX=$(jq -r '.results[0].max' benchmark.json)
            echo "| Matrix Analysis | ${MEAN}s | ${MIN}s | ${MAX}s |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark.json
          if-no-files-found: ignore
