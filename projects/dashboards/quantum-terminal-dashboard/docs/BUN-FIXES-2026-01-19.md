# Bun Fixes & Improvements - January 19, 2026

## Node.js Compatibility Improvements

### Network & HTTP
- **Fixed**: `node:http` server `CONNECT` event handler not receiving pipelined data in `head` parameter when sent in same TCP segment as request headers (Cap'n Proto KJ HTTP / Cloudflare workerd compatibility)
- **Improved**: `node:http2` module flow control
- **Fixed**: `ws` module now correctly supports the `agent` option for proxy connections

### File System & Environment
- **Fixed**: Temp directory resolution now correctly checks `TMPDIR`, `TMP`, and `TEMP` environment variables in order, matching Node.js's `os.tmpdir()` behavior

### Compression
- **Fixed**: Memory leak in `node:zlib` Brotli, Zstd, and Zlib compression streams where calling `reset()` repeatedly would allocate new encoder/decoder states without freeing previous ones

---

## Bun APIs

### Subprocess & Shell
- **Fixed**: Rare edge case in Subprocess stdin cleanup
- **Fixed**: Rare crash in Bun Shell impacting opencode
- **Fixed**: `EBADF` error when using `&>` redirect with Bun Shell builtin commands
- **Improved**: Bun now rejects null bytes in arguments passed to `Bun.spawn`, `Bun.spawnSync`, environment variables, and shell template literals (prevents CWE-158 null byte injection)

### HTTP & Networking
- **Fixed**: HTTP client requests hanging when multiple concurrent requests fail proxy authentication (407 status code)
- **Fixed**: Parsing bug with `NO_PROXY` environment variable involving empty entries
- **Fixed**: Potential memory leak when proxying streaming responses through `Bun.serve()` with `ReadableStream`

### File Operations
- **Fixed**: Potential data corruption in `Bun.write()` for files larger than 2GB
- **Fixed**: `Bun.write()` now correctly respects the `mode` option when copying files from `Bun.file()`

### Async Operations
- **Fixed**: Hypothetical crash in async zstd compression, scrypt, and transpiler operations where buffers could be garbage collected while still being accessed by worker threads

### SQL Drivers
- **Fixed**: MySQL driver now correctly returns `Buffer` for `BINARY`, `VARBINARY`, and `BLOB` columns instead of corrupted UTF-8 strings
- **Fixed**: Postgres driver incorrectly throwing `InvalidByteSequence` errors when parsing arrays containing strings/JSON larger than 16KB
- **Fixed**: Postgres driver failing to read empty PostgreSQL arrays (e.g., `INTEGER[]` stored as `{}`) with `ERR_POSTGRES_INVALID_BINARY_DATA` error
- **Fixed**: JSON parsing errors from SQL database columns now properly throw `SyntaxError` instead of silently returning empty values

### S3
- **Fixed**: S3 credential validation now properly rejects invalid `pageSize`, `partSize`, and `retry` values outside allowed ranges

### Security
- **Improved**: Bun now enforces stricter wildcard certificate matching following RFC 6125 Section 6.4.3

---

## Impact on Quantum Cash Flow Lattice

| Component | Affected Fix | Action |
|-----------|--------------|--------|
| `financial-ticker.js` | HTTP proxy fixes | ✅ Auto-resolved |
| `Bun.write()` large files | 2GB+ corruption fix | ✅ Auto-resolved |
| SQL drivers | Binary/JSON fixes | ✅ Auto-resolved |
| Subprocess spawning | Null byte injection | ✅ More secure |
| Compression streams | Memory leak fix | ✅ Auto-resolved |

**No code changes required** - all fixes are in Bun runtime.

