# Hyper-Bun v1.3.3: Proactive Performance & Anomaly Trend Analysis

**Version**: 12.0.0.0.0.0.0  
**Feature**: Proactive Performance & Anomaly Trend Analysis  
**Status**: ✅ **IMPLEMENTED**  
**Priority**: Phase 1 - High-Impact Core Enhancement  
**Date**: 2024-12-XX  
**Last Updated**: 2024-12-XX

---

## **Overview**

This subsystem provides proactive performance monitoring and anomaly trend analysis, enabling Hyper-Bun to detect performance drift before it becomes critical. Uses Statistical Process Control (SPC) charting and time-series prediction to identify trends and correlate anomalies with external events.

**Key Principle**: Detect performance issues before they impact users. Proactive monitoring enables preventive action rather than reactive firefighting.

---

## **Quick Reference: Ripgrep Commands**

```bash
# Find performance drift detector implementation
rg "12\.1\.[0-9]\." src/performance/drift-detector.ts

# Find anomaly predictor implementation
rg "12\.2\.[0-9]\." src/performance/anomaly-predictor.ts

# Find console visualizer
rg "12\.3\.[0-9]\." src/performance/console-visualizer.ts

# Find log codes
rg "HBPD-|HBAP-" docs/logging/log-codes.md
```

---

## **12.1.0.0.0.0.0 Dynamic Baseline Tracking & SPC Charting**

### **12.1.1.0.0.0.0 Dynamic Baseline Tracking**

**Location**: `src/performance/drift-detector.ts`

Tracks rolling baselines for performance metrics across multiple time windows:
- **24h**: Short-term baseline for immediate drift detection
- **7d**: Medium-term baseline for weekly patterns
- **30d**: Long-term baseline for seasonal trends

**Baseline Statistics**:
- Mean (average)
- Standard deviation
- P95 percentile
- P99 percentile
- Sample count

**@example 12.1.1.1.1.0**: Test tracking of a sliding window average

```typescript
import { PerformanceDriftDetector } from "./performance/drift-detector";

const detector = new PerformanceDriftDetector();

// Record samples
for (let i = 0; i < 100; i++) {
  detector.recordSample({
    metricName: 'api_response_time',
    value: 100 + Math.random() * 50,
    timestamp: Date.now() - (99 - i) * 1000
  });
}

const baseline = detector.getBaseline('api_response_time', '24h');
// Expected: baseline.mean ≈ 125, baseline.stdDev > 0
```

### **12.1.2.0.0.0.0 Statistical Process Control (SPC) Charting**

**Mechanism**: Implements Western Electric Rules for anomaly detection:

1. **Rule 1**: Point beyond 3 sigma limits (severity: 3)
2. **Rule 2**: 2 of 3 consecutive points beyond 2 sigma (severity: 2)
3. **Rule 3**: 7 consecutive points on same side of mean (severity: 1)

**Control Limits**:
- **UCL** (Upper Control Limit): mean + 3 × stdDev
- **LCL** (Lower Control Limit): mean - 3 × stdDev
- **CL** (Center Line): mean

**@example 12.1.2.1.1.0**: Get SPC control limits

```typescript
const limits = detector.getSPCControlLimits('api_response_time', '24h');
// Expected: { ucl: mean + 3*stdDev, lcl: mean - 3*stdDev, cl: mean }
```

---

## **12.2.0.0.0.0.0 Predictive Anomaly Pattern Modeling**

### **12.2.1.0.0.0.0 Time-Series Anomaly Detection**

**Location**: `src/performance/anomaly-predictor.ts`

Predicts future anomaly rates using linear regression on historical time-series data.

**Requirements**:
- Minimum 24 hours of historical data
- Hourly bucketed anomaly counts
- Linear regression for trend prediction

**@example 12.2.1.1.1.0**: Predict anomaly rate 6 hours ahead

```typescript
import { AnomalyPatternPredictor } from "./performance/anomaly-predictor";

const predictor = new AnomalyPatternPredictor();

// Record historical data
for (let i = 0; i < 168; i++) {
  predictor.recordAnomalyTimeSeries('nfl-2024-001', 10 + Math.random() * 5, Date.now() - i * 3600000);
}

const prediction = predictor.predictAnomalyRate('nfl-2024-001', 6);
// Expected: { predictedAnomalyRate: number, confidence: number, factors: string[] }
```

### **12.2.2.0.0.0.0 External Event Correlation**

**Mechanism**: Correlates anomaly patterns with external events (injuries, weather, etc.)

**Correlation Strength**: Calculated from evidence count and observed impact direction.

**Strong Correlations**: Events with:
- Evidence count >= 5
- Absolute correlation strength >= 0.7

**@example 12.2.2.1.0**: Correlate injury with anomaly increase

```typescript
predictor.correlateWithExternalEvent('nfl-2024-001', 'player_injury', 'injury-12345', true);

const correlations = predictor.getStrongCorrelations(0.7);
// Expected: Array of ExternalEventCorrelation objects
```

---

## **12.3.0.0.0.0.0 Console Visualization Integration**

### **12.3.1.0.0.0.0 Live Performance Metric Dashboards**

**Location**: `src/performance/console-visualizer.ts`

Renders ASCII-based dashboards optimized for tmux panes:

- **Performance Dashboard**: Table showing current vs baseline, deviation %, Z-score, trend
- **SPC Charts**: Control limits visualization with current value position
- **Time Series Graphs**: ASCII line graphs showing trends over time

**@example 12.3.1.1.1.0**: Test performance dashboard visualization

```typescript
import { ConsoleVisualizer } from "./performance/console-visualizer";

const metrics = [
  { name: 'api_response_time', current: 145.3, baseline: 120.5, stdDev: 25.1, status: 'warning' }
];

ConsoleVisualizer.renderPerformanceDashboard(metrics);
```

### **12.3.1.1.0.0.0 SPC Chart Rendering**

Displays Statistical Process Control chart with:
- Upper Control Limit (UCL)
- Center Line (CL / mean)
- Lower Control Limit (LCL)
- Current value position

**@example 12.3.1.1.1.0**: Render SPC chart

```typescript
ConsoleVisualizer.renderSPCChart({
  name: 'api_response_time',
  current: 145,
  baseline: 120,
  stdDev: 25,
  status: 'normal'
});
```

---

## **Console Integration**

### **Performance Commands**

Available in `bun-console.ts`:

```typescript
// Record performance sample
await perf.record('api_response_time', 150.5, { endpoint: '/api/markets' });

// Show performance dashboard
await perf.dashboard();

// Predict anomaly rate
const prediction = await perf.predict('nfl-2024-001', 6);

// Show SPC chart
await perf.spc('api_response_time');

// Show time series trends
await perf.trends('api_response_time', 24);
```

---

## **Database Schema**

### **performance_samples**

```sql
CREATE TABLE performance_samples (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  metric_name TEXT NOT NULL,
  value REAL NOT NULL,
  timestamp INTEGER NOT NULL,
  context_json TEXT,
  created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now') * 1000)
);
```

### **performance_baselines**

```sql
CREATE TABLE performance_baselines (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  metric_name TEXT NOT NULL,
  window_size TEXT NOT NULL,
  mean REAL NOT NULL,
  std_dev REAL NOT NULL,
  p95 REAL NOT NULL,
  p99 REAL NOT NULL,
  sample_count INTEGER NOT NULL,
  last_updated INTEGER NOT NULL,
  UNIQUE(metric_name, window_size)
);
```

### **spc_anomalies**

```sql
CREATE TABLE spc_anomalies (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  metric_name TEXT NOT NULL,
  sample_value REAL NOT NULL,
  control_limit_type TEXT CHECK(control_limit_type IN ('UCL', 'LCL', 'RUN', 'TREND')),
  rule_description TEXT,
  detected_at INTEGER NOT NULL,
  severity INTEGER DEFAULT 1
);
```

---

## **Log Codes**

- **HBPD-001**: SPC Alert detected (WARN)
- **HBPD-002**: Performance data cleanup completed (INFO)
- **HBAP-001**: Anomaly prediction evaluated (INFO)

See `docs/logging/log-codes.md` for complete documentation.

---

## **Related Documentation**

- `src/performance/drift-detector.ts` - Implementation (12.1.0.0.0.0.0)
- `src/performance/anomaly-predictor.ts` - Implementation (12.2.0.0.0.0.0)
- `src/performance/console-visualizer.ts` - Implementation (12.3.0.0.0.0.0)
- `docs/logging/log-codes.md` - Log code registry

---

## **Changelog**

- **12.0.0.0.0.0.0** (2024-12-XX): Initial performance & anomaly trend analysis subsystem
  - Dynamic baseline tracking (24h, 7d, 30d windows)
  - SPC charting with Western Electric Rules
  - Time-series anomaly prediction
  - External event correlation
  - Console visualization integration
