# Bun Utilities Integration: Production Hardening Features

**Version**: 4.2.2.20.0.0.0  
**Component**: Unified Bun Utilities Export  
**Status**: ✅ Integrated

---

## 4.2.2.20.1.0.0: Overview

All production hardening features have been integrated into `src/utils/bun-utilities.ts`, providing a unified import point for all Bun-native utilities including rate limiting, memory monitoring, distributed tracing, and Prometheus metrics.

---

## 4.2.2.20.2.0.0: Usage Examples

### 4.2.2.20.2.1.0.0: Rate Limiting

```typescript
import { BunUtilities } from './src/utils/bun-utilities';

// Create a rate limiter (1000 tokens, refill 1000/sec)
const limiter = BunUtilities.createRateLimiter(1000, 1000);

// Check if request is allowed
if (limiter.acquireSync()) {
  // Process request
} else {
  // Rate limit exceeded
}

// Or use factory presets
const apiLimiter = BunUtilities.rateLimiterFactory.apiRateLimiter();
```

---

### 4.2.2.20.2.2.0.0: Memory Monitoring

```typescript
import { BunUtilities } from './src/utils/bun-utilities';

// Check memory ceiling (default: 4GB)
const memoryCheck = BunUtilities.memory.checkCeiling();
if (memoryCheck.exceeded) {
  console.warn(`Memory exceeded: ${memoryCheck.heapUsed} bytes`);
  // Force GC
  BunUtilities.memory.forceGC();
}

// Get current memory usage
const usage = BunUtilities.memory.getUsage();
console.log(`Heap: ${usage.heapUsed} / ${usage.heapTotal} bytes`);
```

---

### 4.2.2.20.2.3.0.0: Distributed Tracing

```typescript
import { BunUtilities } from './src/utils/bun-utilities';

// Generate trace context
const traceContext = BunUtilities.trace.createTraceContext();

// Run operation with trace context
const result = await BunUtilities.trace.withTraceContext(
  traceContext,
  async () => {
    // Your code here
    return await buildGraph();
  }
);

// Extract from HTTP headers
const incomingContext = BunUtilities.trace.extractTraceContext(request.headers);

// Inject into response headers
const responseHeaders = BunUtilities.trace.injectTraceContext(traceContext);
```

---

### 4.2.2.20.2.4.0.0: Prometheus Metrics

```typescript
import { BunUtilities } from './src/utils/bun-utilities';

// Create metrics instance
const metrics = BunUtilities.metrics.create();

// Record metrics
metrics.counter('requests_total', 1, { endpoint: '/api/graph' });
metrics.gauge('active_connections', 42);
metrics.histogram('request_duration_ms', 125, { endpoint: '/api/graph' });

// Export for Prometheus
const prometheusOutput = metrics.export();

// Or use handler for HTTP endpoint
import { prometheusMetricsHandler } from './src/utils/bun-utilities';
server.get('/metrics', () => prometheusMetricsHandler(engine));
```

---

## 4.2.2.20.3.0.0: Complete Example: API Handler with All Features

```typescript
import { BunUtilities } from './src/utils/bun-utilities';
import { DoDMultiLayerCorrelationGraph } from './src/analytics/correlation-engine';

// Initialize
const engine = new DoDMultiLayerCorrelationGraph(db);
const rateLimiter = BunUtilities.createRateLimiter(1000, 1000);
const metrics = BunUtilities.metrics.create();

export async function handleCorrelationGraphRequest(req: Request): Promise<Response> {
  // 1. Rate limiting
  if (!rateLimiter.acquireSync()) {
    metrics.counter('rate_limit_exceeded_total', 1);
    return new Response('Rate limit exceeded', { status: 429 });
  }

  // 2. Memory check
  const memoryCheck = BunUtilities.memory.checkCeiling();
  if (memoryCheck.exceeded) {
    BunUtilities.memory.forceGC();
    if (BunUtilities.memory.checkCeiling().exceeded) {
      return new Response('Service temporarily unavailable', { status: 503 });
    }
  }

  // 3. Distributed tracing
  const parentContext = BunUtilities.trace.extractTraceContext(req.headers);
  const traceContext = BunUtilities.trace.createTraceContext(parentContext);

  const startTime = performance.now();

  try {
    // 4. Execute with trace context
    const graph = await BunUtilities.trace.withTraceContext(
      traceContext,
      async () => {
        const eventId = new URL(req.url).searchParams.get('eventId');
        return await engine.buildMultiLayerGraph(eventId || '');
      }
    );

    const duration = performance.now() - startTime;

    // 5. Record metrics
    metrics.counter('graph_builds_total', 1, { status: 'success' });
    metrics.histogram('graph_build_duration_ms', duration, { status: 'success' });

    // 6. Inject trace context into response
    const responseHeaders = BunUtilities.trace.injectTraceContext(traceContext);
    responseHeaders.set('Content-Type', 'application/json');

    return new Response(JSON.stringify(graph), {
      headers: Object.fromEntries(responseHeaders),
    });
  } catch (error) {
    metrics.counter('graph_builds_total', 1, { status: 'error' });
    throw error;
  }
}
```

---

## 4.2.2.20.4.0.0: Available Utilities

### Rate Limiting
- `BunUtilities.createRateLimiter(maxTokens, refillRate)` - Token bucket limiter
- `BunUtilities.createSlidingWindowLimiter(windowSizeMs, maxRequests)` - Sliding window limiter
- `BunUtilities.rateLimiterFactory` - Factory with presets

### Memory Monitoring
- `BunUtilities.memory.checkCeiling(ceilingBytes?)` - Check if memory exceeds ceiling
- `BunUtilities.memory.forceGC()` - Force garbage collection
- `BunUtilities.memory.getUsage()` - Get current memory usage

### Distributed Tracing
- `BunUtilities.trace.generateTraceId()` - Generate W3C trace ID
- `BunUtilities.trace.generateSpanId()` - Generate span ID
- `BunUtilities.trace.createTraceContext(parent?)` - Create trace context
- `BunUtilities.trace.extractTraceContext(headers)` - Extract from HTTP headers
- `BunUtilities.trace.injectTraceContext(context)` - Inject into HTTP headers
- `BunUtilities.trace.withTraceContext(context, fn)` - Run function with context
- `BunUtilities.trace.getCurrentTraceContext()` - Get current context

### Prometheus Metrics
- `BunUtilities.metrics.create()` - Create metrics instance
- `BunUtilities.metrics.createHandler(engine?)` - Create HTTP handler

---

## 4.2.2.20.5.0.0: Direct Exports

For direct imports (not through `BunUtilities` namespace):

```typescript
import {
  RateLimiter,
  SlidingWindowRateLimiter,
  RateLimiterFactory,
  generateTraceId,
  createTraceContext,
  PrometheusMetrics,
  prometheusMetricsHandler,
} from './src/utils/bun-utilities';
```

---

## 4.2.2.20.6.0.0: Integration Status

✅ **All production hardening features integrated**:
- Rate limiting (4.2.2.14.1.0.0)
- Memory monitoring (4.2.2.14.2.0.0)
- Distributed tracing (4.2.2.16.0.0.0)
- Prometheus metrics (4.2.2.15.0.0.0)

**Location**: `src/utils/bun-utilities.ts`

**Usage**: Single import point for all Bun utilities

---

**Status**: ✅ Ready for Production Use
