<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Developer Workspace - Interactive API Key Management for Onboarding and Interviews">
    <meta name="keywords" content="developer workspace, API keys, onboarding, interviews, Bun.secrets, rate limiting, time-sensitive access, developer tools">
    <meta name="og:description" content="Developer Workspace - Interactive API Key Management for Onboarding and Interviews with Bun.secrets integration">
    <meta name="author" content="NEXUS Trading Platform">
    <meta name="theme-color" content="#00d4ff">
    <meta name="color-scheme" content="dark">
    <meta name="robots" content="noindex, nofollow">
    <title>Developer Workspace Dashboard - NEXUS</title>
    <!-- Bun v1.3.4+ Features Used:
         - Enhanced fetch() API with proxy header support
         - Improved connection pooling (keepAlive fixes)
         - URLPattern API for client-side route validation (future enhancement)
    -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: white;
        }

        .header-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 10px;
        }

        .connection-status.connected {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .connection-status.disconnected {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .connection-status .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.9em;
            border: none;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: #00d4ff;
            color: #0a0e27;
        }

        .btn-primary:hover {
            background: #00b8e6;
        }

        .btn-danger {
            background: #ff4444;
            color: white;
        }

        .btn-danger:hover {
            background: #cc0000;
        }

        .btn-success {
            background: #00ff88;
            color: #0a0e27;
        }

        .btn-success:hover {
            background: #00cc6a;
        }

        .btn-secondary {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid rgba(0, 212, 255, 0.4);
            color: #00d4ff;
        }

        .btn-secondary:hover {
            background: rgba(0, 212, 255, 0.3);
            border-color: #00d4ff;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 968px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d3561 100%);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .card h2 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
        }

        .search-box input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 6px;
            color: #b0b0b0;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #00d4ff;
            color: #00d4ff;
        }

        .filter-btn.active {
            background: #00d4ff;
            border-color: #00d4ff;
            color: #0a0e27;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #b0b0b0;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 1em;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .key-display {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .key-display.success {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .key-display .copy-btn {
            margin-top: 10px;
            padding: 5px 15px;
            background: #00d4ff;
            border: none;
            border-radius: 4px;
            color: #0a0e27;
            cursor: pointer;
            font-weight: 600;
        }

        .keys-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .key-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            transition: all 0.2s;
            position: relative;
        }

        .key-item:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }

        .key-item.expired {
            opacity: 0.6;
            border-color: #ff4444;
        }

        .key-item.expiring-soon {
            border-color: #ff9800;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0%, 100% { border-color: #ff9800; }
            50% { border-color: #ffb74d; }
        }

        .key-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .key-item-id {
            font-family: 'Courier New', monospace;
            color: #00d4ff;
            font-size: 0.9em;
        }

        .key-item-purpose {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .key-item-purpose.interview {
            background: #ff9800;
            color: #0a0e27;
        }

        .key-item-purpose.onboarding {
            background: #00ff88;
            color: #0a0e27;
        }

        .key-item-purpose.trial {
            background: #9c27b0;
            color: white;
        }

        .key-item-details {
            font-size: 0.9em;
            color: #b0b0b0;
            margin-top: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }

        .key-item-details div {
            margin-bottom: 4px;
        }

        .key-item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(0, 212, 255, 0.2);
            transition: all 0.2s;
        }

        .stat-box:hover {
            border-color: #00d4ff;
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #b0b0b0;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert.success {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00ff88;
            color: #00ff88;
        }

        .alert.error {
            background: rgba(255, 68, 68, 0.1);
            border-color: #ff4444;
            color: #ff4444;
        }

        .alert.info {
            background: rgba(0, 212, 255, 0.1);
            border-color: #00d4ff;
            color: #00d4ff;
        }

        .alert.warning {
            background: rgba(255, 152, 0, 0.1);
            border-color: #ff9800;
            color: #ff9800;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 212, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00d4ff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .api-base-input {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .api-base-input label {
            color: #b0b0b0;
            font-weight: 500;
            white-space: nowrap;
        }

        .api-base-input input {
            flex: 1;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 6px;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d3561 100%);
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #00d4ff;
            font-size: 1.5em;
        }

        .close-btn {
            background: none;
            border: none;
            color: #b0b0b0;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #00d4ff;
        }

        .usage-chart {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .chart-bar {
            height: 30px;
            background: linear-gradient(90deg, #00d4ff, #0099cc);
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            color: #0a0e27;
            font-weight: 600;
            transition: width 0.3s ease;
        }

        .key-count {
            font-size: 0.8em;
            color: #b0b0b0;
            margin-left: 10px;
        }

        kbd {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #00d4ff;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #b0b0b0;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: #00d4ff;
            margin-bottom: 10px;
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .controls .btn {
                width: 100%;
            }
            
            .container {
                grid-template-columns: 1fr;
            }
            
            .key-item-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
            <div style="flex: 1;">
                <h1>üîë Developer Workspace</h1>
                <p class="header-subtitle">
                    Interactive API Key Management for Onboarding & Interviews
                    <span class="connection-status disconnected" id="connectionStatus">
                        <span class="status-dot"></span>
                        <span id="connectionText">Disconnected</span>
                    </span>
                </p>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="../docs/DOCUMENTATION-INDEX.md" target="_blank" style="color: rgba(255, 255, 255, 0.9); text-decoration: none; padding: 8px 15px; background: rgba(0, 0, 0, 0.2); border-radius: 20px; font-size: 0.9em; transition: background 0.3s;" onmouseover="this.style.background='rgba(0, 0, 0, 0.4)'" onmouseout="this.style.background='rgba(0, 0, 0, 0.2)'">üìö Docs</a>
                <a href="../docs/BUN-WORKSPACES.md" target="_blank" style="color: rgba(255, 255, 255, 0.9); text-decoration: none; padding: 8px 15px; background: rgba(0, 0, 0, 0.2); border-radius: 20px; font-size: 0.9em; transition: background 0.3s;" onmouseover="this.style.background='rgba(0, 0, 0, 0.4)'" onmouseout="this.style.background='rgba(0, 0, 0, 0.2)'">üîß Workspaces</a>
                <a href="../docs/11.0.0.0.0.0.0-TERMINAL-ENVIRONMENT.md" target="_blank" style="color: rgba(255, 255, 255, 0.9); text-decoration: none; padding: 8px 15px; background: rgba(0, 0, 0, 0.2); border-radius: 20px; font-size: 0.9em; transition: background 0.3s;" onmouseover="this.style.background='rgba(0, 0, 0, 0.4)'" onmouseout="this.style.background='rgba(0, 0, 0, 0.2)'">üíª Terminal</a>
                <a href="../benchmarks/" target="_blank" style="color: rgba(255, 255, 255, 0.9); text-decoration: none; padding: 8px 15px; background: rgba(0, 0, 0, 0.2); border-radius: 20px; font-size: 0.9em; transition: background 0.3s;" onmouseover="this.style.background='rgba(0, 0, 0, 0.4)'" onmouseout="this.style.background='rgba(0, 0, 0, 0.2)'">üìä Benchmarks</a>
                <a href="../docs/BUN-V1.51-IMPACT-ANALYSIS.md" target="_blank" style="color: rgba(255, 255, 255, 0.9); text-decoration: none; padding: 8px 15px; background: rgba(0, 0, 0, 0.2); border-radius: 20px; font-size: 0.9em; transition: background 0.3s;" onmouseover="this.style.background='rgba(0, 0, 0, 0.4)'" onmouseout="this.style.background='rgba(0, 0, 0, 0.2)'">‚ö° Performance</a>
                <a href="../docs/LAYER4-CORRELATION-TEST-GUIDE.md" target="_blank" style="color: rgba(255, 255, 255, 0.9); text-decoration: none; padding: 8px 15px; background: rgba(0, 0, 0, 0.2); border-radius: 20px; font-size: 0.9em; transition: background 0.3s;" onmouseover="this.style.background='rgba(0, 0, 0, 0.4)'" onmouseout="this.style.background='rgba(0, 0, 0, 0.2)'">üß™ Layer4 Tests</a>
            </div>
        </div>
        <div class="controls">
            <button class="btn btn-primary" onclick="refreshKeys()" title="Refresh keys list (Ctrl/Cmd+R)">üîÑ Refresh</button>
            <button class="btn" onclick="showCreateForm()" title="Create new API key (Ctrl/Cmd+N)">‚ûï Create Key</button>
            <button class="btn" onclick="exportKeys()" title="Export keys as JSON or CSV">üíæ Export</button>
            <button class="btn" onclick="testConnection()" title="Test API connection">üîå Test Connection</button>
            <button class="btn" onclick="showKeyboardShortcuts()" title="Show keyboard shortcuts">‚å®Ô∏è Shortcuts</button>
            <a href="./index.html" class="btn" style="text-decoration: none; color: white;" title="Go to main dashboard">üè† Main Dashboard</a>
        </div>
    </div>

        <div class="api-base-input">
        <label for="apiBase">API Base URL:</label>
        <input type="text" id="apiBase" value="http://localhost:3001" placeholder="http://localhost:3001" onchange="handleApiBaseChange()">
        <button onclick="loadApiBaseFromRegistry()" class="btn btn-secondary">üì• Load from Registry</button>
        <button onclick="saveApiBase()" class="btn btn-secondary" title="Save API Base URL">üíæ Save</button>
    </div>

    <div id="alertContainer"></div>

    <div class="container">
        <!-- Create Key Form -->
        <div class="card">
            <h2>Create API Key</h2>
            <form id="createKeyForm" onsubmit="createKey(event)">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" required placeholder="developer@example.com">
                </div>
                <div class="form-group">
                    <label for="purpose">Purpose:</label>
                    <select id="purpose" required onchange="updatePurposeDefaults()">
                        <option value="interview">Interview (24h, 100 req/hr)</option>
                        <option value="onboarding">Onboarding (7 days, 1000 req/hr)</option>
                        <option value="trial">Trial (3 days, 500 req/hr)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="expirationHours">Expiration (hours):</label>
                    <input type="number" id="expirationHours" min="1" placeholder="Auto (default for purpose)">
                </div>
                <div class="form-group">
                    <label for="rateLimit">Rate Limit (requests/hour):</label>
                    <input type="number" id="rateLimit" min="1" placeholder="Auto (default for purpose)">
                </div>
                <div class="form-group">
                    <label for="metadata">Metadata (JSON, optional):</label>
                    <textarea id="metadata" placeholder='{"interviewId": "INT-001", "team": "Engineering"}'></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
                    Create Key
                </button>
            </form>
            <div id="keyDisplay" class="key-display hidden"></div>
        </div>

        <!-- Statistics -->
        <div class="card">
            <h2>
                Statistics
                <span class="key-count" id="keyCountDisplay"></span>
                <button class="btn" onclick="toggleStatsView()" style="padding: 5px 15px; font-size: 0.8em;">üìä Detailed</button>
            </h2>
            <!-- Package Manager Configuration -->
            <div id="packageManagerConfig" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(0,212,255,0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong style="color: #00d4ff;">üì¶ Package Manager</strong>
                    <span id="linkerStatus" style="padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600; background: rgba(0,255,136,0.2); color: #00ff88;">Isolated</span>
                </div>
                <div style="font-size: 0.8em; color: #888; margin-bottom: 10px; font-style: italic;">
                    üí° Tip: Use <code style="color: #00d4ff;">catalog:</code> for shared versions, <code style="color: #00d4ff;">workspace:1.0.2</code> resolves to exact version even if current is 1.0.1. Use <code style="color: #00d4ff;">link:</code> for external packages. Check untrusted deps with <code style="color: #00d4ff;">bun pm untrusted</code>.
                </div>
                <div style="font-size: 0.9em; color: #b0b0b0;" id="linkerDetails">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                        <div>Linker: <code style="color: #00d4ff;" id="linkerValue">isolated</code></div>
                        <div>Workspaces: <span id="workspacesStatus">‚úÖ Enabled</span></div>
                        <div>Lockfile: <span id="lockfileStatus">‚úÖ bun.lock</span></div>
                        <div>Trusted Scripts: <span id="trustedScriptsStatus">0 + 500 default</span></div>
                        <div>Scoped Registries: <span id="scopedRegistriesStatus">0</span></div>
                        <div>Overrides: <span id="overridesStatus">0</span></div>
                        <div>Catalog: <span id="catalogStatus">0</span></div>
                        <div>Workspace Protocol: <span id="workspaceProtocolStatus">0</span></div>
                        <div>Linked Packages: <span id="linkedPackagesStatus">0</span></div>
                    </div>
                </div>
            </div>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-box">
                    <div class="stat-value" id="totalKeys">-</div>
                    <div class="stat-label">Total Keys</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="activeKeys">-</div>
                    <div class="stat-label">Active Keys</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="expiredKeys">-</div>
                    <div class="stat-label">Expired Keys</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalRequests">-</div>
                    <div class="stat-label">Total Requests</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="avgRequests">-</div>
                    <div class="stat-label">Avg Requests/Key</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="expiringSoon">-</div>
                    <div class="stat-label">Expiring Soon</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="rateLimited">-</div>
                    <div class="stat-label">Rate Limited</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="requestsToday">-</div>
                    <div class="stat-label">Requests Today</div>
                </div>
            </div>
            <div id="detailedStats" style="display: none; margin-top: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                        <div style="color: #b0b0b0; font-size: 0.9em; margin-bottom: 5px;">Most Active Key</div>
                        <div style="color: #00d4ff; font-weight: 600;" id="mostActiveKey">-</div>
                        <div style="color: #b0b0b0; font-size: 0.85em; margin-top: 5px;" id="mostActiveRequests">-</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                        <div style="color: #b0b0b0; font-size: 0.9em; margin-bottom: 5px;">Keys Created Today</div>
                        <div style="color: #00d4ff; font-weight: 600; font-size: 1.5em;" id="keysToday">-</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                        <div style="color: #b0b0b0; font-size: 0.9em; margin-bottom: 5px;">Avg Key Lifetime</div>
                        <div style="color: #00d4ff; font-weight: 600;" id="avgLifetime">-</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                        <div style="color: #b0b0b0; font-size: 0.9em; margin-bottom: 5px;">Total Rate Limit Capacity</div>
                        <div style="color: #00d4ff; font-weight: 600;" id="totalCapacity">-</div>
                        <div style="color: #b0b0b0; font-size: 0.85em; margin-top: 5px;" id="capacityUsed">-</div>
                    </div>
                </div>
            </div>
            <div class="usage-chart" id="usageChart" style="display: none;">
                <h3 style="color: #00d4ff; margin-bottom: 15px; font-size: 1.1em;">Usage by Purpose</h3>
                <div id="chartContainer"></div>
            </div>
            <div class="usage-chart" id="requestTrendChart" style="display: none; margin-top: 20px;">
                <h3 style="color: #00d4ff; margin-bottom: 15px; font-size: 1.1em;">Request Distribution</h3>
                <div id="requestTrendContainer"></div>
            </div>
        </div>
    </div>

    <!-- Keys List -->
    <div class="card">
        <h2>Active Keys</h2>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="üîç Search by email, key ID, or purpose..." oninput="filterKeys()">
        </div>
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="setFilter('all')">All</button>
            <button class="filter-btn" onclick="setFilter('active')">Active</button>
            <button class="filter-btn" onclick="setFilter('expired')">Expired</button>
            <button class="filter-btn" onclick="setFilter('interview')">Interview</button>
            <button class="filter-btn" onclick="setFilter('onboarding')">Onboarding</button>
            <button class="filter-btn" onclick="setFilter('trial')">Trial</button>
        </div>
        <div class="keys-list" id="keysList">
            <div class="loading"></div> Loading keys...
        </div>
    </div>

    <!-- Stats Modal -->
    <div class="modal" id="statsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Key Statistics</h3>
                <button class="close-btn" onclick="closeModal('statsModal')">&times;</button>
            </div>
            <div id="statsModalContent"></div>
        </div>
    </div>

    <script>
        const API_BASE = () => document.getElementById('apiBase').value || 'http://localhost:3001';

        // Load API base URL from localStorage on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedApiBase = localStorage.getItem('workspaceApiBase');
            if (savedApiBase) {
                const apiBaseInput = document.getElementById('apiBase');
                if (apiBaseInput) {
                    apiBaseInput.value = savedApiBase;
                }
            }
            // Auto-test connection on load
            setTimeout(() => testConnection(), 500);
        });

        function handleApiBaseChange() {
            const apiBase = document.getElementById('apiBase').value;
            localStorage.setItem('workspaceApiBase', apiBase);
            testConnection();
        }

        function saveApiBase() {
            const apiBase = document.getElementById('apiBase').value;
            if (!apiBase || !apiBase.startsWith('http')) {
                showAlert('Invalid API Base URL. Must start with http:// or https://', 'error');
                return;
            }
            localStorage.setItem('workspaceApiBase', apiBase);
            showAlert('API Base URL saved!', 'success');
            testConnection();
        }

        async function loadPackageManagerConfig() {
            try {
                const response = await fetch(`${API_BASE()}/api/workspace/config`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.config && data.config.packageManager) {
                        const pm = data.config.packageManager;
                        const linkerStatus = document.getElementById('linkerStatus');
                        const linkerValue = document.getElementById('linkerValue');
                        const workspacesStatus = document.getElementById('workspacesStatus');
                        const lockfileStatus = document.getElementById('lockfileStatus');
                        const trustedScriptsStatus = document.getElementById('trustedScriptsStatus');
                        const scopedRegistriesStatus = document.getElementById('scopedRegistriesStatus');
                        const overridesStatus = document.getElementById('overridesStatus');
                        const catalogStatus = document.getElementById('catalogStatus');
                        const workspaceProtocolStatus = document.getElementById('workspaceProtocolStatus');
                        const linkedPackagesStatus = document.getElementById('linkedPackagesStatus');
                        
                        if (linkerStatus && linkerValue && workspacesStatus) {
                            linkerValue.textContent = pm.linker;
                            linkerStatus.textContent = pm.isIsolated ? 'Isolated' : 'Hoisted';
                            linkerStatus.style.background = pm.isIsolated 
                                ? 'rgba(0,255,136,0.2)' 
                                : 'rgba(255,152,0,0.2)';
                            linkerStatus.style.color = pm.isIsolated ? '#00ff88' : '#ff9800';
                            
                            workspacesStatus.textContent = pm.hasWorkspaces ? '‚úÖ Enabled' : '‚ùå Disabled';
                            workspacesStatus.style.color = pm.hasWorkspaces ? '#00ff88' : '#ff4444';
                        }
                        
                        if (lockfileStatus && pm.lockfile) {
                            if (pm.lockfile.exists) {
                                lockfileStatus.textContent = `‚úÖ ${pm.lockfile.path}`;
                                lockfileStatus.style.color = '#00ff88';
                            } else {
                                lockfileStatus.textContent = '‚ùå Not found';
                                lockfileStatus.style.color = '#ff4444';
                            }
                        }
                        
                        if (trustedScriptsStatus && pm.lifecycleScripts) {
                            const trusted = pm.lifecycleScripts.trustedCount || 0;
                            const defaultTrusted = pm.lifecycleScripts.defaultTrusted || 500;
                            trustedScriptsStatus.textContent = `${trusted} + ${defaultTrusted} default`;
                            trustedScriptsStatus.style.color = trusted > 0 ? '#00ff88' : '#b0b0b0';
                        }
                        
                        if (scopedRegistriesStatus && pm.scopedRegistries) {
                            const count = pm.scopedRegistries.count || 0;
                            scopedRegistriesStatus.textContent = count > 0 ? `‚úÖ ${count}` : '0';
                            scopedRegistriesStatus.style.color = count > 0 ? '#00ff88' : '#b0b0b0';
                        }
                        
                        if (overridesStatus && pm.overrides) {
                            const count = pm.overrides.count || 0;
                            overridesStatus.textContent = count > 0 ? `‚úÖ ${count}` : '0';
                            overridesStatus.style.color = count > 0 ? '#00ff88' : '#b0b0b0';
                        }
                        
                        if (catalogStatus && pm.catalog) {
                            const catalogCount = pm.catalog.count || 0;
                            const catalogsCount = pm.catalogs?.count || 0;
                            const total = catalogCount + catalogsCount;
                            catalogStatus.textContent = total > 0 ? `‚úÖ ${catalogCount} + ${catalogsCount} named` : '0';
                            catalogStatus.style.color = total > 0 ? '#00ff88' : '#b0b0b0';
                        }
                        
                        if (workspaceProtocolStatus && pm.workspaceProtocol) {
                            const count = pm.workspaceProtocol.count || 0;
                            workspaceProtocolStatus.textContent = count > 0 ? `‚úÖ ${count}` : '0';
                            workspaceProtocolStatus.style.color = count > 0 ? '#00ff88' : '#b0b0b0';
                        }
                        
                        if (linkedPackagesStatus && pm.linkedPackages) {
                            const count = pm.linkedPackages.count || 0;
                            linkedPackagesStatus.textContent = count > 0 ? `‚úÖ ${count}` : '0';
                            linkedPackagesStatus.style.color = count > 0 ? '#ff9800' : '#b0b0b0';
                            if (count > 0) {
                                linkedPackagesStatus.title = `Linked packages: ${pm.linkedPackages.packages.join(', ')}`;
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn('Failed to load package manager config:', error);
            }
        }

        async function loadApiBaseFromRegistry() {
            try {
                const apiBaseInput = document.getElementById('apiBase');
                const currentApiBase = apiBaseInput.value;
                
                showAlert('Loading API Base URL from registry...', 'info');
                
                // Try to fetch config from workspace API
                const response = await fetch(`${currentApiBase}/api/workspace/config`, {
                    signal: AbortSignal.timeout(5000)
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.config) {
                        if (data.config.apiBaseUrl) {
                            apiBaseInput.value = data.config.apiBaseUrl;
                            localStorage.setItem('workspaceApiBase', data.config.apiBaseUrl);
                        }
                        
                        // Also load package manager config
                        if (data.config.packageManager) {
                            const pm = data.config.packageManager;
                            const linkerStatus = document.getElementById('linkerStatus');
                            const linkerValue = document.getElementById('linkerValue');
                            const workspacesStatus = document.getElementById('workspacesStatus');
                            const lockfileStatus = document.getElementById('lockfileStatus');
                            const trustedScriptsStatus = document.getElementById('trustedScriptsStatus');
                            const scopedRegistriesStatus = document.getElementById('scopedRegistriesStatus');
                            const overridesStatus = document.getElementById('overridesStatus');
                            const catalogStatus = document.getElementById('catalogStatus');
                            const workspaceProtocolStatus = document.getElementById('workspaceProtocolStatus');
                            const linkedPackagesStatus = document.getElementById('linkedPackagesStatus');
                            
                            if (linkerStatus && linkerValue && workspacesStatus) {
                                linkerValue.textContent = pm.linker;
                                linkerStatus.textContent = pm.isIsolated ? 'Isolated' : 'Hoisted';
                                linkerStatus.style.background = pm.isIsolated 
                                    ? 'rgba(0,255,136,0.2)' 
                                    : 'rgba(255,152,0,0.2)';
                                linkerStatus.style.color = pm.isIsolated ? '#00ff88' : '#ff9800';
                                
                                workspacesStatus.textContent = pm.hasWorkspaces ? '‚úÖ Enabled' : '‚ùå Disabled';
                                workspacesStatus.style.color = pm.hasWorkspaces ? '#00ff88' : '#ff4444';
                            }
                            
                            if (lockfileStatus && pm.lockfile) {
                                if (pm.lockfile.exists) {
                                    lockfileStatus.textContent = `‚úÖ ${pm.lockfile.path}`;
                                    lockfileStatus.style.color = '#00ff88';
                                } else {
                                    lockfileStatus.textContent = '‚ùå Not found';
                                    lockfileStatus.style.color = '#ff4444';
                                }
                            }
                            
                            if (trustedScriptsStatus && pm.lifecycleScripts) {
                                const trusted = pm.lifecycleScripts.trustedCount || 0;
                                const defaultTrusted = pm.lifecycleScripts.defaultTrusted || 500;
                                trustedScriptsStatus.textContent = `${trusted} + ${defaultTrusted} default`;
                                trustedScriptsStatus.style.color = trusted > 0 ? '#00ff88' : '#b0b0b0';
                            }
                            
                            if (scopedRegistriesStatus && pm.scopedRegistries) {
                                const count = pm.scopedRegistries.count || 0;
                                scopedRegistriesStatus.textContent = count > 0 ? `‚úÖ ${count}` : '0';
                                scopedRegistriesStatus.style.color = count > 0 ? '#00ff88' : '#b0b0b0';
                            }
                            
                            if (overridesStatus && pm.overrides) {
                                const count = pm.overrides.count || 0;
                                overridesStatus.textContent = count > 0 ? `‚úÖ ${count}` : '0';
                                overridesStatus.style.color = count > 0 ? '#00ff88' : '#b0b0b0';
                            }
                            
                            if (catalogStatus && pm.catalog) {
                                const catalogCount = pm.catalog.count || 0;
                                const catalogsCount = pm.catalogs?.count || 0;
                                const total = catalogCount + catalogsCount;
                                catalogStatus.textContent = total > 0 ? `‚úÖ ${catalogCount} + ${catalogsCount} named` : '0';
                                catalogStatus.style.color = total > 0 ? '#00ff88' : '#b0b0b0';
                            }
                            
                            if (workspaceProtocolStatus && pm.workspaceProtocol) {
                                const count = pm.workspaceProtocol.count || 0;
                                workspaceProtocolStatus.textContent = count > 0 ? `‚úÖ ${count}` : '0';
                                workspaceProtocolStatus.style.color = count > 0 ? '#00ff88' : '#b0b0b0';
                            }
                            
                            if (linkedPackagesStatus && pm.linkedPackages) {
                                const count = pm.linkedPackages.count || 0;
                                linkedPackagesStatus.textContent = count > 0 ? `‚úÖ ${count}` : '0';
                                linkedPackagesStatus.style.color = count > 0 ? '#ff9800' : '#b0b0b0';
                                if (count > 0) {
                                    linkedPackagesStatus.title = `Linked packages: ${pm.linkedPackages.packages.join(', ')}`;
                                }
                            }
                        }
                        
                        showAlert('‚úÖ API Base URL loaded from registry', 'success');
                        testConnection();
                        return;
                    }
                }
                
                // Fallback: try to get from registry overview
                try {
                    const registryResponse = await fetch(`${currentApiBase}/api/registry`, {
                        signal: AbortSignal.timeout(5000)
                    });
                    if (registryResponse.ok) {
                        const registryData = await registryResponse.json();
                        const workspaceRegistry = Array.isArray(registryData) 
                            ? registryData.find((r) => r.id === 'workspace')
                            : registryData.registries?.find((r) => r.id === 'workspace');
                        
                        if (workspaceRegistry && workspaceRegistry.endpoint) {
                            // Extract base URL from endpoint
                            const url = new URL(workspaceRegistry.endpoint, currentApiBase);
                            const baseUrl = `${url.protocol}//${url.host}`;
                            apiBaseInput.value = baseUrl;
                            localStorage.setItem('workspaceApiBase', baseUrl);
                            showAlert('‚úÖ API Base URL loaded from registry', 'success');
                            testConnection();
                            return;
                        }
                    }
                } catch (regError) {
                    console.warn('Registry fallback failed:', regError);
                }
                
                showAlert('‚ö†Ô∏è Could not load API Base URL from registry. Using current value.', 'warning');
            } catch (error) {
                console.error('Failed to load API base URL from registry:', error);
                showAlert(`‚ùå Failed to load API Base URL: ${error.message}`, 'error');
            }
        }
        let allKeys = [];
        let currentFilter = 'all';
        let searchQuery = '';

        /**
         * Show alert message with auto-dismiss
         * Uses setTimeout for auto-dismiss (could be enhanced with fake timers in tests)
         */
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert ${type}">${message}</div>`;
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            statusEl.className = 'connection-status disconnected';
            textEl.textContent = 'Testing...';

            try {
                const response = await fetch(`${API_BASE()}/api/workspace/keys`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(3000)
                });
                if (response.ok) {
                    statusEl.className = 'connection-status connected';
                    textEl.textContent = 'Connected';
                } else {
                    throw new Error('Connection failed');
                }
            } catch (error) {
                statusEl.className = 'connection-status disconnected';
                textEl.textContent = 'Disconnected';
            }
        }

        function updatePurposeDefaults() {
            const purpose = document.getElementById('purpose').value;
            const defaults = {
                interview: { hours: 24, rate: 100 },
                onboarding: { hours: 168, rate: 1000 },
                trial: { hours: 72, rate: 500 }
            };
            const def = defaults[purpose];
            document.getElementById('expirationHours').placeholder = `Auto (${def.hours}h default)`;
            document.getElementById('rateLimit').placeholder = `Auto (${def.rate} req/hr default)`;
        }

        async function createKey(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const purpose = document.getElementById('purpose').value;
            const expirationHours = document.getElementById('expirationHours').value;
            const rateLimit = document.getElementById('rateLimit').value;
            let metadata = {};

            try {
                const metadataText = document.getElementById('metadata').value.trim();
                if (metadataText) {
                    metadata = JSON.parse(metadataText);
                }
            } catch (e) {
                showAlert('Invalid JSON in metadata field', 'error');
                return;
            }

            const body = {
                email,
                purpose,
                ...(expirationHours && { expirationHours: parseInt(expirationHours) }),
                ...(rateLimit && { rateLimitPerHour: parseInt(rateLimit) }),
                ...(Object.keys(metadata).length > 0 && { metadata })
            };

            try {
                const response = await fetch(`${API_BASE()}/api/workspace/keys`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to create key');
                }

                const data = await response.json();
                const key = data.key || data;
                const keyDisplay = document.getElementById('keyDisplay');
                keyDisplay.className = 'key-display success';
                keyDisplay.innerHTML = `
                    <strong>‚úÖ Key Created Successfully!</strong><br>
                    <div style="margin-top: 10px;">
                        <strong>API Key:</strong><br>
                        <code style="word-break: break-all; display: block; margin-top: 5px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px;">${key.apiKey}</code>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>Key ID:</strong> ${key.id}<br>
                        <strong>Purpose:</strong> ${key.purpose}<br>
                        <strong>Expires:</strong> ${new Date(key.expiresAt).toLocaleString()}<br>
                        <strong>Rate Limit:</strong> ${key.rateLimitPerHour} requests/hour
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button class="copy-btn" onclick="copyToClipboard('${key.apiKey}')">üìã Copy Key</button>
                        <button class="copy-btn" onclick="testApiKey('${key.apiKey}')" style="background: #00ff88;">üß™ Test Key</button>
                    </div>
                `;
                keyDisplay.classList.remove('hidden');

                showAlert('API key created successfully!', 'success');
                document.getElementById('createKeyForm').reset();
                updatePurposeDefaults();
                refreshKeys();
                loadStats();
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('Copied to clipboard!', 'success');
            });
        }

        /**
         * Test API key validity
         * Uses enhanced fetch() API with improved connection pooling (Bun v1.3.4+)
         */
        async function testApiKey(apiKey) {
            try {
                showAlert('Testing API key...', 'info');
                // Enhanced fetch() with improved keepAlive support (Bun v1.3.4+)
                const response = await fetch(`${API_BASE()}/api/workspace/me`, {
                    headers: {
                        'X-API-Key': apiKey
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showAlert(`‚úÖ Key is valid! Key ID: ${data.keyId}`, 'success');
                } else {
                    const error = await response.json();
                    showAlert(`‚ùå Key test failed: ${error.message || 'Invalid key'}`, 'error');
                }
            } catch (error) {
                showAlert(`Error testing key: ${error.message}`, 'error');
            }
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            filterKeys();
        }

        function filterKeys() {
            searchQuery = document.getElementById('searchInput').value.toLowerCase();
            displayKeys();
        }

        function displayKeys() {
            const keysList = document.getElementById('keysList');
            
            let filtered = allKeys.filter(key => {
                // Search filter
                if (searchQuery) {
                    const matchesSearch = 
                        key.email.toLowerCase().includes(searchQuery) ||
                        key.id.toLowerCase().includes(searchQuery) ||
                        key.purpose.toLowerCase().includes(searchQuery);
                    if (!matchesSearch) return false;
                }

                // Type filter
                if (currentFilter === 'all') return true;
                if (currentFilter === 'active') return key.active && Date.now() < key.expiresAt;
                if (currentFilter === 'expired') return !key.active || Date.now() >= key.expiresAt;
                return key.purpose === currentFilter;
            });

            if (filtered.length === 0) {
                keysList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <h3>No keys found</h3>
                        <p>${allKeys.length === 0 
                            ? 'No keys have been created yet. Create your first key to get started!' 
                            : 'No keys match your current filters. Try adjusting your search or filters.'}</p>
                        ${allKeys.length === 0 ? '<button class="btn btn-primary" onclick="showCreateForm()">‚ûï Create First Key</button>' : ''}
                    </div>
                `;
                return;
            }

            keysList.innerHTML = filtered.map(key => {
                const expired = Date.now() > key.expiresAt;
                const expiresAt = new Date(key.expiresAt).toLocaleString();
                const createdAt = new Date(key.createdAt).toLocaleString();
                const timeRemaining = expired ? 'Expired' : formatTimeRemaining(key.expiresAt - Date.now());
                const timeRemainingMs = key.expiresAt - Date.now();
                const expiringSoon = !expired && timeRemainingMs < 24 * 60 * 60 * 1000; // Less than 24h

                return `
                    <div class="key-item ${expired ? 'expired' : ''} ${expiringSoon ? 'expiring-soon' : ''}">
                        <div class="key-item-header">
                            <span class="key-item-id">${key.id}</span>
                            <span class="key-item-purpose ${key.purpose}">${key.purpose}</span>
                        </div>
                        <div class="key-item-details">
                            <div><strong>Email:</strong> ${key.email}</div>
                            <div><strong>Created:</strong> ${createdAt}</div>
                            <div><strong>Expires:</strong> ${expiresAt}</div>
                            <div><strong>Time Remaining:</strong> <span style="color: ${expiringSoon ? '#ff9800' : expired ? '#ff4444' : '#00ff88'}">${timeRemaining}</span></div>
                            <div><strong>Rate Limit:</strong> ${key.rateLimitPerHour} req/hr</div>
                            <div><strong>Requests:</strong> ${key.requestCount || 0}</div>
                            ${key.metadata ? `<div><strong>Metadata:</strong> <code style="font-size: 0.85em;">${JSON.stringify(key.metadata)}</code></div>` : ''}
                        </div>
                        <div class="key-item-actions">
                            <button class="btn" onclick="viewKeyStats('${key.id}')">üìä Stats</button>
                            <button class="btn btn-success" onclick="copyToClipboard('${key.id}')">üìã Copy ID</button>
                            <button class="btn btn-danger" onclick="revokeKey('${key.id}')">üóëÔ∏è Revoke</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function refreshKeys() {
            const keysList = document.getElementById('keysList');
            keysList.innerHTML = '<div class="loading"></div> Loading keys...';

            try {
                const response = await fetch(`${API_BASE()}/api/workspace/keys`);
                if (!response.ok) {
                    throw new Error('Failed to load keys');
                }

                const responseData = await response.json();
                // Handle both array response and {success: true, keys: [...]} format
                allKeys = Array.isArray(responseData) ? responseData : (responseData.keys || []);
                document.getElementById('keyCountDisplay').textContent = `(${allKeys.length} total)`;
                displayKeys();
                loadStats();
            } catch (error) {
                keysList.innerHTML = `<div class="alert error">Error loading keys: ${error.message}<br><small>Make sure the API server is running at ${API_BASE()}</small></div>`;
            }
        }

        function formatTimeRemaining(ms) {
            if (ms < 0) return 'Expired';
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            const hours = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }

        async function revokeKey(keyId) {
            if (!confirm(`Are you sure you want to revoke key ${keyId}?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE()}/api/workspace/keys/${keyId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to revoke key');
                }

                showAlert('Key revoked successfully', 'success');
                refreshKeys();
                loadStats();
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            }
        }

        async function viewKeyStats(keyId) {
            try {
                const response = await fetch(`${API_BASE()}/api/workspace/keys/${keyId}/stats`);
                if (!response.ok) {
                    throw new Error('Failed to load stats');
                }

                const stats = await response.json();
                const modal = document.getElementById('statsModal');
                const content = document.getElementById('statsModalContent');
                
                content.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div><strong>Key ID:</strong><br><code>${stats.keyId}</code></div>
                        <div><strong>Status:</strong><br><span style="color: ${stats.isExpired ? '#ff4444' : '#00ff88'}">${stats.isExpired ? 'Expired' : 'Active'}</span></div>
                        <div><strong>Total Requests:</strong><br>${stats.totalRequests}</div>
                        <div><strong>Requests Last Hour:</strong><br>${stats.requestsLastHour}</div>
                        <div><strong>Requests Today:</strong><br>${stats.requestsToday}</div>
                        <div><strong>Rate Limited:</strong><br><span style="color: ${stats.isRateLimited ? '#ff4444' : '#00ff88'}">${stats.isRateLimited ? 'Yes' : 'No'}</span></div>
                        <div><strong>Created:</strong><br>${new Date(stats.createdAt).toLocaleString()}</div>
                        <div><strong>Expires:</strong><br>${new Date(stats.expiresAt).toLocaleString()}</div>
                        <div><strong>Last Used:</strong><br>${stats.lastUsedAt ? new Date(stats.lastUsedAt).toLocaleString() : 'Never'}</div>
                        <div><strong>Time Remaining:</strong><br>${formatTimeRemaining(stats.timeRemaining)}</div>
                    </div>
                `;
                
                modal.classList.add('active');
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        let statsViewExpanded = false;

        function toggleStatsView() {
            statsViewExpanded = !statsViewExpanded;
            document.getElementById('detailedStats').style.display = statsViewExpanded ? 'block' : 'none';
            event.target.textContent = statsViewExpanded ? 'üìä Simple' : 'üìä Detailed';
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE()}/api/workspace/keys`);
                if (!response.ok) {
                    throw new Error('Failed to load stats');
                }

                const responseData = await response.json();
                // Handle both array response and {success: true, keys: [...]} format
                const keys = Array.isArray(responseData) ? responseData : (responseData.keys || []);
                const now = Date.now();
                const todayStart = new Date(now).setHours(0, 0, 0, 0);
                
                // Basic stats
                const active = keys.filter(k => k.active && now < k.expiresAt).length;
                const expired = keys.filter(k => !k.active || now >= k.expiresAt).length;
                const totalRequests = keys.reduce((sum, k) => sum + (k.requestCount || 0), 0);
                const avgRequests = keys.length > 0 ? Math.round(totalRequests / keys.length) : 0;
                const expiringSoon = keys.filter(k => {
                    const timeRemaining = k.expiresAt - now;
                    return k.active && timeRemaining > 0 && timeRemaining < 24 * 60 * 60 * 1000;
                }).length;
                const rateLimited = keys.filter(k => {
                    const limit = k.rateLimitPerHour || 0;
                    const count = k.requestCount || 0;
                    return k.active && limit > 0 && count >= limit;
                }).length;
                const requestsToday = keys.filter(k => k.lastRequestAt && k.lastRequestAt > todayStart)
                    .reduce((sum, k) => sum + (k.requestCount || 0), 0);

                // Update basic stats
                document.getElementById('totalKeys').textContent = keys.length;
                document.getElementById('activeKeys').textContent = active;
                document.getElementById('expiredKeys').textContent = expired;
                document.getElementById('totalRequests').textContent = totalRequests.toLocaleString();
                document.getElementById('avgRequests').textContent = avgRequests;
                document.getElementById('expiringSoon').textContent = expiringSoon;
                document.getElementById('rateLimited').textContent = rateLimited;
                document.getElementById('requestsToday').textContent = requestsToday.toLocaleString();

                // Detailed stats
                if (statsViewExpanded) {
                    // Most active key
                    const mostActive = keys.reduce((max, k) => {
                        const count = k.requestCount || 0;
                        return count > (max.requestCount || 0) ? k : max;
                    }, { requestCount: 0 });
                    if (mostActive.id) {
                        document.getElementById('mostActiveKey').textContent = mostActive.id.substring(0, 20) + '...';
                        document.getElementById('mostActiveRequests').textContent = `${mostActive.requestCount || 0} requests`;
                    } else {
                        document.getElementById('mostActiveKey').textContent = 'None';
                        document.getElementById('mostActiveRequests').textContent = 'No activity';
                    }

                    // Keys created today
                    const keysToday = keys.filter(k => k.createdAt > todayStart).length;
                    document.getElementById('keysToday').textContent = keysToday;

                    // Average key lifetime
                    const activeKeys = keys.filter(k => k.active && now < k.expiresAt);
                    if (activeKeys.length > 0) {
                        const avgLifetime = activeKeys.reduce((sum, k) => {
                            return sum + (k.expiresAt - k.createdAt);
                        }, 0) / activeKeys.length;
                        const days = Math.floor(avgLifetime / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((avgLifetime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        document.getElementById('avgLifetime').textContent = `${days}d ${hours}h`;
                    } else {
                        document.getElementById('avgLifetime').textContent = 'N/A';
                    }

                    // Total rate limit capacity
                    const totalCapacity = keys.reduce((sum, k) => sum + (k.rateLimitPerHour || 0), 0);
                    const capacityUsed = keys.reduce((sum, k) => sum + (k.requestCount || 0), 0);
                    document.getElementById('totalCapacity').textContent = totalCapacity.toLocaleString() + '/hr';
                    const usagePercent = totalCapacity > 0 ? Math.round((capacityUsed / totalCapacity) * 100) : 0;
                    document.getElementById('capacityUsed').textContent = `${usagePercent}% utilized`;
                }

                // Usage chart by purpose
                const purposeCounts = {
                    interview: keys.filter(k => k.purpose === 'interview').length,
                    onboarding: keys.filter(k => k.purpose === 'onboarding').length,
                    trial: keys.filter(k => k.purpose === 'trial').length
                };
                const maxCount = Math.max(...Object.values(purposeCounts), 1);
                const chartContainer = document.getElementById('chartContainer');
                const usageChart = document.getElementById('usageChart');
                
                if (maxCount > 0) {
                    usageChart.style.display = 'block';
                    chartContainer.innerHTML = Object.entries(purposeCounts).map(([purpose, count]) => {
                        const width = (count / maxCount) * 100;
                        const purposeRequests = keys
                            .filter(k => k.purpose === purpose)
                            .reduce((sum, k) => sum + (k.requestCount || 0), 0);
                        return `
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="text-transform: capitalize; color: #b0b0b0;">${purpose}</span>
                                    <span style="color: #00d4ff; font-weight: 600;">${count} keys (${purposeRequests} requests)</span>
                                </div>
                                <div class="chart-bar" style="width: ${width}%;">${count}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    usageChart.style.display = 'none';
                }

                // Request distribution chart
                const requestRanges = [
                    { label: '0', min: 0, max: 0 },
                    { label: '1-10', min: 1, max: 10 },
                    { label: '11-50', min: 11, max: 50 },
                    { label: '51-100', min: 51, max: 100 },
                    { label: '100+', min: 101, max: Infinity }
                ];
                const requestDistribution = requestRanges.map(range => {
                    const count = keys.filter(k => {
                        const reqs = k.requestCount || 0;
                        return reqs >= range.min && reqs <= range.max;
                    }).length;
                    return { ...range, count };
                });
                const maxDistCount = Math.max(...requestDistribution.map(r => r.count), 1);
                const requestTrendChart = document.getElementById('requestTrendChart');
                const requestTrendContainer = document.getElementById('requestTrendContainer');
                
                if (keys.length > 0) {
                    requestTrendChart.style.display = 'block';
                    requestTrendContainer.innerHTML = requestDistribution.map(range => {
                        const width = (range.count / maxDistCount) * 100;
                        const percent = keys.length > 0 ? Math.round((range.count / keys.length) * 100) : 0;
                        return `
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: #b0b0b0;">${range.label} requests</span>
                                    <span style="color: #00d4ff; font-weight: 600;">${range.count} keys (${percent}%)</span>
                                </div>
                                <div class="chart-bar" style="width: ${width}%;">${range.count}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    requestTrendChart.style.display = 'none';
                }
            } catch (error) {
                showAlert(`Error loading stats: ${error.message}`, 'error');
            }
        }

        function exportKeys() {
            if (allKeys.length === 0) {
                showAlert('No keys to export', 'warning');
                return;
            }
            
            const format = prompt('Export format:\n1. JSON (default)\n2. CSV\nEnter 1 or 2:', '1');
            
            if (format === '2') {
                // CSV export
                const headers = ['ID', 'Email', 'Purpose', 'Created', 'Expires', 'Active', 'Rate Limit', 'Requests', 'Last Request'];
                const rows = allKeys.map(key => [
                    key.id,
                    key.email,
                    key.purpose,
                    new Date(key.createdAt).toISOString(),
                    new Date(key.expiresAt).toISOString(),
                    key.active ? 'Yes' : 'No',
                    key.rateLimitPerHour || 0,
                    key.requestCount || 0,
                    key.lastRequestAt ? new Date(key.lastRequestAt).toISOString() : 'Never'
                ]);
                
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                ].join('\n');
                
                const dataBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `workspace-keys-${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                URL.revokeObjectURL(url);
                showAlert('‚úÖ Keys exported as CSV!', 'success');
            } else {
                // JSON export
                const dataStr = JSON.stringify(allKeys, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `workspace-keys-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                showAlert('‚úÖ Keys exported as JSON!', 'success');
            }
        }

        function showCreateForm() {
            document.getElementById('createKeyForm').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('email').focus();
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.classList.remove('active');
                }
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Close modals with Escape
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
            // Focus search with Ctrl/Cmd+K
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            // New key with Ctrl/Cmd+N
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                showCreateForm();
            }
            // Refresh with Ctrl/Cmd+R (prevent default only if not in input)
            if ((e.ctrlKey || e.metaKey) && e.key === 'r' && 
                !['INPUT', 'TEXTAREA'].includes(document.activeElement?.tagName || '')) {
                e.preventDefault();
                refreshKeys();
                loadStats();
            }
        });

        // Show keyboard shortcuts help
        function showKeyboardShortcuts() {
            const shortcuts = [
                { key: 'Ctrl/Cmd + K', action: 'Focus search' },
                { key: 'Ctrl/Cmd + N', action: 'Create new key' },
                { key: 'Ctrl/Cmd + R', action: 'Refresh keys' },
                { key: 'Escape', action: 'Close modals' }
            ];
            
            const shortcutsHtml = shortcuts.map(s => 
                `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,212,255,0.2);">
                    <kbd style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; font-family: monospace;">${s.key}</kbd>
                    <span style="color: #b0b0b0;">${s.action}</span>
                </div>`
            ).join('');
            
            showAlert(`<strong>Keyboard Shortcuts:</strong><br>${shortcutsHtml}`, 'info');
            setTimeout(() => {
                document.getElementById('alertContainer').innerHTML = '';
            }, 8000);
        }

        // Initialize
        updatePurposeDefaults();
        
        // Initial load with slight delay to ensure DOM is ready
        setTimeout(() => {
            testConnection();
            refreshKeys();
            loadStats();
            loadPackageManagerConfig();
        }, 100);
        
        // Auto-refresh every 30 seconds
        let autoRefreshInterval = setInterval(() => {
            refreshKeys();
            loadStats();
            testConnection();
            loadPackageManagerConfig();
        }, 30000);

        // Pause auto-refresh when tab is hidden (save resources)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearInterval(autoRefreshInterval);
            } else {
                // Resume and immediately refresh
                refreshKeys();
                loadStats();
                testConnection();
                autoRefreshInterval = setInterval(() => {
                    refreshKeys();
                    loadStats();
                    testConnection();
                }, 30000);
            }
        });
    </script>
</body>
</html>
