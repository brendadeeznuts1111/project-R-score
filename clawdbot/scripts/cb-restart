#!/usr/bin/env bun
/**
 * cb-restart - Restart Clawdbot gateway in tmux
 * Usage: cb-restart [profile] [options]
 *
 * Profiles: full (default), minimal, dev
 * Options: --kill, --soft, --attach, --no-wait
 */

const GATEWAY_URL = "http://127.0.0.1:18789";
const BOT_TOKEN = "7873135075:AAHmySXcKIJpQ0KQX0aAOufB-VPMsdMF73Y";
const LOG_DIR = "/tmp/clawdbot";

interface Profile {
  name: string;
  windows: Array<{ name: string; command?: string }>;
  description: string;
}

const PROFILES: Record<string, Profile> = {
  minimal: {
    name: "minimal",
    description: "Gateway only",
    windows: [
      { name: "gateway", command: `clawdbot gateway --port 18789 2>&1 | tee ${LOG_DIR}/gateway.log` }
    ]
  },
  full: {
    name: "full",
    description: "Gateway + monitor + logs + tools + comms",
    windows: [
      { name: "gateway", command: `clawdbot gateway --port 18789 2>&1 | tee ${LOG_DIR}/gateway.log` },
      { name: "monitor" },
      { name: "logs", command: `tail -f ${LOG_DIR}/gateway.log` },
      { name: "tools" },
      { name: "comms" }
    ]
  },
  dev: {
    name: "dev",
    description: "Full + test + edit windows",
    windows: [
      { name: "gateway", command: `clawdbot gateway --port 18789 2>&1 | tee ${LOG_DIR}/gateway.log` },
      { name: "monitor" },
      { name: "logs", command: `tail -f ${LOG_DIR}/gateway.log` },
      { name: "tools" },
      { name: "comms" },
      { name: "test", command: "cd ~/clawd && echo 'Run: bun ./scripts/cb-test'" },
      { name: "edit", command: "cd ~/clawd && ls -la" }
    ]
  }
};

// Display helpers
const green = (t: string) => `\x1b[32m${t}\x1b[0m`;
const red = (t: string) => `\x1b[31m${t}\x1b[0m`;
const yellow = (t: string) => `\x1b[33m${t}\x1b[0m`;
const dim = (t: string) => `\x1b[2m${t}\x1b[0m`;

async function killSession(): Promise<boolean> {
  const proc = Bun.spawn(["tmux", "kill-session", "-t", "clawdbot"], {
    stdout: "ignore",
    stderr: "ignore",
  });
  const code = await proc.exited;
  return code === 0;
}

async function sessionExists(): Promise<boolean> {
  const proc = Bun.spawn(["tmux", "has-session", "-t", "clawdbot"], {
    stdout: "ignore",
    stderr: "ignore",
  });
  return await proc.exited === 0;
}

async function createSession(profile: Profile) {
  // Ensure log directory exists
  await Bun.spawn(["mkdir", "-p", LOG_DIR]).exited;

  // Create first window with session
  const firstWindow = profile.windows[0];
  const createArgs = ["tmux", "new-session", "-d", "-s", "clawdbot", "-n", firstWindow.name];
  if (firstWindow.command) {
    createArgs.push(firstWindow.command);
  }
  await Bun.spawn(createArgs).exited;

  // Create additional windows
  for (let i = 1; i < profile.windows.length; i++) {
    const win = profile.windows[i];
    await Bun.spawn(["tmux", "new-window", "-t", "clawdbot", "-n", win.name]).exited;

    if (win.command) {
      await Bun.spawn(["tmux", "send-keys", "-t", `clawdbot:${win.name}`, win.command, "Enter"]).exited;
    }
  }

  // Select gateway window
  await Bun.spawn(["tmux", "select-window", "-t", "clawdbot:gateway"]).exited;
}

async function softRestart() {
  // Send Ctrl-C to gateway window, then restart command
  await Bun.spawn(["tmux", "send-keys", "-t", "clawdbot:gateway", "C-c"]).exited;
  await Bun.sleep(500);
  await Bun.spawn([
    "tmux", "send-keys", "-t", "clawdbot:gateway",
    `clawdbot gateway --port 18789 2>&1 | tee ${LOG_DIR}/gateway.log`,
    "Enter"
  ]).exited;
}

interface HealthResult {
  gateway: boolean;
  telegram: boolean;
  latency: number;
}

async function checkHealth(): Promise<HealthResult> {
  const result: HealthResult = { gateway: false, telegram: false, latency: 0 };

  // Check gateway
  try {
    const start = Date.now();
    const res = await fetch(GATEWAY_URL);
    result.latency = Date.now() - start;
    result.gateway = res.ok;
  } catch {}

  // Check telegram (only if gateway is up)
  if (result.gateway) {
    try {
      const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getMe`);
      const data = await res.json();
      result.telegram = data.ok;
    } catch {}
  }

  return result;
}

async function waitForHealth(maxWait: number, showProgress: boolean): Promise<HealthResult | null> {
  const start = Date.now();
  const spinner = ["⠋", "⠙", "⠹", "⠸", "⠼", "⠴", "⠦", "⠧", "⠇", "⠏"];
  let spinIdx = 0;

  while (Date.now() - start < maxWait) {
    const health = await checkHealth();

    if (showProgress) {
      const elapsed = Math.round((Date.now() - start) / 1000);
      const status = health.gateway ? green("●") : yellow(spinner[spinIdx % spinner.length]);
      process.stdout.write(`\r    ${status} Waiting for gateway... ${elapsed}s`);
      spinIdx++;
    }

    if (health.gateway && health.telegram) {
      if (showProgress) process.stdout.write("\n");
      return health;
    }

    await Bun.sleep(500);
  }

  if (showProgress) process.stdout.write("\n");
  return null;
}

async function listWindows(): Promise<string[]> {
  const proc = Bun.spawn(["tmux", "list-windows", "-t", "clawdbot", "-F", "#{window_index}: #{window_name}"]);
  await proc.exited;
  const text = await new Response(proc.stdout).text();
  return text.trim().split("\n").filter(l => l.length > 0);
}

async function attachToSession() {
  const proc = Bun.spawn(["tmux", "attach", "-t", "clawdbot"], {
    stdin: "inherit",
    stdout: "inherit",
    stderr: "inherit",
  });
  await proc.exited;
}

function showHelp() {
  console.log(`
  ${green("cb-restart")} - Restart Clawdbot gateway in tmux

  Usage: cb-restart [profile] [options]

  Profiles:
    full      ${dim("(default)")} Gateway + monitor + logs + tools + comms
    minimal   Gateway only
    dev       Full + test + edit windows

  Options:
    --kill      Stop the session without restarting
    --soft      Restart gateway process only (keep tmux session)
    --attach    Attach to tmux after starting
    --no-wait   Don't wait for health check
    --help      Show this help

  Examples:
    cb-restart              # Restart with full profile
    cb-restart minimal      # Restart with minimal profile
    cb-restart --soft       # Soft restart gateway only
    cb-restart dev --attach # Start dev profile and attach
`);
}

async function main() {
  const args = Bun.argv.slice(2);

  // Parse options
  const killOnly = args.includes("--kill");
  const softMode = args.includes("--soft");
  const attachMode = args.includes("--attach");
  const noWait = args.includes("--no-wait");
  const helpMode = args.includes("--help") || args.includes("-h");

  if (helpMode) {
    showHelp();
    return;
  }

  // Get profile
  const profileArg = args.find(a => !a.startsWith("--"));
  const profileName = profileArg && PROFILES[profileArg] ? profileArg : "full";
  const profile = PROFILES[profileName];

  console.log("\n┌─────────────────────────────────────────┐");
  console.log("│          CLAWDBOT RESTART               │");
  console.log("└─────────────────────────────────────────┘\n");

  // Kill only mode
  if (killOnly) {
    console.log("  Stopping Clawdbot...");
    const existed = await killSession();
    if (existed) {
      console.log(`  ${green("✓")} Session killed\n`);
    } else {
      console.log(`  ${yellow("○")} No session was running\n`);
    }
    return;
  }

  // Soft restart mode
  if (softMode) {
    if (!await sessionExists()) {
      console.log(`  ${red("✗")} No tmux session found. Use 'cb-restart' instead.\n`);
      process.exit(1);
    }

    console.log("  Soft restarting gateway...");
    await softRestart();

    if (!noWait) {
      const health = await waitForHealth(10000, true);
      if (health) {
        console.log(`  ${green("✓")} Gateway restarted (${health.latency}ms)\n`);
      } else {
        console.log(`  ${red("✗")} Gateway failed to respond\n`);
        process.exit(1);
      }
    }

    if (attachMode) {
      await attachToSession();
    }
    return;
  }

  // Full restart
  console.log(`  Profile: ${green(profile.name)} ${dim(`(${profile.description})`)}`);

  // Stop existing
  if (await sessionExists()) {
    console.log("  Stopping existing session...");
    await killSession();
    await Bun.sleep(1000);
  }

  // Create new session
  console.log("  Creating tmux session...");
  await createSession(profile);

  // Wait for health
  if (!noWait) {
    const health = await waitForHealth(15000, true);

    if (health) {
      console.log(`\n  ${green("✓")} Gateway: up (${health.latency}ms)`);
      console.log(`  ${green("✓")} Telegram: connected`);
    } else {
      console.log(`\n  ${red("✗")} Gateway failed to start`);
      console.log(`  ${dim("Check logs: tail -f /tmp/clawdbot/gateway.log")}\n`);
      process.exit(1);
    }
  }

  // Show windows
  const windows = await listWindows();
  console.log("\n  Windows:");
  for (const win of windows) {
    console.log(`    ${win}`);
  }

  console.log(`\n  ${dim("Attach: tmux attach -t clawdbot")}`);
  console.log();

  // Attach if requested
  if (attachMode) {
    console.log("  Attaching to session...\n");
    await attachToSession();
  }
}

main();
