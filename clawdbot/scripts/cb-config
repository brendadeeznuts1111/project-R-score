#!/usr/bin/env bun
/**
 * cb-config - Clawdbot config viewer/editor
 * Usage: cb-config [path] [--edit] [--set key=value]
 */

const CONFIG_PATH = `${Bun.env.HOME}/.clawdbot/clawdbot.json`;

function getNestedValue(obj: any, path: string): any {
  return path.split(".").reduce((o, k) => o?.[k], obj);
}

function setNestedValue(obj: any, path: string, value: any): void {
  const keys = path.split(".");
  const last = keys.pop()!;
  const target = keys.reduce((o, k) => {
    if (!(k in o)) o[k] = {};
    return o[k];
  }, obj);
  target[last] = value;
}

async function readConfig(): Promise<any> {
  const file = Bun.file(CONFIG_PATH);
  return await file.json();
}

async function writeConfig(config: any): Promise<void> {
  await Bun.write(CONFIG_PATH, JSON.stringify(config, null, 2));
}

async function main() {
  const args = Bun.argv.slice(2);
  const editMode = args.includes("--edit");
  const setArg = args.find(a => a.startsWith("--set="));

  // Filter out flags
  const path = args.find(a => !a.startsWith("--"));

  const config = await readConfig();

  if (editMode) {
    // Open in editor
    const editor = Bun.env.EDITOR || "vim";
    const proc = Bun.spawn([editor, CONFIG_PATH], {
      stdin: "inherit",
      stdout: "inherit",
      stderr: "inherit",
    });
    await proc.exited;
    return;
  }

  if (setArg) {
    // Set value
    const [key, ...valueParts] = setArg.replace("--set=", "").split("=");
    let value: any = valueParts.join("=");

    // Try to parse as JSON
    try {
      value = JSON.parse(value);
    } catch {}

    setNestedValue(config, key, value);
    await writeConfig(config);
    console.log(`Set ${key} = ${JSON.stringify(value)}`);
    return;
  }

  if (path) {
    // Show specific path
    const value = getNestedValue(config, path);
    if (value === undefined) {
      console.log(`Path not found: ${path}`);
      process.exit(1);
    }
    console.log(JSON.stringify(value, null, 2));
  } else {
    // Show common paths
    console.log("\n┌─────────────────────────────────────────────────┐");
    console.log("│            CLAWDBOT CONFIG                      │");
    console.log("└─────────────────────────────────────────────────┘\n");

    console.log("  Model:    ", config.agents?.defaults?.model?.primary || "not set");
    console.log("  Gateway:  ", `port ${config.gateway?.port || "?"}`);
    console.log("  Telegram: ", config.channels?.telegram?.enabled ? "enabled" : "disabled");
    console.log("  Groups:   ", Object.keys(config.channels?.telegram?.groups || {}).length);
    console.log();
    console.log("  Paths:");
    console.log("    channels.telegram       Telegram settings");
    console.log("    channels.telegram.groups  Group configs");
    console.log("    agents.defaults.models  Model aliases");
    console.log("    messages                Message settings");
    console.log();
    console.log("  Usage:");
    console.log("    cb-config channels.telegram");
    console.log("    cb-config --edit");
    console.log("    cb-config --set=channels.telegram.mediaMaxMb=20");
    console.log();
  }
}

main();
