#!/usr/bin/env bun
/**
 * cb-attach - Smart tmux attach with window picker
 * Usage: cb-attach [window] [--list]
 */

interface Window {
  index: number;
  name: string;
  active: boolean;
  panes: number;
}

async function getWindows(): Promise<Window[]> {
  const proc = Bun.spawn(["tmux", "list-windows", "-t", "clawdbot", "-F", "#{window_index}:#{window_name}:#{window_active}:#{window_panes}"]);
  const exitCode = await proc.exited;

  if (exitCode !== 0) {
    return [];
  }

  const text = await new Response(proc.stdout).text();
  const windows: Window[] = [];

  for (const line of text.trim().split("\n")) {
    const [index, name, active, panes] = line.split(":");
    windows.push({
      index: parseInt(index),
      name,
      active: active === "1",
      panes: parseInt(panes),
    });
  }

  return windows;
}

async function attachToWindow(windowName?: string) {
  const args = windowName
    ? ["tmux", "attach", "-t", `clawdbot:${windowName}`]
    : ["tmux", "attach", "-t", "clawdbot"];

  const proc = Bun.spawn(args, {
    stdin: "inherit",
    stdout: "inherit",
    stderr: "inherit",
  });

  await proc.exited;
}

async function selectWindow(windows: Window[]): Promise<string | undefined> {
  console.log("\n  Select a window:\n");

  for (const w of windows) {
    const marker = w.active ? " *" : "  ";
    console.log(`  ${marker} ${w.index}: ${w.name} (${w.panes} pane${w.panes > 1 ? "s" : ""})`);
  }

  console.log();
  process.stdout.write("  Enter window name or number: ");

  // Read line from stdin
  const reader = Bun.stdin.stream().getReader();
  const { value } = await reader.read();
  reader.releaseLock();

  if (!value) return undefined;

  const input = new TextDecoder().decode(value).trim();

  // Find by name or index
  const byName = windows.find(w => w.name.toLowerCase() === input.toLowerCase());
  if (byName) return byName.name;

  const byIndex = windows.find(w => w.index === parseInt(input));
  if (byIndex) return byIndex.name;

  return input;
}

async function main() {
  const args = Bun.argv.slice(2);
  const listMode = args.includes("--list") || args.includes("-l");
  const windowArg = args.find(a => !a.startsWith("-"));

  const windows = await getWindows();

  if (windows.length === 0) {
    console.log("\n  \x1b[31m✗\x1b[0m No clawdbot tmux session found.");
    console.log("  Run: cb-restart --full\n");
    process.exit(1);
  }

  if (listMode) {
    console.log("\n┌─────────────────────────────────┐");
    console.log("│        CLAWDBOT WINDOWS         │");
    console.log("└─────────────────────────────────┘\n");

    for (const w of windows) {
      const marker = w.active ? "\x1b[32m●\x1b[0m" : " ";
      console.log(`  ${marker} ${w.index}: ${w.name}`);
    }

    console.log("\n  Usage: cb-attach <window>\n");
    return;
  }

  let targetWindow = windowArg;

  // If no window specified and multiple windows, prompt
  if (!targetWindow && windows.length > 1) {
    targetWindow = await selectWindow(windows);
  }

  if (targetWindow) {
    // Validate window exists
    const exists = windows.some(
      w => w.name === targetWindow || w.index === parseInt(targetWindow!)
    );

    if (!exists) {
      console.log(`\n  \x1b[31m✗\x1b[0m Window "${targetWindow}" not found.`);
      console.log(`  Available: ${windows.map(w => w.name).join(", ")}\n`);
      process.exit(1);
    }
  }

  console.log(`\n  Attaching to clawdbot${targetWindow ? `:${targetWindow}` : ""}...`);
  console.log("  (Detach with Ctrl+b d)\n");

  await attachToWindow(targetWindow);
}

main();
