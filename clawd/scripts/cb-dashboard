#!/usr/bin/env bun
/**
 * cb-dashboard - Web dashboard for Clawdbot status
 * Usage: cb-dashboard [--port 18793]
 */

const DEFAULT_PORT = 18793;
const GATEWAY_URL = "http://127.0.0.1:18789";
const WEBHOOK_URL = "http://127.0.0.1:18792";
const BOT_TOKEN = "7873135075:AAHmySXcKIJpQ0KQX0aAOufB-VPMsdMF73Y";

interface DashboardData {
  timestamp: string;
  gateway: { ok: boolean; latency?: number };
  telegram: { ok: boolean; username?: string };
  tmux: { ok: boolean; windows?: string[] };
  webhook: { ok: boolean; hooks?: number };
  cron: { ok: boolean; jobs?: number };
  skills: { count: number; names: string[] };
  system: {
    uptime: string;
    load: string;
    disk: string;
  };
}

async function collectData(): Promise<DashboardData> {
  const data: DashboardData = {
    timestamp: new Date().toISOString(),
    gateway: { ok: false },
    telegram: { ok: false },
    tmux: { ok: false },
    webhook: { ok: false },
    cron: { ok: false },
    skills: { count: 0, names: [] },
    system: { uptime: "", load: "", disk: "" }
  };

  // Check gateway
  try {
    const start = Date.now();
    const res = await fetch(GATEWAY_URL);
    data.gateway = { ok: res.ok, latency: Date.now() - start };
  } catch {}

  // Check Telegram
  try {
    const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getMe`);
    const json = await res.json();
    data.telegram = { ok: json.ok, username: json.result?.username };
  } catch {}

  // Check tmux
  try {
    const proc = Bun.spawn(["tmux", "list-windows", "-t", "clawdbot", "-F", "#{window_name}"]);
    const code = await proc.exited;
    if (code === 0) {
      const text = await new Response(proc.stdout).text();
      const windows = text.trim().split("\n").filter(l => l);
      data.tmux = { ok: true, windows };
    }
  } catch {}

  // Check webhook server
  try {
    const res = await fetch(`${WEBHOOK_URL}/status`);
    const json = await res.json();
    data.webhook = { ok: json.ok, hooks: json.hooks };
  } catch {}

  // Check cron config
  try {
    const file = Bun.file(`${Bun.env.HOME}/.clawdbot/cron.json`);
    if (await file.exists()) {
      const config = await file.json();
      const enabled = config.jobs.filter((j: any) => j.enabled).length;
      data.cron = { ok: true, jobs: enabled };
    }
  } catch {}

  // List skills
  try {
    const proc = Bun.spawn(["ls", `${Bun.env.HOME}/clawd/skills`]);
    await proc.exited;
    const text = await new Response(proc.stdout).text();
    const skills = text.trim().split("\n").filter(f => f.endsWith(".md")).map(f => f.replace(".md", ""));
    data.skills = { count: skills.length, names: skills };
  } catch {}

  // System info
  try {
    const uptimeProc = Bun.spawn(["uptime"]);
    await uptimeProc.exited;
    const uptimeText = await new Response(uptimeProc.stdout).text();

    const uptimeMatch = uptimeText.match(/up\s+(.+?),\s+\d+\s+user/);
    const loadMatch = uptimeText.match(/load average[s]?:\s+([\d.]+)/);

    data.system.uptime = uptimeMatch?.[1]?.trim() || "unknown";
    data.system.load = loadMatch?.[1] || "0";

    const dfProc = Bun.spawn(["df", "-h", "/"]);
    await dfProc.exited;
    const dfText = await new Response(dfProc.stdout).text();
    const dfParts = dfText.split("\n")[1]?.split(/\s+/);
    data.system.disk = dfParts?.[4] || "?";
  } catch {}

  return data;
}

function generateHTML(data: DashboardData): string {
  const statusDot = (ok: boolean) => ok
    ? '<span style="color:#4ade80">●</span>'
    : '<span style="color:#f87171">●</span>';

  return `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Clawdbot Dashboard</title>
  <meta http-equiv="refresh" content="10">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0a0a0a;
      color: #e5e5e5;
      min-height: 100vh;
      padding: 24px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { font-size: 24px; margin-bottom: 8px; }
    .subtitle { color: #737373; font-size: 14px; margin-bottom: 24px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
    .card {
      background: #171717;
      border: 1px solid #262626;
      border-radius: 12px;
      padding: 16px;
    }
    .card-title {
      font-size: 14px;
      color: #a3a3a3;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #262626;
    }
    .status-row:last-child { border-bottom: none; }
    .status-label { font-weight: 500; }
    .status-value { color: #a3a3a3; font-size: 14px; }
    .skills-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .skill-tag {
      background: #262626;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 13px;
    }
    .windows-list {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .window-tag {
      background: #1e3a2f;
      color: #4ade80;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 13px;
    }
    .actions {
      margin-top: 24px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn {
      background: #262626;
      border: 1px solid #404040;
      color: #e5e5e5;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
    }
    .btn:hover { background: #333; }
    .footer {
      margin-top: 32px;
      text-align: center;
      color: #525252;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Clawdbot Dashboard</h1>
    <p class="subtitle">Last updated: ${new Date(data.timestamp).toLocaleString()}</p>

    <div class="grid">
      <div class="card">
        <div class="card-title">Services</div>
        <div class="status-row">
          <span class="status-label">${statusDot(data.gateway.ok)} Gateway</span>
          <span class="status-value">${data.gateway.ok ? `${data.gateway.latency}ms` : "offline"}</span>
        </div>
        <div class="status-row">
          <span class="status-label">${statusDot(data.telegram.ok)} Telegram</span>
          <span class="status-value">${data.telegram.ok ? `@${data.telegram.username}` : "disconnected"}</span>
        </div>
        <div class="status-row">
          <span class="status-label">${statusDot(data.tmux.ok)} tmux</span>
          <span class="status-value">${data.tmux.ok ? `${data.tmux.windows?.length} windows` : "no session"}</span>
        </div>
        <div class="status-row">
          <span class="status-label">${statusDot(data.webhook.ok)} Webhooks</span>
          <span class="status-value">${data.webhook.ok ? `${data.webhook.hooks} hooks` : "offline"}</span>
        </div>
        <div class="status-row">
          <span class="status-label">${statusDot(data.cron.ok)} Scheduler</span>
          <span class="status-value">${data.cron.ok ? `${data.cron.jobs} jobs` : "not configured"}</span>
        </div>
      </div>

      <div class="card">
        <div class="card-title">System</div>
        <div class="status-row">
          <span class="status-label">Uptime</span>
          <span class="status-value">${data.system.uptime}</span>
        </div>
        <div class="status-row">
          <span class="status-label">Load</span>
          <span class="status-value">${data.system.load}</span>
        </div>
        <div class="status-row">
          <span class="status-label">Disk</span>
          <span class="status-value">${data.system.disk} used</span>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Skills (${data.skills.count})</div>
        <div class="skills-list">
          ${data.skills.names.map(s => `<span class="skill-tag">${s}</span>`).join("")}
        </div>
      </div>

      <div class="card">
        <div class="card-title">tmux Windows</div>
        <div class="windows-list">
          ${data.tmux.windows?.map(w => `<span class="window-tag">${w}</span>`).join("") || '<span style="color:#737373">No session</span>'}
        </div>
      </div>
    </div>

    <div class="actions">
      <a class="btn" href="/api/status">API Status</a>
      <a class="btn" href="/api/restart" onclick="return confirm('Restart gateway?')">Restart</a>
      <a class="btn" href="/api/test">Run Tests</a>
    </div>

    <div class="footer">
      Auto-refresh every 10s · Port ${DEFAULT_PORT}
    </div>
  </div>
</body>
</html>`;
}

function createServer(port: number) {
  return Bun.serve({
    port,
    async fetch(req) {
      const url = new URL(req.url);
      const path = url.pathname;

      // API endpoints
      if (path === "/api/status") {
        const data = await collectData();
        return Response.json(data);
      }

      if (path === "/api/restart") {
        const proc = Bun.spawn(["bun", `${Bun.env.HOME}/clawd/scripts/cb-restart`, "--soft"]);
        await proc.exited;
        return Response.redirect("/");
      }

      if (path === "/api/test") {
        const proc = Bun.spawn(["bun", `${Bun.env.HOME}/clawd/scripts/cb-test`, "--json"]);
        const output = await new Response(proc.stdout).text();
        return new Response(output, {
          headers: { "Content-Type": "application/json" }
        });
      }

      // Dashboard HTML
      const data = await collectData();
      const html = generateHTML(data);

      return new Response(html, {
        headers: { "Content-Type": "text/html" }
      });
    }
  });
}

async function main() {
  const args = Bun.argv.slice(2);

  const portArg = args.find(a => a.startsWith("--port="));
  const port = portArg ? parseInt(portArg.split("=")[1]) : DEFAULT_PORT;

  if (args.includes("--help") || args.includes("-h")) {
    console.log(`
  cb-dashboard - Web dashboard for Clawdbot

  Usage: cb-dashboard [--port=PORT]

  Endpoints:
    /           Dashboard HTML (auto-refresh)
    /api/status JSON status data
    /api/restart Trigger soft restart
    /api/test   Run test suite

  Default port: ${DEFAULT_PORT}
`);
    return;
  }

  console.log(`\n  Dashboard running at http://localhost:${port}\n`);
  createServer(port);
}

main();
