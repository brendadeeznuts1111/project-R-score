#!/usr/bin/env bun
/**
 * cb-logs - Smart log viewer for Clawdbot
 * Usage: cb-logs [--follow] [--errors] [--telegram] [--json] [lines]
 */

const LOG_DIR = "/tmp/clawdbot";
const GATEWAY_LOG = `${LOG_DIR}/gateway.log`;

function getLogFile(): string {
  const today = new Date().toISOString().split("T")[0];
  return `${LOG_DIR}/clawdbot-${today}.log`;
}

async function tailLog(file: string, lines: number, follow: boolean) {
  const args = follow ? ["-f", "-n", String(lines), file] : ["-n", String(lines), file];
  const proc = Bun.spawn(["tail", ...args], {
    stdout: "inherit",
    stderr: "inherit",
  });
  await proc.exited;
}

async function filterLogs(filter: string, lines: number) {
  const logFile = getLogFile();
  const file = Bun.file(logFile);

  if (!(await file.exists())) {
    console.log(`Log file not found: ${logFile}`);
    return;
  }

  const text = await file.text();
  const allLines = text.trim().split("\n");

  let filtered = allLines;

  if (filter === "errors") {
    filtered = allLines.filter(l =>
      l.includes("error") || l.includes("Error") || l.includes("ERROR") || l.includes("fail")
    );
  } else if (filter === "telegram") {
    filtered = allLines.filter(l =>
      l.includes("telegram") || l.includes("Telegram") || l.includes("chat")
    );
  }

  const output = filtered.slice(-lines);

  for (const line of output) {
    try {
      const parsed = JSON.parse(line);
      const msg = parsed["1"] || parsed["0"] || line;
      const time = parsed.time?.split("T")[1]?.slice(0, 8) || "";
      console.log(`[${time}] ${typeof msg === "string" ? msg : JSON.stringify(msg)}`);
    } catch {
      console.log(line);
    }
  }
}

async function main() {
  const args = Bun.argv.slice(2);
  const follow = args.includes("--follow") || args.includes("-f");
  const errors = args.includes("--errors");
  const telegram = args.includes("--telegram");
  const jsonMode = args.includes("--json");

  // Get line count from args
  const lineArg = args.find(a => /^\d+$/.test(a));
  const lines = lineArg ? parseInt(lineArg) : 50;

  if (jsonMode) {
    // Show raw JSON log
    await tailLog(getLogFile(), lines, follow);
  } else if (errors) {
    await filterLogs("errors", lines);
  } else if (telegram) {
    await filterLogs("telegram", lines);
  } else if (follow) {
    // Follow gateway log (more readable)
    await tailLog(GATEWAY_LOG, lines, true);
  } else {
    // Default: show gateway log
    await tailLog(GATEWAY_LOG, lines, false);
  }
}

main();
