name: Build Feature Variants

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'package.json'
      - 'bunfig.toml'
      - '.github/workflows/build-variants.yml'
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-variants:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant:
          - name: Production
            features: ''
            outdir: 'dist/prod'
          - name: Development
            features: '--feature=DEVELOPMENT --feature=DEBUG --feature=MOCK_API'
            outdir: 'dist/dev'
          - name: Enterprise
            features: '--feature=ENTERPRISE --feature=PREMIUM_SECRETS --feature=R2_STORAGE'
            outdir: 'dist/enterprise'
          - name: Testing
            features: '--feature=MOCK_API --feature=DEBUG'
            outdir: 'dist/test'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Build ${{ matrix.variant.name }}
        run: |
          mkdir -p ${{ matrix.variant.outdir }}
          bun build \
            ${{ matrix.variant.features }} \
            --minify \
            src/examples/registry-features.ts \
            --outdir ${{ matrix.variant.outdir }}
      
      - name: Analyze bundle size
        id: bundle-size
        run: |
          size=$(stat --format=%s ${{ matrix.variant.outdir }}/registry-features.js)
          size_kb=$(echo "scale=2; $size / 1024" | bc)
          echo "size_bytes=$size" >> $GITHUB_OUTPUT
          echo "size_kb=$size_kb" >> $GITHUB_OUTPUT
          echo "**${{ matrix.variant.name }}:** $size_kb KB ($size bytes)" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: build-${{ matrix.variant.name }}
          path: ${{ matrix.variant.outdir }}/
          retention-days: 30
  
  bundle-comparison:
    needs: build-variants
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3
      
      - name: Compare bundle sizes
        run: |
          echo "## Bundle Size Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Variant | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          
          for variant in build-Production build-Development build-Enterprise build-Testing; do
            if [ -f "$variant/registry-features.js" ]; then
              size=$(stat --format=%s "$variant/registry-features.js")
              size_kb=$(echo "scale=2; $size / 1024" | bc)
              variant_name=$(echo "$variant" | sed 's/build-//')
              echo "| $variant_name | $size_kb KB |" >> $GITHUB_STEP_SUMMARY
            fi
          done
      
      - name: Check bundle size regression
        run: |
          prod_size=$(stat --format=%s build-Production/registry-features.js 2>/dev/null || echo 0)
          
          if [ $prod_size -eq 0 ]; then
            echo "⚠️ Could not find production bundle"
            exit 1
          fi
          
          # Warn if production bundle exceeds threshold (e.g., 2KB)
          max_size=$((2 * 1024))
          if [ $prod_size -gt $max_size ]; then
            echo "⚠️ Production bundle size ($prod_size bytes) exceeds threshold ($max_size bytes)"
          else
            echo "✅ Production bundle size is acceptable: $prod_size bytes"
          fi

  test-builds:
    needs: build-variants
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Run tests with MOCK_API
        run: bun run test:mock
      
      - name: Run tests with ENTERPRISE
        run: bun run test:enterprise
      
      - name: Run example with DEBUG
        run: bun run --feature=DEBUG src/examples/registry-features.ts

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Bun security audit
        run: bun audit
        continue-on-error: true
