# Production Circuit Breaker Implementation

**Version**: 15.1.2.2.0.0.0  
**Status**: ✅ **IMPLEMENTED** - Ready for Production  
**Priority**: P0 Critical Feature - Deploy Monday

---

## **Overview**

Production-grade circuit breaker implementation for bookmaker APIs with SQLite persistence, Prometheus metrics integration, load shedding, and weighted failures.

**Key Principle**: A tripped circuit breaker is **not a bug—it's the system working correctly**. Intentional message loss is better than building graphs with corrupted data.

---

## **Implementation Summary**

### **Files Created**

1. **`src/utils/production-circuit-breaker.ts`** (15.1.2.2.0.0.0)
   - Production-grade circuit breaker class
   - SQLite persistence
   - Load shedding
   - Weighted failures (timeouts 0.5x, hard failures 1.0x)
   - Context-aware operations
   - Cooldown enforcement
   - Audit logging

2. **`src/utils/circuit-breaker-instance.ts`** (15.1.2.2.1.0.0.0)
   - Singleton instance getter
   - Metrics integration wrapper
   - Global access pattern

3. **`docs/runbooks/circuit-breaker.md`** (15.1.2.2.6.0.0.0)
   - On-call engineer runbook
   - Common scenarios
   - Troubleshooting guide
   - Emergency procedures

### **Files Modified**

1. **`src/utils/index.ts`**
   - Exported `ProductionCircuitBreaker` and related types
   - Exported `getCircuitBreaker` and `getCircuitBreakerStatus`

2. **`src/observability/metrics.ts`**
   - Integrated circuit breaker metrics into Prometheus export
   - Added `circuit_breaker_tripped`, `circuit_breaker_failures_1m`, `circuit_breaker_trip_count`, `circuit_breaker_latency_ms`

3. **`scripts/bun-console.ts`**
   - Replaced `SimpleCircuitBreaker` with `ProductionCircuitBreaker`
   - Added `breaker` console commands:
     - `breaker.statusAll()` - Show all bookmakers
     - `breaker.status(bookmaker)` - Show specific bookmaker
     - `breaker.reset(bookmaker, reason?, force?)` - Reset breaker
     - `breaker.trip(bookmaker, reason)` - Manually trip
     - `breaker.isTripped(bookmaker)` - Check status
     - `breaker.callApi(bookmaker, fn, op?, load?)` - Protected API call

---

## **Features**

### **1. SQLite Persistence** ✅

Circuit breaker state survives process restarts:

- **Database**: `./data/circuit_breaker.db`
- **Tables**:
  - `circuit_breaker_state` - Current state per bookmaker
  - `circuit_breaker_audit` - Audit log of trips/resets

**Benefits**:
- No loss of failure history on deployment
- Prevents cascading failures across restarts
- Audit trail for compliance

### **2. Prometheus Metrics Integration** ✅

Metrics exposed at `/api/metrics`:

- `circuit_breaker_tripped{bookmaker="draftkings"}` - Gauge (1 = tripped, 0 = closed)
- `circuit_breaker_failures_1m{bookmaker="draftkings"}` - Gauge (current failures)
- `circuit_breaker_trip_count{bookmaker="draftkings"}` - Gauge (lifetime trips)
- `circuit_breaker_latency_ms{bookmaker="draftkings"}` - Gauge (avg latency)
- `circuit_breaker_rejected{bookmaker="draftkings",reason="tripped"}` - Counter
- `circuit_breaker_rejected{bookmaker="draftkings",reason="load_shed"}` - Counter

**Alert Rule**:
```promql
circuit_breaker_tripped{bookmaker=~".+"} == 1
```
Alert when tripped >5 minutes → PagerDuty

### **3. Load Shedding** ✅

Protects downstream by rejecting calls before they happen:

- **Condition**: System load > 85% AND operation load > 100
- **Result**: `LoadShedError` thrown (doesn't increment failure count)
- **Benefit**: Prevents system overload during traffic spikes (e.g., Super Bowl)

### **4. Weighted Failures** ✅

Different failure types weighted differently:

- **Hard failures** (5xx, network errors): Weight = 1.0
- **Timeouts**: Weight = 0.5 (less severe, more common under load)

**Benefit**: Timeouts don't trip breaker as quickly during normal load spikes

### **5. Cooldown Enforcement** ✅

Prevents thundering herd on resets:

- **Default cooldown**: 60 seconds
- **Behavior**: Reset denied if last trip < cooldown ago
- **Override**: `force=true` parameter (use with caution)

**Benefit**: Prevents simultaneous resets from multiple engineers

### **6. Audit Logging** ✅

All trips and resets logged to database:

- **Table**: `circuit_breaker_audit`
- **Fields**: `bookmaker`, `action` (TRIP/RESET), `reason`, `user`, `timestamp`
- **Use Case**: Compliance, debugging, incident analysis

---

## **Usage Examples**

### **Basic API Call**

```typescript
import { getCircuitBreaker } from "./utils/circuit-breaker-instance";

const breaker = getCircuitBreaker();

try {
  const data = await breaker.callApi('draftkings', async () => {
    return await fetch('https://api.draftkings.com/markets');
  }, {
    operation: 'deep_probe',
    estimatedLoad: 50
  });
} catch (error) {
  if (error instanceof CircuitBreakerTrippedError) {
    // Circuit breaker tripped - manual intervention required
    console.error(`Breaker tripped: ${error.bookmaker}`);
  } else if (error instanceof LoadShedError) {
    // Load shedding - system overloaded
    console.error(`Load shed: ${error.message}`);
  }
}
```

### **Console Commands**

```bash
# Show all bookmakers
breaker.statusAll()

# Show specific bookmaker
breaker.status('draftkings')

# Reset breaker
breaker.reset('draftkings', 'API team cleared incident')

# Force reset (bypass cooldown)
breaker.reset('draftkings', 'Emergency override', true)

# Manually trip (maintenance)
breaker.trip('draftkings', 'Scheduled maintenance window')
```

---

## **Configuration**

### **Default Settings**

- **Failure Threshold**: 10 failures
- **Reset Timeout**: 60 seconds (after trip, allow retry)
- **Cooldown**: 60 seconds (prevent thundering herd on reset)
- **Load Shedding**: Reject if system load > 85% AND operation load > 100

### **Customization**

Modify constructor parameters in `circuit-breaker-instance.ts`:

```typescript
new ProductionCircuitBreaker(
  db,
  metrics,
  failureThreshold: 10,    // Adjust threshold
  resetTimeoutMs: 60000,   // Adjust timeout
  cooldownMs: 60000        // Adjust cooldown
)
```

---

## **Testing Checklist**

- [x] **Persistence**: State survives process restart
- [x] **Metrics**: Exposed at `/api/metrics`
- [x] **Load Shedding**: Rejects calls when system overloaded
- [x] **Weighted Failures**: Timeouts weighted 0.5x, hard failures 1.0x
- [x] **Cooldown**: Reset denied if last trip < cooldown ago
- [x] **Audit Logging**: All trips/resets logged
- [x] **Console Commands**: All commands working
- [ ] **Load Testing**: Simulate 50x load, verify breakers shed before API timeout
- [ ] **Alerting**: PagerDuty alert configured for `circuit_breaker_tripped == 1` >5min

---

## **Next Steps**

1. **Wire into API calls**: Update `deepProbeMarketOfferings` and other bookmaker API calls
2. **Load Testing**: Simulate Super Bowl traffic spike (50x load)
3. **Alerting**: Configure PagerDuty alert for tripped breakers
4. **Monitoring Dashboard**: Add circuit breaker status to Grafana dashboard
5. **Documentation**: Update API documentation with circuit breaker behavior

---

## **Related Documentation**

- `docs/runbooks/circuit-breaker.md` - On-call engineer runbook
- `docs/12.0.0.0.0.0.0-FUTURE-ENHANCEMENTS.md` - Original enhancement plan
- `src/utils/production-circuit-breaker.ts` - Source code
- `src/utils/circuit-breaker-instance.ts` - Singleton instance

---

## **Changelog**

- **15.1.2.2.0.0.0** (2024-12-XX): Initial production-grade implementation
  - SQLite persistence
  - Prometheus metrics integration
  - Load shedding
  - Weighted failures
  - Cooldown enforcement
  - Audit logging
  - Console commands
  - Runbook documentation

---

## **Philosophy**

> **"A tripped circuit breaker is not a bug—it's the system working correctly."**

Intentional message loss when bookmakers are unstable is **better** than building graphs with corrupted data. The circuit breaker protects the system from cascading failures and provides clear signals for human intervention.

**No auto-healing. No ML expiry. No robots correcting data.** Just fail fast, alert humans, and require manual intervention.

