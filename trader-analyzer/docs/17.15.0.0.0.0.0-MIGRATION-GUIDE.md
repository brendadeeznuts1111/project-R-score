# 17.15.0.0.0.0.0 — Migration Guide

**From Legacy Routes → Radiance v17**

---

## Overview

This guide helps you migrate from legacy (unversioned) routes to Radiance v17 routes with full type safety and Radiance headers.

---

## Route Migration

### Registry Routes

| Legacy Route | v17 Route | Notes |
|-------------|-----------|-------|
| `/api/registry/properties` | `/api/v17/registry/properties` | Full Radiance headers |
| `/api/registry/mcp-tools` | `/api/v17/registry/mcp-tools` | Type-safe responses |
| `/api/registry/sharp-books` | `/api/v17/registry/sharp-books` | Filter support |
| `/api/registry/data-sources` | `/api/v17/registry/data-sources` | RBAC preserved |

### Mini App Routes

| Legacy Route | v17 Route | Notes |
|-------------|-----------|-------|
| `/api/miniapp/sportsbooks` | `/api/v17/telegram/miniapp/sportsbooks` | Versioned |
| `/api/miniapp/markets` | `/api/v17/telegram/miniapp/markets` | Versioned |
| `/api/miniapp/status` | `/api/v17/telegram/miniapp/status` | Versioned |

### WebSocket Routes

| Legacy Route | v17 Route | Notes |
|-------------|-----------|-------|
| `/ws/pubsub` | `/ws/v17/pubsub` | Radiance pub-sub |
| `/ws/radiance` | `/ws/v17/radiance` | Identity server |
| `/ws/log-stream` | `/ws/v17/log-stream` | Log streaming |

---

## Function Migration

### Before (Legacy)

```typescript
import { getRegistriesOverview } from "./api/registry";

const overview = await getRegistriesOverview();
```

### After (v17)

```typescript
import { queryPropertiesRegistry17 } from "./17.15.0.0.0.0.0-radiance/index.17";

const props = await queryPropertiesRegistry17({
  namespace: "users"
});
```

---

## Type Migration

### Before (Legacy)

```typescript
interface PropertyItem {
  id: string;
  name: string;
  schema?: any;
}
```

### After (v17)

```typescript
import type { PropertyDefinition } from "./17.15.0.0.0.0.0-radiance/index.17";

// PropertyDefinition is RadianceTyped with:
// - __category: "properties"
// - __version: "17.15.0"
// - __radianceChannel: "radiance-properties"
// - __semanticType: "PropertyDefinition"
```

---

## Header Migration

### Before (Legacy)

```http
Content-Type: application/json
```

### After (v17)

```http
Content-Type: application/radiance+json; version=17.15; schema=PropertyDefinition
X-Radiance-Version: 17.15.0
X-Radiance-Channel: radiance-properties
X-Registry-ID: properties
X-Semantic-Type: PropertyDefinition
X-Compression: permessage-deflate
X-Timestamp: 1734123456789
X-Trace-ID: rad-17-15-9f3a1c
```

---

## Code Examples

### Query Registry

```typescript
// Legacy
const { getRegistriesOverview } = await import("./api/registry");
const overview = await getRegistriesOverview();

// v17
import { queryPropertiesRegistry17 } from "./17.15.0.0.0.0.0-radiance/index.17";
const props = await queryPropertiesRegistry17({ namespace: "users" });
```

### Use Routes

```typescript
// Legacy
app.get("/api/registry/properties", handler);

// v17
import { v17 } from "./17.15.0.0.0.0.0-radiance/routing.v17";
app.get(v17.registry.properties, handler);
```

### Apply Middleware

```typescript
// Legacy
app.get("/api/registry/properties", handler);

// v17
import { radianceMiddleware17 } from "./17.15.0.0.0.0.0-radiance/middleware.radiance.17";
app.use("*", radianceMiddleware17({ version: "17.15.0" }));
app.get(v17.registry.properties, handler);
```

---

## Testing Migration

### Test v17 Routes

```bash
# Properties
curl -H "Accept: application/radiance+json" \
     http://localhost:3001/api/v17/registry/properties

# MCP Tools
curl http://localhost:3001/api/v17/registry/mcp-tools

# Sharp Books with filters
curl "http://localhost:3001/api/v17/registry/sharp-books?tier=1&status=active"

# Health checks
curl http://localhost:3001/api/v17/registry/properties/health
```

### Verify Headers

```bash
curl -I http://localhost:3001/api/v17/registry/properties | grep -i "x-radiance"
```

Expected output:
```
X-Radiance-Version: 17.15.0
X-Radiance-Channel: radiance-properties
X-Registry-ID: properties
X-Semantic-Type: PropertyDefinition
Content-Type: application/radiance+json; version=17.15; schema=PropertyDefinition
```

---

## Backward Compatibility

**Legacy routes remain functional** for backward compatibility. However, new code should use v17 routes for:

- Type safety
- Radiance headers
- Versioned contracts
- Future-proofing

---

## Checklist

- [ ] Update imports to use `17.15.0.0.0.0.0-radiance/index.17`
- [ ] Replace legacy function calls with `queryXRegistry17()`
- [ ] Update routes to use `v17.registry.*` constants
- [ ] Apply `radianceMiddleware17()` to routes
- [ ] Update type annotations to `RadianceTyped<T>`
- [ ] Test all endpoints with v17 routes
- [ ] Verify Radiance headers are present
- [ ] Update documentation references

---

**Version**: 17.15.0.0.0.0.0  
**Status**: ✅ Migration Ready
