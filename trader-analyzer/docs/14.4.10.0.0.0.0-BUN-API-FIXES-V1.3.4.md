# **[INTEGRATION] Hyper-Bun v1.3.4: Bun API Fixes for Production Stability**

**Metadata**: `[[TECH][MODULE][INTEGRATION][META:{blueprint=BP-BUN-API-FIXES@1.3.4;instance-id=BUN-API-FIXES-001;version=1.3.4}][PROPERTIES:{integration={value:"bun-v1.3.4-api-fixes";@root:"14.0.0.0.0.0.0";@chain:["BP-MLGS-DEBUGGING","BP-BUN-API"];@version:"1.3.4"}}][CLASS:BunAPIFixesIntegration][#REF:v-1.3.4.BP.BUN.API.FIXES.1.0.A.1.1.DOC.1.1]]`

---

### **14.4.10.0.0.0.0 Bun v1.3.4 API Fixes for Hyper-Bun**

This subsystem documents critical Bun API fixes in v1.3.4 that directly impact Hyper-Bun's production stability, security, and reliability. These fixes address fuzzer-detected issues, crash prevention, and edge case handling.

**Official Source**: [Bun v1.3.4 Release Notes - Bun APIs fixes](https://bun.com/blog/bun-v1.3.4#bun-apis-fixes)

---

#### **14.4.10.1.0.0.0.0 Bun.secrets Async Context Manager Fix**

**Mechanism**: Fixed crash when `Bun.secrets` is called inside `AsyncLocalStorage.run()` or other async context managers.

**Benefit for Hyper-Bun**:

- **Stability**: Prevents crashes in async context managers used throughout the codebase
- **Security**: Ensures secret access works correctly in async middleware chains
- **Reliability**: Eliminates race conditions in secret retrieval

**Integration**:

- Critical for `src/secrets/` module which uses `AsyncLocalStorage` for context propagation
- Affects `src/middleware/csrf.ts` which accesses secrets in async contexts
- Impacts `src/clients/proxy-config-service.ts` which uses secrets in async operations

**Direct Example**:

```typescript
// In src/secrets/secret-manager.ts: Now safe in async contexts
import { AsyncLocalStorage } from 'async_hooks';

const asyncLocalStorage = new AsyncLocalStorage();

async function getSecret(key: string): Promise<string> {
  return asyncLocalStorage.run({}, async () => {
    // Previously could crash, now works correctly
    return await Bun.secrets[key];
  });
}
```

**`@example` Formula**: Verify `Bun.secrets` works in `AsyncLocalStorage.run()`.

**Test**: `const result = await AsyncLocalStorage.run({}, async () => Bun.secrets['MY_KEY']);`

**Expected Result**: Returns secret value without crashing (previously crashed in v1.3.3).

---

#### **14.4.10.2.0.0.0.0 Bun.mmap Input Validation Fix**

**Mechanism**: Fixed fuzzer-detected assertion failure when `offset` or `size` options are non-numeric values (null, function, etc.). Now properly validates and rejects negative values with clear error messages.

**Benefit for Hyper-Bun**:

- **Crash Prevention**: Prevents assertion failures from invalid input
- **Better Error Messages**: Clear validation errors instead of crashes
- **Security**: Prevents potential memory corruption from invalid offsets

**Integration**:

- Critical for `src/utils/binary-tag-collection.ts` which uses `Bun.mmap()` for efficient binary data handling
- Affects `src/orca/sharp-books/` which uses memory-mapped files for bookmaker data
- Impacts any code using `Bun.mmap()` for large file operations

**Direct Example**:

```typescript
// In src/utils/binary-tag-collection.ts: Now validates input properly
try {
  // Previously could crash with assertion failure
  const mapped = Bun.mmap('data.bin', {
    offset: null, // Now throws clear error instead of crashing
    size: -1,     // Now validates and rejects negative values
  });
} catch (error) {
  // Clear error message: "offset must be a non-negative number"
  console.error('Memory mapping failed:', error.message);
}
```

**`@example` Formula**: Test `Bun.mmap()` with invalid input.

**Test**: `Bun.mmap('file.bin', { offset: null, size: -1 })`

**Expected Result**: Throws clear validation error instead of crashing (previously assertion failure in v1.3.3).

---

#### **14.4.10.3.0.0.0.0 Bun.plugin Error Handling Fix**

**Mechanism**: `Bun.plugin()` now properly returns an error instead of potentially crashing when an invalid `target` option is provided.

**Benefit for Hyper-Bun**:

- **Graceful Failure**: Returns errors instead of crashing
- **Better Debugging**: Clear error messages for invalid plugin configurations
- **Stability**: Prevents crashes during plugin initialization

**Integration**:

- Critical for `src/mcp/` plugins which use `Bun.plugin()` for FFI integration
- Affects `src/workers/` which may use plugins for native bindings
- Impacts any custom plugin development

**Direct Example**:

```typescript
// In src/mcp/plugins/ffi-plugin.ts: Now handles invalid targets gracefully
try {
  Bun.plugin({
    name: 'my-plugin',
    target: 'invalid-target', // Now returns error instead of crashing
  });
} catch (error) {
  // Clear error: "Invalid target option: invalid-target"
  console.error('Plugin initialization failed:', error.message);
}
```

**`@example` Formula**: Test `Bun.plugin()` with invalid target.

**Test**: `Bun.plugin({ name: 'test', target: 'invalid' })`

**Expected Result**: Throws clear error instead of crashing (previously could crash in v1.3.3).

---

#### **14.4.10.4.0.0.0.0 Bun.FFI.CString Constructor Fix**

**Mechanism**: Fixed regression introduced in v1.2.3 where `new Bun.FFI.CString(ptr)` threw "function is not a constructor" error. Now works correctly.

**Benefit for Hyper-Bun**:

- **FFI Compatibility**: Restores correct FFI string handling
- **Regression Fix**: Fixes issue introduced in v1.2.3
- **Native Integration**: Enables proper C string handling in FFI calls

**Integration**:

- Critical for `src/mcp/plugins/` which use FFI for native integrations
- Affects any code using `Bun.FFI.CString` for C string conversions
- Impacts native library bindings

**Direct Example**:

```typescript
// In src/mcp/plugins/native-bindings.ts: Now works correctly
import { dlopen, CString } from 'bun:ffi';

const lib = dlopen('libnative.so', {
  getString: {
    args: ['ptr'],
    returns: CString, // Now can be used as constructor
  },
});

// Previously threw "function is not a constructor" error
const result = new CString(ptr); // Now works correctly
```

**`@example` Formula**: Test `Bun.FFI.CString` constructor.

**Test**: `new Bun.FFI.CString(ptr)`

**Expected Result**: Creates CString instance without error (previously threw "function is not a constructor" in v1.2.3-v1.3.3).

---

#### **14.4.10.5.0.0.0.0 Class Constructor Validation Fix**

**Mechanism**: Fixed fuzzer-detected assertion failure caused by calling class constructors (like `Bun.RedisClient`) without `new`. These constructors now properly throw `TypeError: Class constructor X cannot be invoked without 'new'`.

**Benefit for Hyper-Bun**:

- **Crash Prevention**: Prevents assertion failures from incorrect constructor usage
- **Better Error Messages**: Clear TypeError instead of crashes
- **Developer Experience**: Helps catch bugs during development

**Integration**:

- **Future-proof for `src/cache/redis.ts`**: Currently `Bun.Redis` is not available in Bun v1.3.3, but when it becomes available, this fix ensures proper constructor usage (see line 209: `const redis = new Redis(redisUrl)`)
- **Active usage**: All `Bun.CryptoHasher` instances (20+ usages) correctly use `new` keyword
- **Active usage**: All `Bun.Transpiler` instances correctly use `new` keyword
- Affects any code using Bun class constructors (`FileSystemRouter`, `Plugin`, etc.)
- Impacts `src/workers/` which may instantiate Bun classes

**Direct Example**:

```typescript
// In src/cache/redis-cache.ts: Now throws clear error
try {
  // Previously could crash with assertion failure
  const client = Bun.RedisClient(); // Missing 'new'
} catch (error) {
  // Clear error: "TypeError: Class constructor RedisClient cannot be invoked without 'new'"
  console.error('Constructor error:', error.message);
}

// Correct usage
const client = new Bun.RedisClient(); // Works correctly
```

**`@example` Formula**: Test class constructor without `new`.

**Test**: `Bun.RedisClient()` (without `new`)

**Expected Result**: Throws `TypeError` with clear message instead of crashing (previously assertion failure in v1.3.3).

---

#### **14.4.10.6.0.0.0.0 Glob.scan() Boundary Fix**

**Mechanism**: Fixed `Glob.scan()` escaping `cwd` boundary when using patterns like `.*/*` or `.*/**/*.t`, which incorrectly traversed into parent directories instead of matching hidden files/directories.

**Benefit for Hyper-Bun**:

- **Security**: Prevents directory traversal vulnerabilities
- **Correct Behavior**: Properly matches hidden files/directories
- **Predictability**: Respects `cwd` boundary as expected

**Integration**:

- Critical for `scripts/mcp-scaffold.ts` which uses glob patterns for file discovery
- Affects `scripts/metadata-refresh.ts` which scans for manifest files
- Impacts any code using `Glob.scan()` for file matching

**Direct Example**:

```typescript
// In scripts/mcp-scaffold.ts: Now respects cwd boundary
import { Glob } from 'bun';

const glob = new Glob('.*/*.ts'); // Match hidden files
const files = Array.from(glob.scan('.'));

// Previously could traverse into parent directories
// Now correctly matches only hidden files in current directory
console.log(files); // ['.hidden/file.ts', '.config/setup.ts']
```

**`@example` Formula**: Test `Glob.scan()` with hidden file pattern.

**Test**: `new Glob('.*/*').scan('.')`

**Expected Result**: Matches only hidden files in current directory, doesn't traverse parent directories (previously traversed parent in v1.3.3).

---

#### **14.4.10.7.0.0.0.0 Bun.indexOfLine Input Validation Fix**

**Mechanism**: Fixed fuzzer-detected issue in `Bun.indexOfLine()` when called with a non-number `offset` argument. Now properly validates input.

**Benefit for Hyper-Bun**:

- **Crash Prevention**: Prevents assertion failures from invalid input
- **Input Validation**: Clear error messages for invalid arguments
- **Stability**: Handles edge cases gracefully

**Integration**:

- Critical for `src/logging/` which may use `indexOfLine()` for log parsing
- Affects any code parsing line-based text files
- Impacts `src/utils/changelog-display.ts` which processes line-based content

**Direct Example**:

```typescript
// In src/logging/log-parser.ts: Now validates input
try {
  // Previously could crash with assertion failure
  const index = Bun.indexOfLine('file.log', null); // Invalid offset
} catch (error) {
  // Clear error: "offset must be a number"
  console.error('Line index failed:', error.message);
}
```

**`@example` Formula**: Test `Bun.indexOfLine()` with invalid offset.

**Test**: `Bun.indexOfLine('file.txt', null)`

**Expected Result**: Throws clear validation error instead of crashing (previously assertion failure in v1.3.3).

---

#### **14.4.10.8.0.0.0.0 FormData.from() Large Buffer Fix**

**Mechanism**: Fixed fuzzer-detected issue in `FormData.from()` when called with very large `ArrayBuffer` input (>2GB). Now throws a proper error instead of crashing.

**Benefit for Hyper-Bun**:

- **Memory Safety**: Prevents crashes from excessive memory allocation
- **Error Handling**: Clear error messages for oversized inputs
- **Resource Protection**: Prevents OOM conditions

**Integration**:

- Critical for `src/api/routes.ts` which handles file uploads via FormData
- Affects `src/telegram/rss-poster.ts` which may process large file attachments
- Impacts any code handling large file uploads

**Direct Example**:

```typescript
// In src/api/file-upload.ts: Now handles large buffers gracefully
try {
  const largeBuffer = new ArrayBuffer(3 * 1024 * 1024 * 1024); // >2GB
  const formData = FormData.from({
    file: new Blob([largeBuffer]),
  });
} catch (error) {
  // Clear error: "FormData input exceeds maximum size of 2GB"
  console.error('FormData creation failed:', error.message);
}
```

**`@example` Formula**: Test `FormData.from()` with >2GB buffer.

**Test**: `FormData.from({ file: new Blob([new ArrayBuffer(3 * 1024 * 1024 * 1024)]) })`

**Expected Result**: Throws clear error instead of crashing (previously could crash in v1.3.3).

---

#### **14.4.10.9.0.0.0.0 ReadableStream Error Handling Fix**

**Mechanism**: Fixed fuzzer-detected bug when creating empty or used `ReadableStream` that could cause errors to be silently ignored.

**Benefit for Hyper-Bun**:

- **Error Visibility**: Errors are now properly propagated instead of being silently ignored
- **Debugging**: Makes it easier to diagnose stream-related issues
- **Reliability**: Prevents silent failures in stream-based operations

**Integration**:

- Critical for `src/orca/streaming/` which uses `ReadableStream` for bookmaker data ingestion
- Affects `src/api/websocket/` which may use streams for real-time data
- Impacts any code creating or reusing `ReadableStream` instances

**Direct Example**:

```typescript
// In src/orca/streaming/bookmaker-adapter.ts: Now properly handles errors
try {
  const stream = new ReadableStream({
    start(controller) {
      // Previously errors could be silently ignored
      controller.enqueue(data);
    }
  });
  
  // Reusing a stream that was already read
  const reader = stream.getReader();
  await reader.read();
  await reader.read(); // Previously could silently ignore errors
} catch (error) {
  // Now properly catches and reports errors
  console.error('Stream error:', error.message);
}
```

**`@example` Formula**: Test `ReadableStream` error handling.

**Test**: Create a `ReadableStream`, read from it, then try to read again.

**Expected Result**: Throws clear error instead of silently ignoring (previously could silently fail in v1.3.3).

---

### **Summary: Production-Stable Hyper-Bun Platform**

These Bun v1.3.4 API fixes provide critical stability improvements:

1. **Async Context Safety**: `Bun.secrets` works correctly in async context managers
2. **Input Validation**: All APIs now validate input and provide clear error messages
3. **Crash Prevention**: Fuzzer-detected issues fixed prevent production crashes
4. **Security**: Directory traversal and memory safety improvements
5. **Regression Fixes**: Restores functionality broken in earlier versions
6. **Error Visibility**: `ReadableStream` errors are now properly propagated instead of silently ignored

**This integration ensures Hyper-Bun leverages Bun's latest stability fixes for maximum reliability in production market intelligence operations.**

---

## Implementation Files

- `src/secrets/` - `Bun.secrets` async context usage
- `src/utils/binary-tag-collection.ts` - `Bun.mmap()` usage
- `src/mcp/plugins/` - `Bun.plugin()` and `Bun.FFI.CString` usage
- `src/cache/` - `Bun.RedisClient` constructor usage
- `scripts/mcp-scaffold.ts` - `Glob.scan()` usage
- `src/api/routes.ts` - `FormData.from()` usage
- `src/orca/streaming/` - `ReadableStream` error handling

---

## Related Documentation

- [`docs/14.4.0.0.0.0.0-BUN-RUNTIME-ENHANCEMENTS.md`](./14.4.0.0.0.0.0-BUN-RUNTIME-ENHANCEMENTS.md) - Bun runtime enhancements
- [`docs/BUN-V1.3.3-PRODUCTION-RUNTIME-ENHANCEMENTS.md`](./BUN-V1.3.3-PRODUCTION-RUNTIME-ENHANCEMENTS.md) - Production runtime enhancements
- [`docs/BUN-1.3.51.1-RUNTIME-FIXES-AND-IMPROVEMENTS.md`](./BUN-1.3.51.1-RUNTIME-FIXES-AND-IMPROVEMENTS.md) - Runtime fixes and improvements
- [Bun v1.3.4 Release Notes - Bun APIs fixes](https://bun.com/blog/bun-v1.3.4#bun-apis-fixes) - Official release notes (source of truth)

---

**Author**: NEXUS Team  
**Version**: Bun v1.3.4+  
**Last Updated**: 2025-12-08



