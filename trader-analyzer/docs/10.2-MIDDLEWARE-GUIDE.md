# Middleware Guide: Authentication & Session Management

**Version**: 10.2.0.0.0.0  
**Component**: Middleware Composition  
**Status**: ✅ Implemented

---

## Overview

Middleware utilities for composing authentication, session management, and CSRF protection in a clean, reusable way.

---

## Available Middleware

### 1. Session Middleware (`src/middleware/session-middleware.ts`)

**Validate Session**:
```typescript
import { SessionMiddleware } from './middleware/session-middleware';

// Require valid session
const handler = withMiddleware(
  myHandler,
  SessionMiddleware.validate
);

// Optional session (doesn't fail if missing)
const handler = withMiddleware(
  myHandler,
  (req, next) => SessionMiddleware.validate(req, next, { required: false })
);
```

**Attach User ID**:
```typescript
const handler = withMiddleware(
  myHandler,
  SessionMiddleware.validate,
  SessionMiddleware.attachUser  // Adds req.userId
);
```

---

### 2. CSRF Middleware (`src/middleware/csrf-middleware.ts`)

**Validate CSRF Token**:
```typescript
import { CSRFMiddleware } from './middleware/csrf-middleware';

const handler = withMiddleware(
  myHandler,
  CSRFMiddleware.validate  // Validates X-CSRF-Token header
);
```

**Generate CSRF Token**:
```typescript
const handler = withMiddleware(
  myHandler,
  CSRFMiddleware.generate  // Adds X-CSRF-Token header to response
);
```

---

### 3. Cookie Middleware (`src/middleware/cookie-middleware.ts`)

**Validate Cookie Options**:
```typescript
import { CookieMiddleware } from './middleware/cookie-middleware';

const validatedOptions = CookieMiddleware.validateCookieOptions(
  'session_token',
  { maxAge: 86400 },
  request.url
);
```

---

## Middleware Composition

### Basic Composition

```typescript
import { composeMiddleware, withMiddleware } from './utils/middleware-composer';

// Compose multiple middleware
const middleware = composeMiddleware(
  SessionMiddleware.validate,
  SessionMiddleware.attachUser,
  CSRFMiddleware.validate
);

// Apply to handler
const protectedHandler = withMiddleware(
  myHandler,
  middleware
);
```

### Example: Protected Route

```typescript
async function protectedHandler(request: Request): Promise<Response> {
  const userId = (request as any).userId; // Attached by middleware
  
  return new Response(
    JSON.stringify({ userId, message: 'Protected' }),
    { headers: { 'Content-Type': 'application/json' } }
  );
}

export const protectedRoute = withMiddleware(
  protectedHandler,
  SessionMiddleware.validate,    // Require session
  SessionMiddleware.attachUser,   // Attach userId
  CSRFMiddleware.validate         // Require CSRF token
);
```

### Example: Public Route with CSRF

```typescript
async function publicHandler(request: Request): Promise<Response> {
  return new Response(
    JSON.stringify({ message: 'Public' }),
    { headers: { 'Content-Type': 'application/json' } }
  );
}

export const publicRoute = withMiddleware(
  publicHandler,
  CSRFMiddleware.generate  // Generate CSRF token for client
);
```

---

## Complete Server Example

```typescript
import { serve } from 'bun';
import { withMiddleware } from './utils/middleware-composer';
import { SessionMiddleware } from './middleware/session-middleware';
import { CSRFMiddleware } from './middleware/csrf-middleware';

// Protected handler
const protectedHandler = withMiddleware(
  async (req: Request) => {
    const userId = (req as any).userId;
    return new Response(JSON.stringify({ userId }));
  },
  SessionMiddleware.validate,
  SessionMiddleware.attachUser,
  CSRFMiddleware.validate
);

// Public handler
const publicHandler = withMiddleware(
  async (req: Request) => {
    return new Response(JSON.stringify({ message: 'Public' }));
  },
  CSRFMiddleware.generate
);

serve({
  async fetch(request: Request): Promise<Response> {
    const url = new URL(request.url);
    
    if (url.pathname === '/api/protected') {
      return await protectedHandler(request);
    }
    
    if (url.pathname === '/api/public') {
      return await publicHandler(request);
    }
    
    return new Response('Not Found', { status: 404 });
  },
});
```

---

## Middleware Order

**Recommended Order**:
1. Session validation (if required)
2. User attachment (if session valid)
3. CSRF validation (for state-changing requests)
4. Business logic handler

---

## Error Handling

Middleware automatically returns appropriate error responses:

- **401 Unauthorized**: Invalid or missing session
- **403 Forbidden**: Invalid CSRF token

---

## Usage Examples

See `examples/middleware-composition.ts` for complete examples.

Run example:
```bash
bun example:bun-1.3:middleware
```

---

## Cross-References

- [10.0.0.0.0.0.0-AUTHENTICATION-SESSION-MANAGEMENT.md](./10.0.0.0.0.0.0-AUTHENTICATION-SESSION-MANAGEMENT.md) - Main documentation
- [10.1-IMPLEMENTATION-GUIDE.md](./10.1-IMPLEMENTATION-GUIDE.md) - Implementation guide

---

**Status**: ✅ Ready for Use
