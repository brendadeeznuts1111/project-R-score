# Proxy Configuration Management Service

**Version**: 12.6.0.0.0.0.0  
**Status**: âœ… **IMPLEMENTED** - Production Ready  
**Priority**: P0 Critical Feature

---

## Overview

The `ProxyConfigService` provides dynamic proxy rotation, health monitoring, and tight integration with Circuit Breaker, ensuring highly resilient and adaptable external API communication for Hyper-Bun's bookmaker integrations.

**ðŸ“Š Related Dashboards**:
- [Multi-Layer Graph Dashboard](./../dashboard/multi-layer-graph.html) - Visualize proxy health metrics and connection pool stats
- [MLGS Developer Dashboard](./../dashboard/mlgs-developer-dashboard.html) - Monitor circuit breaker integration
- [Main Dashboard](./../dashboard/index.html) - System-wide proxy health monitoring

---

## Features

### 12.6.1.0.0.0.0 Core Implementation

- âœ… **SQLite Persistence**: All proxy configurations stored in `./data/proxy-config.db`
- âœ… **Dynamic Proxy Selection**: Multiple strategies (round-robin, least-errors, weighted-random, health-score)
- âœ… **Health Monitoring**: Real-time health scoring (0-100) based on success rate and latency
- âœ… **Automatic Token Management**: Integrates with `Bun.secrets` for secure proxy authentication
- âœ… **Scheduled Health Checks**: Background worker performs health checks every 5 minutes
- âœ… **Circuit Breaker Integration**: Tight coupling with `CircuitBreaker` for failure tracking

### 12.6.2.0.0.0.0 Health Monitoring & Alerting

- âœ… **Scheduled Health Checks**: Lightweight ping tests through each proxy
- âœ… **Health Score Calculation**: Weighted average of success rate (70%) and latency (30%)
- âœ… **Metrics Tracking**: Prometheus-style metrics for each proxy
- âœ… **Structured Logging**: All proxy events logged with `HBPC-*` codes

### 12.6.3.0.0.0.0 Integration Points

- âœ… **BookmakerApiClient17**: Automatic proxy injection via `ProxyConfigService`
- âœ… **TickDataCollector17**: Proxy service passed to bookmaker clients
- âœ… **Console Integration**: `mlgs.proxy.list()` and `mlgs.proxy.health()` commands

---

## Usage Examples

### Basic Usage

```typescript
import { Database } from "bun:sqlite"
import { StructuredLogger } from "../logging/structured-logger"
import { ProxyConfigService } from "../clients/proxy-config-service"
import { BookmakerApiClient17 } from "../clients/BookmakerApiClient17"

// Initialize service
const db = new Database("./data/proxy-config.db", { create: true })
const logger = new StructuredLogger()
const proxyService = new ProxyConfigService(db, logger)

// Create bookmaker client with proxy support
const client = new BookmakerApiClient17("draftkings", {}, proxyService)

// Fetch data (automatically uses best proxy)
const data = await client.fetch("/api/v1/markets")
```

### Adding a Proxy

```typescript
await proxyService.addProxy({
  url: "http://proxy.example.com:8080",
  type: "HTTP",
  isEnabled: true,
  bookmakers: ["draftkings", "betfair"],
  headers: {
    "X-Custom-Header": "value"
  }
})
```

### Listing Proxies

```typescript
// All proxies
const allProxies = await proxyService.listProxies()

// Proxies for specific bookmaker
const draftkingsProxies = await proxyService.listProxies("draftkings")
```

### Console Commands

```bash
# List all proxies
bun run console
> mlgs.proxy.list()

# List proxies for specific bookmaker
> mlgs.proxy.list("draftkings")

# Check proxy health
> mlgs.proxy.health()

# Check specific proxy health
> mlgs.proxy.health("proxy-123")
```

---

## Proxy Selection Strategies

### Health Score (Default)
Selects proxy with highest health score (â‰¥20), filtering out unhealthy proxies.

### Round Robin
Cycles through available proxies in order.

### Least Errors
Selects proxy with lowest error count.

### Weighted Random
Random selection weighted by health score.

---

## Health Score Calculation

Health score is calculated as:
- **70%** success rate (successful requests / total requests)
- **30%** latency score (lower latency = higher score, max 100ms = 100 points)
- **10% penalty** for recent errors

Formula:
```
healthScore = (successRate * 100 * 0.7) + (latencyScore * 0.3)
if (recentError) healthScore *= 0.9
```

---

## Logging Codes

- `HBPC-001`: Proxy selected successfully
- `HBPC-002`: No proxy available / selection failed
- `HBPC-003`: Proxy healthy (health check)
- `HBPC-004`: Proxy unhealthy (health check)
- `HBPC-005`: Proxy not found
- `HBPC-006`: Health update failed
- `HBPC-007`: Health check worker error
- `HBPC-008`: Individual proxy health check error

---

## Database Schema

```sql
CREATE TABLE proxy_entries (
  id TEXT PRIMARY KEY,
  url TEXT NOT NULL,
  headers TEXT, -- JSON string
  type TEXT NOT NULL CHECK(type IN ('HTTP', 'HTTPS', 'SOCKS5')),
  is_enabled INTEGER NOT NULL DEFAULT 1,
  health_score REAL NOT NULL DEFAULT 100.0,
  last_checked INTEGER NOT NULL DEFAULT 0,
  error_count INTEGER NOT NULL DEFAULT 0,
  success_count INTEGER NOT NULL DEFAULT 0,
  total_latency REAL NOT NULL DEFAULT 0,
  bookmakers TEXT NOT NULL, -- JSON array
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);
```

---

## Integration with BookmakerApiClient17

The enhanced `BookmakerApiClient17` automatically:
1. Requests proxy from `ProxyConfigService` for each bookmaker
2. Uses selected proxy for `fetch()` requests
3. Updates proxy health on success/failure
4. Falls back to direct connection if no proxy available

---

## Strategic Impact

- **Dynamic Resilience**: Automatically routes through healthy proxies
- **Enhanced Evasion**: Sophisticated proxy rotation makes traffic patterns harder to identify
- **Centralized Control**: All proxy config in one place
- **Granular Observability**: Deep insights into proxy infrastructure performance
- **Minimized Data Interruption**: Adapts to proxy failures, maintaining consistent data flow

---

## Files Created

- `src/clients/proxy-config-service.ts` - Core ProxyConfigService implementation
- `docs/12.6.0.0.0.0.0-PROXY-CONFIG-SERVICE.md` - This documentation

## Files Modified

- `src/clients/BookmakerApiClient17.ts` - Integrated ProxyConfigService support
- `src/ticks/collector-17.ts` - Pass ProxyConfigService to bookmaker clients
- `scripts/bun-console.ts` - Added `mlgs.proxy.*` console commands

---

## Status

âœ… **PRODUCTION READY** - All features implemented and tested

---

## Related Documentation

- [`BUN-1.3.51.1-CUSTOM-PROXY-HEADERS-INTEGRATION.md`](./BUN-1.3.51.1-CUSTOM-PROXY-HEADERS-INTEGRATION.md) - Complete Custom Proxy Headers Integration Guide with regional proxy configuration, test formulas, performance benchmarks, and security best practices
- [`BUN-1.3.3-INTEGRATION-COMPLETE.md`](./BUN-1.3.3-INTEGRATION-COMPLETE.md) - Bun v1.3.3 integration guide (section 6.1.1.2.2.8.1.1.2.7.2.13)
- [`BUN-HTTP-AGENT-CONNECTION-POOL.md`](./BUN-HTTP-AGENT-CONNECTION-POOL.md) - Connection pool improvements that work with proxy connections

---

**Last Updated**: 2025-12-08
