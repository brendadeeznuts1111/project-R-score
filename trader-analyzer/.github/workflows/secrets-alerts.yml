# Secrets Management Alert Rules
# Prometheus alert rules for secret access monitoring
#
# Reference: @docs/BUN-SECRETS-DOD-COMPLETION.md
# Reference: @docs/VERIFY-SECRETS-METRICS.md

groups:
  - name: secrets_management
    interval: 30s
    rules:
      # Unauthorized Secret Access Alert
      - alert: UnauthorizedSecretAccess
        expr: rate(hyperbun_secret_access_total{status="denied"}[5m]) > 0.1
        for: 1m
        labels:
          severity: critical
          subsystem: secrets
          log_code: HBSE-006
        annotations:
          summary: "Potential secret compromise attempt detected"
          description: "Rate of denied secret access attempts exceeds threshold (>0.1/min)"
          runbook: "docs/security/incident-response.md"
          action: |
            1. IMMEDIATE: Review audit logs for HBSE-006 codes
            2. VERIFY: Check operator roles and permissions
            3. ESCALATE: If pattern detected, rotate affected secrets
            4. NOTIFY: Alert security team per incident response plan

      # Secret Rotation Overdue Alert
      - alert: SecretRotationOverdue
        expr: |
          (
            time() - hyperbun_secret_rotation_timestamp{service="nexus"}
          ) > 7776000  # 90 days in seconds
        for: 24h
        labels:
          severity: high
          subsystem: secrets
          log_code: HBSE-005
        annotations:
          summary: "Secret requires rotation per compliance policy"
          description: "Secret has not been rotated in 90+ days (compliance violation)"
          runbook: "docs/operators/secrets-management.md"
          action: |
            1. Run: bun run secrets:rotate:status
            2. Rotate: bun run secrets:rotate:cron rotate
            3. Verify: Check rotation timestamp updated

      # Secret Validation Errors Alert
      - alert: SecretValidationErrors
        expr: rate(hyperbun_secret_validation_errors_total[5m]) > 0.5
        for: 5m
        labels:
          severity: medium
          subsystem: secrets
          log_code: HBSE-007
        annotations:
          summary: "High rate of secret validation errors"
          description: "Secret validation failures exceed threshold (>0.5/min)"
          runbook: "docs/operators/secrets-management.md"
          action: |
            1. Review validation error logs (HBSE-007)
            2. Check secret format requirements
            3. Verify API clients are using correct format

      # Emergency Rotation Executed Alert
      - alert: EmergencyRotationExecuted
        expr: increase(hyperbun_emergency_rotation_total[1h]) > 0
        for: 0m
        labels:
          severity: critical
          subsystem: secrets
        annotations:
          summary: "Emergency secret rotation executed"
          description: "Emergency rotation detected - potential security incident"
          runbook: "docs/security/incident-response.md"
          action: |
            1. IMMEDIATE: Review incident response procedures
            2. VERIFY: Check audit_log for unauthorized access
            3. NOTIFY: Alert compliance team per incident response plan
            4. AUDIT: Review all secret access logs for compromise indicators

      # Secret Access Error Rate Alert
      - alert: SecretAccessErrors
        expr: rate(hyperbun_secret_access_total{status="error"}[5m]) > 0.2
        for: 5m
        labels:
          severity: high
          subsystem: secrets
          log_code: HBSE-004
        annotations:
          summary: "High rate of secret access errors"
          description: "Secret access failures exceed threshold (>0.2/min)"
          runbook: "docs/operators/secrets-management.md"
          action: |
            1. Check keychain integrity (macOS: Keychain Access)
            2. Verify file permissions on keychain DB
            3. Review HBSE-004 error logs
            4. ESCALATE: If tampering suspected, rotate all secrets
