name: P0 Security Checks

on:
  pull_request:
    labels:
      - p0
      - security
  push:
    branches:
      - main

jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install
        run: bun install --frozen-lockfile

      - name: Dependency Guard
        run: bun run security:guard:deps
      
      - name: Check for event-stream
        run: |
          if bun pm ls event-stream 2>/dev/null | grep -q event-stream; then
            echo "❌ event-stream found in dependencies"
            exit 1
          fi
          echo "✅ event-stream not found"
      
      - name: Check unused dependencies
        run: |
          # Check for express, axios, chalk
          for dep in express axios chalk; do
            if grep -q "\"$dep\"" package.json; then
              echo "⚠️  $dep found in package.json - verify if used"
            fi
          done
      
      - name: Verify CORS configuration
        run: |
          if [ -f feedback-server.ts ]; then
            if grep -q 'origin: "*"' feedback-server.ts; then
              echo "❌ Wildcard CORS found"
              exit 1
            fi
            echo "✅ CORS properly configured"
          else
            echo "ℹ️ feedback-server.ts not present, skipping CORS grep check"
          fi
      
      - name: Check authentication
        run: |
          if [ -f feedback-server.ts ]; then
            # Verify auth middleware exists
            if ! grep -q "requireAuth\|requireApiKey" feedback-server.ts; then
              echo "⚠️  Authentication middleware not found"
            fi
          else
            echo "ℹ️ feedback-server.ts not present, skipping authentication grep check"
          fi
      
      - name: Check token hashing
        run: |
          if [ -f pm.ts ]; then
            if grep -q "console.log.*token.*\$\{" pm.ts; then
              echo "❌ Plaintext token logging found"
              exit 1
            fi
            echo "✅ Token hashing verified"
          else
            echo "ℹ️ pm.ts not present, skipping token hashing grep check"
          fi

      - name: Bun Security Audit
        run: bun run security:audit
