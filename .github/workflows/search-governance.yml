name: Search Governance

on:
  pull_request:
  push:
    branches:
      - main
      - feat/**
      - codex/**

jobs:
  governance:
    runs-on: ubuntu-latest
    env:
      SEARCH_BENCH_QUERY_TIMEOUT_MS: "60000"
      SEARCH_BENCH_QUERY_RETRIES: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install
        run: bun install --frozen-lockfile

      - name: Dependency Guard
        run: bun run security:guard:deps

      - name: Policy Governance Guard
        run: bun run scripts/check-search-policy-governance.ts

      - name: Search Status Contract Tests
        run: bun test tests/search-status-contract.test.ts

      - name: Unified Search Status Strict Gate
        run: bun run search:status:unified:strict

      - name: Domain Registry Contract Tests
        run: bun test tests/domain-registry.test.ts tests/domain-registry-status.test.ts

      - name: Domain Registry Status Smoke
        run: bun run scripts/domain-registry-status.ts --json

      - name: Verify Pinned Search Benchmark Baseline
        run: test -f .search/search-benchmark-pinned-baseline.core_delivery_wide.json || test -f .search/search-benchmark-pinned-baseline.json

      - name: Generate Search Benchmark Snapshot (Core Wide, Local)
        run: bun run search:bench:snapshot:core:wide:local

      - name: Search Benchmark Regression Gate
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p reports/search-benchmark
          bun run search:bench:gate --json | tee reports/search-benchmark/compare-gate.json

      - name: Upload Search Governance Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: search-governance-artifacts
          if-no-files-found: warn
          path: |
            reports/search-benchmark/latest.json
            reports/search-benchmark/latest.md
            reports/search-benchmark/index.json
            reports/search-benchmark/rss.xml
            reports/search-benchmark/compare-gate.json
            reports/search-benchmark/*/snapshot.json
            reports/search-benchmark/*/summary.md
            reports/search-benchmark/*/publish-manifest.json
            .search/search-benchmark-pinned-baseline*.json
