name: Issue Automation and Metrics

on:
  issues:
    types: [opened, closed, labeled, unlabeled, assigned]
  pull_request:
    types: [opened, closed, merged]
  schedule:
    # Run metrics collection daily at 9 AM UTC
    - cron: '0 9 * * *'

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Auto-assign issues based on labels
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);
            
            // Assign based on label patterns
            if (labels.includes('security') || labels.includes('critical-security')) {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                assignees: ['brendadeeznuts1111']
              });
              
              // Add team label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['team-security']
              });
            }
            
            if (labels.includes('performance') || labels.includes('performance-optimization')) {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                assignees: ['brendadeeznuts1111']
              });
              
              // Add team label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['team-performance']
              });
            }
            
            if (labels.includes('bun-native') || labels.includes('resource-management')) {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                assignees: ['brendadeeznuts1111']
              });
              
              // Add team label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['team-infrastructure']
              });
            }

  collect-metrics:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Collect issue metrics
        uses: actions/github-script@v7
        with:
          script: |
            // Get all issues with metrics
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });

            const metrics = {
              total: issues.data.length,
              open: issues.data.filter(i => i.state === 'open').length,
              closed: issues.data.filter(i => i.state === 'closed').length,
              by_priority: {
                p0: issues.data.filter(i => i.labels.some(l => l.name === 'p0')).length,
                p1: issues.data.filter(i => i.labels.some(l => l.name === 'p1')).length,
                p2: issues.data.filter(i => i.labels.some(l => l.name === 'p2')).length
              },
              by_team: {
                security: issues.data.filter(i => i.labels.some(l => l.name === 'team-security')).length,
                performance: issues.data.filter(i => i.labels.some(l => l.name === 'team-performance')).length,
                infrastructure: issues.data.filter(i => i.labels.some(l => l.name === 'team-infrastructure')).length
              },
              by_type: {
                bugs: issues.data.filter(i => i.labels.some(l => l.name === 'bug')).length,
                enhancements: issues.data.filter(i => i.labels.some(l => l.name === 'enhancement')).length
              },
              bun_native: issues.data.filter(i => i.labels.some(l => l.name === 'bun-native')).length
            };

            // Create metrics report
            const report = `
# ğŸ“Š FactoryWager Issue Metrics Report
**Generated**: ${new Date().toISOString()}

## ğŸ“ˆ Overview
- **Total Issues**: ${metrics.total}
- **Open**: ${metrics.open} ğŸ”´
- **Closed**: ${metrics.closed} âœ…
- **Open Rate**: ${((metrics.open / metrics.total) * 100).toFixed(1)}%

## ğŸ¯ Priority Breakdown
- **P0 (Critical)**: ${metrics.by_priority.p0} ğŸ”´
- **P1 (High)**: ${metrics.by_priority.p1} ğŸŸ   
- **P2 (Medium)**: ${metrics.by_priority.p2} ğŸŸ¢

## ğŸ‘¥ Team Assignment
- **Security Team**: ${metrics.by_team.security} ğŸ”
- **Performance Team**: ${metrics.by_team.performance} âš¡
- **Infrastructure Team**: ${metrics.by_team.infrastructure} ğŸ—ï¸

## ğŸ“‹ Type Distribution
- **Bugs**: ${metrics.by_type.bugs} ğŸ›
- **Enhancements**: ${metrics.by_type.enhancements} âœ¨

## ğŸ”§ Bun Native Issues
- **Total Bun Native**: ${metrics.bun_native} ğŸ¦Š
- **Percentage**: ${((metrics.bun_native / metrics.total) * 100).toFixed(1)}%

## ğŸ“Š Resolution Rate
- **Resolution Rate**: ${((metrics.closed / metrics.total) * 100).toFixed(1)}%
            `;

            // Post to a dedicated issue or create/update metrics file
            console.log('Metrics Report:');
            console.log(report);

  update-project-board:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'
    steps:
      - name: Update project board
        uses: actions/github-script@v7
        with:
          script: |
            // This would integrate with GitHub Projects (if configured)
            // For now, we'll just log the action
            const issue = context.payload.issue;
            const action = context.payload.action;
            
            console.log(`Issue ${action}: #${issue.number} - ${issue.title}`);
            
            // Add to project board based on priority and team
            if (action === 'opened') {
              console.log('Adding to project board...');
              // Project board automation would go here
            }
