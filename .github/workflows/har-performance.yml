name: HAR Performance Monitoring

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  performance-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Start test server
        run: |
          bun run src/server/enhanced-server.ts &
          echo "SERVER_PID=$!" >> $GITHUB_ENV
          sleep 3

      - name: Download baseline HAR (if exists)
        uses: actions/download-artifact@v4
        with:
          name: baseline-har
          path: ./artifacts
        continue-on-error: true

      - name: Capture HAR
        run: |
          bun src/cli/har-cli.ts capture \
            --port 3000 \
            --duration 30 \
            --output current.har &
          CAPTURE_PID=$!
          
          # Run load test
          bun run scripts/load-test.ts || true
          
          wait $CAPTURE_PID

      - name: Enhance HAR
        run: |
          bun src/cli/har-cli.ts enhance current.har \
            --output current-enhanced.har

      - name: Lint HAR
        run: |
          bun src/cli/har-cli.ts lint current-enhanced.har

      - name: Analyze HAR
        run: |
          bun src/cli/har-cli.ts analyze current-enhanced.har \
            --format json > analysis.json
          
          # Extract key metrics for GitHub Actions summary
          echo "## ðŸ“Š Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          REQUESTS=$(cat analysis.json | jq '.stats.totalRequests')
          SIZE=$(cat analysis.json | jq '.stats.totalSize')
          COMPRESSION=$(cat analysis.json | jq '.stats.compressionRatio')
          AVG_TIME=$(cat analysis.json | jq '.stats.avgResponseTime')
          
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Requests | $REQUESTS |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Size | $(echo "$SIZE" | numfmt --to=iec) |" >> $GITHUB_STEP_SUMMARY
          echo "| Compression | $(echo "$COMPRESSION * 100" | bc)% |" >> $GITHUB_STEP_SUMMARY
          echo "| Avg Response Time | ${AVG_TIME}ms |" >> $GITHUB_STEP_SUMMARY

      - name: Diff against baseline
        if: hashFiles('artifacts/baseline.har') != ''
        run: |
          bun src/cli/har-cli.ts diff artifacts/baseline.har current-enhanced.har \
            > diff-report.txt || true
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”„ Diff from Baseline" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat diff-report.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Generate HTML Report
        run: |
          bun src/cli/har-cli.ts analyze current-enhanced.har \
            --format html

      - name: Upload HAR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: har-reports
          path: |
            current-enhanced.har
            current-enhanced-report.html
            analysis.json
          retention-days: 30

      - name: Update baseline (on main branch)
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: baseline-har
          path: current-enhanced.har
          retention-days: 90

      - name: Stop test server
        if: always()
        run: |
          kill $SERVER_PID || true

  lighthouse-comparison:
    runs-on: ubuntu-latest
    needs: performance-test
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Download HAR
        uses: actions/download-artifact@v4
        with:
          name: har-reports

      - name: Generate Lighthouse-style report
        run: |
          bun run scripts/generate-lighthouse-report.ts \
            --har current-enhanced.har \
            --output lighthouse-report.html

      - name: Upload Lighthouse report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: lighthouse-report.html

  notify-regression:
    runs-on: ubuntu-latest
    needs: performance-test
    if: failure()
    
    steps:
      - name: Notify on regression
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸš¨ Performance regression detected in ${{ github.repository }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Performance regression detected*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
