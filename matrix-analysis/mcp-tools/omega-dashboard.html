<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tier-1380 OMEGA - Multi-Tenant Compliance Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: #0a0a0a;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 8px;
            border: 1px solid #2a2a3e;
        }

        .header h1 {
            color: #00ff88;
            margin: 0;
            font-size: 2em;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .tenant-filter-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #0f172a;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .tenant-filter-bar label {
            font-weight: bold;
            color: #94a3b8;
        }

        select[multiple] {
            min-width: 220px;
            padding: 0.5rem;
            background: #1e293b;
            color: #e2e8f0;
            border: 1px solid #334155;
            border-radius: 6px;
            font-family: inherit;
        }

        select[multiple] option {
            padding: 0.25rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            border: none;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #475569;
            color: white;
        }

        .btn-secondary:hover {
            background: #64748b;
        }

        .active-filter {
            font-style: italic;
            color: #94a3b8;
            margin-left: auto;
            font-weight: bold;
        }

        .active-filter.filtered {
            color: #3b82f6;
        }

        .header .subtitle {
            color: #888;
            margin-top: 5px;
            font-size: 0.9em;
        }

        .tenant-selector {
            margin: 20px 0;
            text-align: center;
        }

        .tenant-selector select {
            background: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #333;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 16px;
        }

        .historical-compliance-card {
            background: #1e293b;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border: 1px solid #334155;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-header h3 {
            color: #00ff88;
            margin: 0;
            font-size: 1.2em;
        }

        .admin-toggle {
            background: #333;
            color: #e0e0e0;
            border: 1px solid #555;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .admin-toggle.active {
            background: #00ff88;
            color: #000;
        }

        .summary-stats {
            margin-top: 1rem;
            padding: 1rem;
            background: #0f172a;
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #fff;
        }

        .stat-label {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ef4444;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .metric-card h3 {
            color: #00ff88;
            margin: 0 0 10px 0;
            font-size: 0.9em;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #fff;
        }

        .metric-change {
            font-size: 0.8em;
            margin-top: 5px;
        }

        .metric-change.positive {
            color: #22c55e;
        }

        .metric-change.negative {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üîê Tier-1380 OMEGA</h1>
            <div class="subtitle">Historical Col-89 Compliance Trend Analysis</div>
            <div class="tenant-selector">
                <label for="tenant-select">Tenant: </label>
                <select id="tenant-select">
                    <option value="tenant-a">Tenant A</option>
                    <option value="tenant-b">Tenant B</option>
                    <option value="tenant-c">Tenant C</option>
                </select>
                <button class="admin-toggle" id="admin-toggle">Admin View</button>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <h3>Current Compliance</h3>
                <div class="metric-value" id="current-score">-</div>
                <div class="metric-change" id="current-status">-</div>
            </div>
            <div class="metric-card">
                <h3>Average Compliance</h3>
                <div class="metric-value" id="avg-score">-</div>
                <div class="metric-change" id="avg-trend">-</div>
            </div>
            <div class="metric-card">
                <h3>Total Violations</h3>
                <div class="metric-value" id="total-violations">-</div>
                <div class="metric-change" id="violation-rate">-</div>
            </div>
            <div class="metric-card">
                <h3>Months Tracked</h3>
                <div class="metric-value" id="months-tracked">-</div>
                <div class="metric-change">Historical data</div>
            </div>
        </div>

        <div class="historical-compliance-card">
            <div class="card-header">
                <h3>üìÖ Historical Col-89 Compliance (12 Months)</h3>
                <button class="admin-toggle" id="refresh-btn">Refresh</button>
            </div>

            <div class="card-body">
                <canvas id="historicalComplianceChart" height="240"></canvas>
                <div id="hist-compliance-summary" class="summary-stats"></div>
            </div>
        </div>
    </div>

    <script type="module">
        let histComplianceChart = null;
        let isAdminView = false;

        // Initialize dashboard
        function initDashboard() {
            const tenantSelect = document.getElementById('tenant-select');
            const adminToggle = document.getElementById('admin-toggle');
            const refreshBtn = document.getElementById('refresh-btn');

            // Tenant change handler
            tenantSelect.addEventListener('change', () => {
                loadHistoricalCompliance();
            });

            // Admin toggle handler
            adminToggle.addEventListener('click', () => {
                isAdminView = !isAdminView;
                adminToggle.classList.toggle('active');
                adminToggle.textContent = isAdminView ? 'Admin View ON' : 'Admin View';
                loadHistoricalCompliance();
            });

            // Refresh handler
            refreshBtn.addEventListener('click', () => {
                loadHistoricalCompliance();
            });

            // Load initial data
            loadHistoricalCompliance();
        }

        // Load historical compliance data (OMEGA API)
        async function loadHistoricalCompliance() {
            try {
                showLoading();

                const tenant = document.getElementById('tenant-select').value;
                const adminParam = isAdminView ? '&admin=true' : '';
                const url = `http://localhost:3333/api/historical-compliance?tenant=${tenant}${adminParam}`;

                const res = await fetch(url, {
                    headers: { 'x-tenant-id': tenant }
                });

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();

                if (data.history.length === 0) {
                    showNoData();
                    return;
                }

                updateMetrics(data);
                renderChart(data.history);
                updateSummary(data.history);

            } catch (err) {
                console.error("Historical compliance load failed:", err);
                showError(`Failed to load data: ${err.message}`);
            }
        }

        // Update metrics cards
        function updateMetrics(data) {
            const summary = data.summary;
            const history = data.history;

            // Current compliance (latest month)
            if (history.length > 0) {
                const latest = history[history.length - 1];
                document.getElementById('current-score').textContent = `${latest.score}%`;

                const currentStatus = document.getElementById('current-status');
                if (latest.score >= 95) {
                    currentStatus.textContent = 'Excellent';
                    currentStatus.className = 'metric-change positive';
                } else if (latest.score >= 85) {
                    currentStatus.textContent = 'Good';
                    currentStatus.className = 'metric-change';
                } else {
                    currentStatus.textContent = 'Needs Attention';
                    currentStatus.className = 'metric-change negative';
                }
            }

            // Average compliance
            document.getElementById('avg-score').textContent = `${summary.averageCompliance}%`;

            const avgTrend = document.getElementById('avg-trend');
            if (history.length > 1) {
                const trend = history[history.length - 1].score - history[0].score;
                if (trend > 0) {
                    avgTrend.textContent = `‚Üë +${trend.toFixed(1)}%`;
                    avgTrend.className = 'metric-change positive';
                } else if (trend < 0) {
                    avgTrend.textContent = `‚Üì ${trend.toFixed(1)}%`;
                    avgTrend.className = 'metric-change negative';
                } else {
                    avgTrend.textContent = '‚Üí 0.0%';
                    avgTrend.className = 'metric-change';
                }
            }

            // Total violations
            document.getElementById('total-violations').textContent = summary.totalViolations;

            const violationRate = document.getElementById('violation-rate');
            const avgViolations = summary.monthsTracked > 0 ?
                (summary.totalViolations / summary.monthsTracked).toFixed(1) : 0;
            violationRate.textContent = `${avgViolations}/month avg`;

            // Months tracked
            document.getElementById('months-tracked').textContent = summary.monthsTracked;
        }

        // Render historical compliance chart (OMEGA style)
        function renderChart(history) {
            const labels = history.map(h => {
                const date = new Date(h.month + '-01');
                return date.toLocaleDateString("en-US", { month: 'short', year: 'numeric' });
            });
            const scores = history.map(h => h.score);
            const violations = history.map(h => h.violations);

            if (histComplianceChart) histComplianceChart.destroy();

            const ctx = document.getElementById('historicalComplianceChart').getContext('2d');
            histComplianceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Compliance Score (%)',
                            data: scores,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34,197,94,0.2)',
                            yAxisID: 'y',
                            tension: 0.3,
                            pointRadius: 5,
                            pointBackgroundColor: scores.map(s =>
                                s >= 95 ? '#22c55e' : s >= 85 ? '#eab308' : '#ef4444'
                            ),
                            fill: true,
                        },
                        {
                            label: 'Violations',
                            data: violations,
                            type: 'bar',
                            backgroundColor: 'rgba(239,68,68,0.4)',
                            yAxisID: 'y1',
                            borderWidth: 0,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: {
                            position: 'left',
                            title: { display: true, text: 'Compliance Score (%)' },
                            suggestedMin: 70,
                            suggestedMax: 100,
                            grid: { color: '#334155' },
                            ticks: { color: '#888' }
                        },
                        y1: {
                            position: 'right',
                            title: { display: true, text: 'Violations' },
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#888' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#888' }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: '#e0e0e0' }
                        },
                        tooltip: {
                            mode: 'index',
                            callbacks: {
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 0) {
                                        const h = history[context.dataIndex];
                                        return [
                                            `Violations: ${h.violations}`,
                                            `Total Lines: ${h.total}`,
                                            `Max Width: ${h.maxWidth || 'N/A'}`
                                        ];
                                    }
                                    return null;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update summary statistics
        function updateSummary(history) {
            const latest = history[history.length - 1];
            const avgViolations = (history.reduce((a, h) => a + h.violations, 0) / history.length).toFixed(1);

            document.getElementById('hist-compliance-summary').innerHTML = `
                <div class="stat">
                    <div class="stat-value">${latest.score}%</div>
                    <div class="stat-label">Current Score</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${history.length}</div>
                    <div class="stat-label">Months Tracked</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${avgViolations}</div>
                    <div class="stat-label">Avg Violations/Month</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${latest.maxWidth || 'N/A'}</div>
                    <div class="stat-label">Max Width</div>
                </div>
            `;
        }

        // UI helpers
        function showLoading() {
            document.getElementById('current-score').textContent = 'Loading...';
            document.getElementById('avg-score').textContent = 'Loading...';
            document.getElementById('total-violations').textContent = 'Loading...';
            document.getElementById('months-tracked').textContent = 'Loading...';
        }

        function showNoData() {
            document.getElementById('hist-compliance-summary').innerHTML =
                '<div class="loading">No historical compliance data yet.</div>';
        }

        function showError(message) {
            document.getElementById('hist-compliance-summary').innerHTML =
                `<div class="error">${message}</div>`;
        }

        // Initialize on load
        initDashboard();

        // Auto-refresh every hour
        setInterval(loadHistoricalCompliance, 3600000);
    </script>
</body>
</html>
