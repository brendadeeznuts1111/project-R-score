<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tier-1380 OMEGA - Multi-Tenant Compliance Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: #0a0a0a;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 8px;
            border: 1px solid #2a2a3e;
        }

        .header h1 {
            color: #00ff88;
            margin: 0;
            font-size: 2em;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .tenant-filter-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #0f172a;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .tenant-filter-bar label {
            font-weight: bold;
            color: #94a3b8;
        }

        select[multiple] {
            min-width: 220px;
            padding: 0.5rem;
            background: #1e293b;
            color: #e2e8f0;
            border: 1px solid #334155;
            border-radius: 6px;
            font-family: inherit;
        }

        select[multiple] option {
            padding: 0.25rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            border: none;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #475569;
            color: white;
        }

        .btn-secondary:hover {
            background: #64748b;
        }

        .active-filter {
            font-style: italic;
            color: #94a3b8;
            margin-left: auto;
            font-weight: bold;
        }

        .active-filter.filtered {
            color: #3b82f6;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
            text-align: center;
        }

        .metric-card h3 {
            margin: 0 0 10px 0;
            color: #94a3b8;
            font-size: 14px;
            text-transform: uppercase;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #00ff88;
            margin: 10px 0;
        }

        .metric-change {
            font-size: 0.9em;
            font-weight: bold;
        }

        .metric-change.positive {
            color: #10b981;
        }

        .metric-change.negative {
            color: #ef4444;
        }

        .chart-container {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
            margin-bottom: 30px;
        }

        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .chart-tab {
            padding: 10px 20px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-tab:hover {
            background: #3a3a3a;
        }

        .chart-tab.active {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
        }

        .violations-table {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .violations-table h3 {
            margin: 0 0 20px 0;
            color: #ef4444;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        th {
            background: #2a2a2a;
            font-weight: bold;
            color: #94a3b8;
        }

        tr:hover {
            background: #2a2a2a;
        }

        .severity-critical {
            color: #ef4444;
            font-weight: bold;
        }

        .severity-warning {
            color: #f59e0b;
            font-weight: bold;
        }

        .severity-info {
            color: #3b82f6;
        }

        .loading {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
            padding: 20px;
        }

        .error {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ef4444;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }

        .status-offline {
            background: #ef4444;
        }

        .enhanced-controls {
            background: #1a1a2e;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid #2a2a3e;
        }

        .control-group {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .date-range-selector {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .date-range-selector input[type="date"] {
            background: #1e293b;
            color: #e2e8f0;
            border: 1px solid #334155;
            padding: 0.5rem;
            border-radius: 4px;
            font-family: inherit;
        }

        .export-btn {
            background: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .refresh-btn {
            background: #6366f1;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: #4f46e5;
            transform: translateY(-1px);
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding: 1rem;
            background: #0f172a;
            border-radius: 6px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00ff88;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner-container {
            text-align: center;
            color: #00ff88;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #333;
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-text {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .loading-subtext {
            font-size: 0.9rem;
            color: #94a3b8;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner-small {
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-top: 2px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #10b981;
        }

        .notification.error {
            background: #ef4444;
        }

        .notification.info {
            background: #3b82f6;
        }

        .quick-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .quick-filter-btn {
            padding: 0.25rem 0.75rem;
            background: #374151;
            color: #e5e7eb;
            border: 1px solid #4b5563;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .quick-filter-btn:hover {
            background: #4b5563;
        }

        .quick-filter-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        @media (max-width: 768px) {
            .tenant-filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .active-filter {
                margin-left: 0;
                text-align: center;
            }

            select[multiple] {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üîê Tier-1380 OMEGA Compliance Dashboard</h1>
            <p>Multi-Tenant Historical Compliance & Violation Tracking</p>
            <div style="margin-top: 10px;">
                <span class="status-indicator status-online"></span>
                <span id="connection-status">Connected</span>
            </div>
        </div>

        <!-- Enhanced Tenant Filter Bar -->
        <div class="tenant-filter-bar">
            <label for="tenant-filter">Filter by Tenant(s):</label>
            <select id="tenant-filter" multiple size="6">
                <!-- Populated dynamically -->
            </select>
            <button id="apply-filter" class="btn btn-primary">Apply Filter</button>
            <button id="clear-filter" class="btn btn-secondary">Clear</button>
            <div id="active-filter-display" class="active-filter">Filtered by: All Tenants</div>
        </div>

        <!-- Enhanced Controls -->
        <div class="enhanced-controls">
            <div class="control-group">
                <label>Quick Filters:</label>
                <div class="quick-filters">
                    <button class="quick-filter-btn" data-filter="all">All Tenants</button>
                    <button class="quick-filter-btn" data-filter="critical">Critical Only</button>
                    <button class="quick-filter-btn" data-filter="warning">Warnings Only</button>
                    <button class="quick-filter-btn" data-filter="compliant">95%+ Compliant</button>
                </div>
            </div>

            <div class="control-group">
                <label>Date Range:</label>
                <div class="date-range-selector">
                    <input type="date" id="start-date" value="">
                    <span>to</span>
                    <input type="date" id="end-date" value="">
                    <button id="apply-date-range" class="btn btn-primary">Apply</button>
                </div>
            </div>

            <div class="control-group">
                <button id="refresh-data" class="refresh-btn">üîÑ Refresh Data</button>
                <button id="export-csv" class="export-btn">üìä Export CSV</button>
                <button id="export-json" class="export-btn">üìÑ Export JSON</button>
                <button id="toggle-auto-refresh" class="btn btn-secondary">‚è±Ô∏è Auto Refresh: OFF</button>
            </div>

            <div class="stats-summary" id="quick-stats">
                <div class="stat-item">
                    <div class="stat-value" id="tenant-count">-</div>
                    <div class="stat-label">Active Tenants</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-violations-count">-</div>
                    <div class="stat-label">Total Violations</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avg-compliance-rate">-</div>
                    <div class="stat-label">Avg Compliance</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="last-updated">-</div>
                    <div class="stat-label">Last Updated</div>
                </div>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <h3>Average Compliance</h3>
                <div class="metric-value" id="avg-compliance">-</div>
                <div class="metric-change" id="compliance-trend">-</div>
            </div>
            <div class="metric-card">
                <h3>Total Violations</h3>
                <div class="metric-value" id="total-violations">-</div>
                <div class="metric-change" id="violations-change">-</div>
            </div>
            <div class="metric-card">
                <h3>Current Month</h3>
                <div class="metric-value" id="current-compliance">-</div>
                <div class="metric-change" id="current-status">-</div>
            </div>
            <div class="metric-card">
                <h3>Months Tracked</h3>
                <div class="metric-value" id="months-tracked">-</div>
                <div class="metric-change">Historical data</div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-tabs">
                <button class="chart-tab active" data-chart="compliance">Compliance Trend</button>
                <button class="chart-tab" data-chart="violations">Violation Count</button>
                <button class="chart-tab" data-chart="combined">Combined View</button>
            </div>
            <canvas id="historical-chart"></canvas>
        </div>

        <div class="violations-table">
            <h3>üö® Recent Violations</h3>
            <div id="violations-content">
                <div class="loading">Loading violations...</div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Dashboard Data</div>
            <div class="loading-subtext">Fetching compliance metrics and violations...</div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification" id="notification"></div>

    <script type="module">
        let currentChart = null;
        let currentChartType = 'compliance';
        let historicalData = null;
        let selectedTenants = JSON.parse(localStorage.getItem("selectedTenants")) || ["all"];
        let autoRefreshInterval = null;
        let currentViolations = null;

        // Enhanced utility functions
        function showLoading(show = true, message = "Loading Dashboard Data", subtext = "Fetching compliance metrics and violations...") {
            const overlay = document.getElementById('loading-overlay');
            const loadingText = overlay.querySelector('.loading-text');
            const loadingSubtext = overlay.querySelector('.loading-subtext');

            if (show) {
                loadingText.textContent = message;
                loadingSubtext.textContent = subtext;
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        function showButtonSpinner(buttonId, show = true) {
            const button = document.getElementById(buttonId);
            if (!button) return;

            if (show) {
                const spinner = document.createElement('span');
                spinner.className = 'spinner-small';
                spinner.id = `${buttonId}-spinner`;
                button.insertBefore(spinner, button.firstChild);
                button.disabled = true;
            } else {
                const spinner = document.getElementById(`${buttonId}-spinner`);
                if (spinner) spinner.remove();
                button.disabled = false;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function updateQuickStats() {
            if (!historicalData) return;

            // Update tenant count
            const tenantCount = selectedTenants.includes('all') ? 3 : selectedTenants.length;
            document.getElementById('tenant-count').textContent = tenantCount;

            // Update total violations
            const totalViolations = historicalData.summary.totalViolations;
            document.getElementById('total-violations-count').textContent = totalViolations;

            // Update average compliance
            const avgCompliance = historicalData.summary.averageCompliance;
            document.getElementById('avg-compliance-rate').textContent = `${avgCompliance.toFixed(1)}%`;

            // Update last updated time
            const now = new Date();
            document.getElementById('last-updated').textContent = now.toLocaleTimeString();
        }

        function exportData(format) {
            if (!historicalData) {
                showNotification('No data available to export', 'error');
                return;
            }

            let data, filename, mimeType;

            if (format === 'csv') {
                // Create CSV data
                const headers = ['Month', 'Compliance Score', 'Violations', 'Total Lines', 'Max Width'];
                const rows = historicalData.history.map(h => [
                    h.month,
                    h.score,
                    h.violations,
                    h.total || 0,
                    h.maxWidth || 0
                ]);

                data = [headers, ...rows].map(row => row.join(',')).join('\n');
                filename = `compliance-data-${selectedTenants.join('-')}-${new Date().toISOString().split('T')[0]}.csv`;
                mimeType = 'text/csv';
            } else {
                // JSON format
                data = JSON.stringify({
                    tenants: selectedTenants,
                    summary: historicalData.summary,
                    history: historicalData.history,
                    violations: currentViolations || [],
                    exportedAt: new Date().toISOString()
                }, null, 2);
                filename = `compliance-data-${selectedTenants.join('-')}-${new Date().toISOString().split('T')[0]}.json`;
                mimeType = 'application/json';
            }

            // Download file
            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification(`Data exported as ${format.toUpperCase()}`, 'success');
        }

        function toggleAutoRefresh() {
            const button = document.getElementById('toggle-auto-refresh');

            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                button.textContent = '‚è±Ô∏è Auto Refresh: OFF';
                button.classList.remove('active');
                showNotification('Auto refresh disabled', 'info');
            } else {
                autoRefreshInterval = setInterval(() => {
                    applyFilter();
                }, 30000); // Refresh every 30 seconds
                button.textContent = '‚è±Ô∏è Auto Refresh: ON';
                button.classList.add('active');
                showNotification('Auto refresh enabled (30s)', 'info');
            }
        }

        function applyQuickFilter(filterType) {
            const tenantSelect = document.getElementById('tenant-filter');

            // Clear all selections first
            Array.from(tenantSelect.options).forEach(option => option.selected = false);

            switch (filterType) {
                case 'all':
                    tenantSelect.options[0].selected = true; // Select "all"
                    selectedTenants = ["all"];
                    break;
                case 'critical':
                    // Select all tenants and add severity filter
                    Array.from(tenantSelect.options).forEach(option => option.selected = true);
                    selectedTenants = Array.from(tenantSelect.options).map(o => o.value);
                    showNotification('Showing critical violations only', 'info');
                    break;
                case 'warning':
                    Array.from(tenantSelect.options).forEach(option => option.selected = true);
                    selectedTenants = Array.from(tenantSelect.options).map(o => o.value);
                    showNotification('Showing warning violations only', 'info');
                    break;
                case 'compliant':
                    // This would require backend support for compliance filtering
                    Array.from(tenantSelect.options).forEach(option => option.selected = true);
                    selectedTenants = Array.from(tenantSelect.options).map(o => o.value);
                    showNotification('Showing 95%+ compliant tenants only', 'info');
                    break;
            }

            updateFilterDisplay();
            applyFilter();
        }

        // Chart configuration
        const chartConfig = {
            compliance: {
                type: 'line',
                label: 'Compliance %',
                borderColor: '#00ff88',
                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                yAxisLabel: 'Compliance %',
                dataKey: 'score'
            },
            violations: {
                type: 'bar',
                label: 'Violations',
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.5)',
                yAxisLabel: 'Violation Count',
                dataKey: 'violations'
            },
            combined: {
                type: 'line',
                label: 'Combined Metrics',
                borderColor: '#00ff88',
                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                yAxisLabel: 'Value',
                dataKey: 'score',
                secondaryDataKey: 'violations'
            }
        };

        // Initialize dashboard
        async function initDashboard() {
            const chartTabs = document.querySelectorAll('.chart-tab');

            // Initialize tenant filter
            await initTenantFilter();

            // Set default date range (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('end-date').value = endDate.toISOString().split('T')[0];

            // Chart tab handlers
            chartTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    chartTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentChartType = tab.dataset.chart;
                    updateChart();
                });
            });

            // New enhanced controls
            document.getElementById('refresh-data').addEventListener('click', () => {
                showButtonSpinner('refresh-data', true);
                applyFilter();
                setTimeout(() => {
                    showButtonSpinner('refresh-data', false);
                    showNotification('Data refreshed', 'success');
                }, 1000);
            });

            document.getElementById('export-csv').addEventListener('click', () => {
                showButtonSpinner('export-csv', true);
                exportData('csv');
                setTimeout(() => showButtonSpinner('export-csv', false), 500);
            });

            document.getElementById('export-json').addEventListener('click', () => {
                showButtonSpinner('export-json', true);
                exportData('json');
                setTimeout(() => showButtonSpinner('export-json', false), 500);
            });

            document.getElementById('toggle-auto-refresh').addEventListener('click', () => {
                showButtonSpinner('toggle-auto-refresh', true);
                toggleAutoRefresh();
                setTimeout(() => showButtonSpinner('toggle-auto-refresh', false), 500);
            });

            document.getElementById('apply-date-range').addEventListener('click', () => {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                if (startDate && endDate) {
                    showButtonSpinner('apply-date-range', true);
                    showNotification(`Date range applied: ${startDate} to ${endDate}`, 'success');
                    applyFilter();
                    setTimeout(() => showButtonSpinner('apply-date-range', false), 1000);
                } else {
                    showNotification('Please select both start and end dates', 'error');
                }
            });

            document.getElementById('apply-filter').addEventListener('click', () => {
                showButtonSpinner('apply-filter', true);
                selectedTenants = [...document.getElementById('tenant-filter').selectedOptions].map(o => o.value);
                updateFilterDisplay();
                applyFilter();
                setTimeout(() => showButtonSpinner('apply-filter', false), 1000);
            });

            document.getElementById('clear-filter').addEventListener('click', () => {
                showButtonSpinner('clear-filter', true);
                document.querySelectorAll('#tenant-filter option').forEach(o => o.selected = o.value === 'all');
                selectedTenants = ["all"];
                updateFilterDisplay();
                applyFilter();
                setTimeout(() => showButtonSpinner('clear-filter', false), 1000);
            });

            // Quick filter buttons
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all buttons
                    document.querySelectorAll('.quick-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    applyQuickFilter(btn.dataset.filter);
                });
            });
        }

        // Initialize tenant filter with available tenants
        async function initTenantFilter() {
            try {
                showLoading(true, "Initializing Dashboard", "Loading tenant information...");
                const res = await fetch("http://localhost:3333/api/tenants");
                if (!res.ok) throw new Error(await res.text());

                const { tenants } = await res.json();
                const select = document.getElementById('tenant-filter');

                tenants.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t;
                    option.textContent = t === 'all' ? 'All Tenants' : t;
                    if (selectedTenants.includes(t)) option.selected = true;
                    select.appendChild(option);
                });

                updateFilterDisplay();
                showLoading(true, "Loading Initial Data", "Fetching compliance metrics and violations...");
                await applyFilter(); // initial load with saved selection

            } catch (err) {
                console.error("Failed to load tenants:", err);
                showLoading(false);
                // Fallback to hardcoded tenants
                const fallbackTenants = ['all', 'tenant-a', 'tenant-b', 'tenant-c'];
                const select = document.getElementById('tenant-filter');
                fallbackTenants.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t;
                    option.textContent = t === 'all' ? 'All Tenants' : t;
                    if (selectedTenants.includes(t)) option.selected = true;
                    select.appendChild(option);
                });
                updateFilterDisplay();
                await applyFilter();
            }
        }

        function updateFilterDisplay() {
            const display = document.getElementById('active-filter-display');
            if (selectedTenants.includes('all') || selectedTenants.length === 0) {
                display.textContent = 'Filtered by: All Tenants';
                display.classList.remove('filtered');
            } else {
                display.textContent = `Filtered by: ${selectedTenants.join(', ')}`;
                display.classList.add('filtered');
            }
        }

        async function applyFilter() {
            localStorage.setItem("selectedTenants", JSON.stringify(selectedTenants));

            // Re-fetch all data with tenant filter
            const tenantParam = selectedTenants.includes("all") ? "*" : selectedTenants.join(",");
            const headers = { "x-tenant-id": tenantParam };

            try {
                showLoading(true, "Loading Filtered Data", `Fetching data for: ${selectedTenants.join(', ')}`);
                document.getElementById('connection-status').textContent = 'Loading...';

                await Promise.all([
                    loadHistoricalData({ headers }),
                    loadRecentViolations({ headers })
                ]);

                updateQuickStats();
                document.getElementById('connection-status').textContent = 'Connected';
                showLoading(false);
                showNotification('Data loaded successfully', 'success');

            } catch (error) {
                document.getElementById('connection-status').textContent = 'Error';
                showLoading(false, "Error Loading Data", "Please check your connection and try again");
                showNotification('Failed to load data: ' + (error instanceof Error ? error.message : String(error)), 'error');
                console.error('Failed to apply filter:', error);
            }
        }

        // Load historical data from API
        async function loadHistoricalData({ headers = {} } = {}) {
            try {
                showLoading();

                const response = await fetch(`http://localhost:3333/api/historical-compliance?months=12`, {
                    headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                historicalData = data;

                updateMetrics(data);
                updateChart();

            } catch (error) {
                console.error('Failed to load historical data:', error);
                showError(`Failed to load data: ${error.message}`);
            }
        }

        // Load recent violations
        async function loadRecentViolations({ headers = {} } = {}) {
            try {
                const response = await fetch(`http://localhost:3333/api/recent-violations?days=7`, {
                    headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                currentViolations = data.violations; // Store for export
                displayViolations(data.violations);

            } catch (error) {
                console.error('Failed to load violations:', error);
                document.getElementById('violations-content').innerHTML =
                    '<div class="error">Failed to load violations</div>';
            }
        }

        // Update metrics cards
        function updateMetrics(data) {
            const summary = data.summary;

            // Average compliance
            document.getElementById('avg-compliance').textContent =
                `${summary.averageCompliance.toFixed(1)}%`;

            const complianceTrend = document.getElementById('compliance-trend');
            if (summary.trend > 0) {
                complianceTrend.textContent = `‚Üë +${summary.trend.toFixed(1)}%`;
                complianceTrend.className = 'metric-change positive';
            } else if (summary.trend < 0) {
                complianceTrend.textContent = `‚Üì ${summary.trend.toFixed(1)}%`;
                complianceTrend.className = 'metric-change negative';
            } else {
                complianceTrend.textContent = '‚Üí 0.0%';
                complianceTrend.className = 'metric-change';
            }

            // Total violations
            document.getElementById('total-violations').textContent = summary.totalViolations;

            // Current month
            const currentMonth = data.history[data.history.length - 1];
            if (currentMonth) {
                document.getElementById('current-compliance').textContent =
                    `${currentMonth.score.toFixed(1)}%`;

                const currentStatus = document.getElementById('current-status');
                if (currentMonth.score >= 95) {
                    currentStatus.textContent = 'Excellent';
                    currentStatus.className = 'metric-change positive';
                } else if (currentMonth.score >= 85) {
                    currentStatus.textContent = 'Good';
                    currentStatus.className = 'metric-change';
                } else {
                    currentStatus.textContent = 'Needs Attention';
                    currentStatus.className = 'metric-change negative';
                }
            }

            // Months tracked
            document.getElementById('months-tracked').textContent = summary.monthsTracked;
        }

        // Update chart
        function updateChart() {
            if (!historicalData) return;

            const ctx = document.getElementById('historical-chart').getContext('2d');
            const config = chartConfig[currentChartType];

            // Destroy existing chart
            if (currentChart) {
                currentChart.destroy();
            }

            const labels = historicalData.history.map(h => {
                const date = new Date(h.month);
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });

            const datasets = [{
                label: config.label,
                data: historicalData.history.map(h => h[config.dataKey]),
                borderColor: config.borderColor,
                backgroundColor: config.backgroundColor,
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }];

            // Add secondary dataset for combined view
            if (currentChartType === 'combined' && config.secondaryDataKey) {
                datasets.push({
                    label: 'Violations',
                    data: historicalData.history.map(h => h[config.secondaryDataKey]),
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y1'
                });
            }

            const chartConfig = {
                type: config.type,
                data: {
                    labels,
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: currentChartType === 'combined',
                            labels: {
                                color: '#e0e0e0',
                                font: {
                                    family: "'SF Mono', Monaco, 'Cascadia Code', monospace"
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#00ff88',
                            bodyColor: '#e0e0e0',
                            borderColor: '#333',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#333',
                                borderColor: '#333'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        },
                        y: {
                            position: 'left',
                            grid: {
                                color: '#333',
                                borderColor: '#333'
                            },
                            ticks: {
                                color: '#94a3b8'
                            },
                            title: {
                                display: true,
                                text: config.yAxisLabel,
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            };

            // Add secondary Y-axis for combined view
            if (currentChartType === 'combined') {
                chartConfig.options.scales.y1 = {
                    position: 'right',
                    grid: {
                        drawOnChartArea: false
                    },
                    ticks: {
                        color: '#94a3b8'
                    },
                    title: {
                        display: true,
                        text: 'Violation Count',
                        color: '#ef4444'
                    }
                };
            }

            currentChart = new Chart(ctx, chartConfig);
        }

        // Display violations in table
        function displayViolations(violations) {
            const container = document.getElementById('violations-content');

            if (violations.length === 0) {
                container.innerHTML = '<div class="loading">No violations in the last 7 days</div>';
                return;
            }

            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>File</th>
                            <th>Line</th>
                            <th>Column</th>
                            <th>Severity</th>
                            <th>Preview</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${violations.map(v => `
                            <tr>
                                <td>${new Date(v.date).toLocaleDateString()}</td>
                                <td><code>${v.file}</code></td>
                                <td>${v.line_number}</td>
                                <td>${v.column_number}</td>
                                <td class="severity-${v.severity}">${v.severity.toUpperCase()}</td>
                                <td><code>${v.preview.slice(0, 50)}...</code></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = table;
        }

        // UI helpers
        function showLoading() {
            document.getElementById('avg-compliance').textContent = 'Loading...';
            document.getElementById('total-violations').textContent = 'Loading...';
            document.getElementById('current-compliance').textContent = 'Loading...';
            document.getElementById('months-tracked').textContent = 'Loading...';
        }

        function showError(message) {
            document.getElementById('avg-compliance').textContent = 'Error';
            document.getElementById('total-violations').textContent = 'Error';
            document.getElementById('current-compliance').textContent = 'Error';
            document.getElementById('months-tracked').textContent = 'Error';
            console.error(message);
        }

        // Initialize on load
        initDashboard();
    </script>
</body>
</html>
