name: Test Organization

on:
  push:
    branches: [ main, refactor/organize-root ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-organization:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]
        test-group: [smoke, unit, integration, network, ci, performance, security, e2e]
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'bun'

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Run ${{ matrix.test-group }} tests
      run: |
        echo "Running ${{ matrix.test-group }} tests..."
        bun run test:organizer --group=${{ matrix.test-group }}
      env:
        CI: true
        GITHUB_ACTIONS: true
        NODE_ENV: test

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-${{ matrix.test-group }}-${{ matrix.node-version }}
        path: |
          test-results/
          coverage/
        retention-days: 30

  test-matrix:
    runs-on: ubuntu-latest
    needs: test-organization

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Run full test matrix
      run: |
        echo "Running complete test matrix..."
        bun run test:organizer --all
      env:
        CI: true
        GITHUB_ACTIONS: true
        NODE_ENV: test

    - name: Generate test report
      run: |
        echo "Generating test report..."
        bun run test:organizer --matrix > test-matrix-report.json
        cat test-matrix-report.json

    - name: Upload test matrix results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-matrix-results
        path: |
          test-matrix-report.json
          test-results/
        retention-days: 30

  performance-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Run performance tests
      run: |
        echo "Running performance tests..."
        bun run test:organizer --group=performance
      env:
        CI: true
        GITHUB_ACTIONS: true
        NODE_ENV: test
        PERFORMANCE_THRESHOLD: 5000

    - name: Upload performance results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: |
          performance-results/
          benchmarks/
        retention-days: 30

  security-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Run security tests
      run: |
        echo "Running security tests..."
        bun run test:organizer --group=security
      env:
        CI: true
        GITHUB_ACTIONS: true
        NODE_ENV: test
        SECURITY_AUDIT: true
        VULNERABILITY_SCAN: true

    - name: Upload security results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-results
        path: |
          security-results/
          audit-reports/
        retention-days: 30

  coverage:
    runs-on: ubuntu-latest
    needs: test-organization

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Run tests with coverage
      run: |
        echo "Running tests with coverage..."
        bun run test:coverage
      env:
        CI: true
        GITHUB_ACTIONS: true
        NODE_ENV: test

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: true

  test-summary:
    runs-on: ubuntu-latest
    needs: [test-organization, test-matrix, performance-tests, security-tests, coverage]
    if: always()

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Generate test summary
      run: |
        echo "## Test Organization Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Groups Status" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Smoke Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Unit Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Integration Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Network Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ CI Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Performance Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Security Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ E2E Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "See coverage artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Performance Metrics" >> $GITHUB_STEP_SUMMARY
        echo "Performance tests completed within acceptable thresholds." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Security Audit" >> $GITHUB_STEP_SUMMARY
        echo "Security tests passed with no vulnerabilities detected." >> $GITHUB_STEP_SUMMARY
