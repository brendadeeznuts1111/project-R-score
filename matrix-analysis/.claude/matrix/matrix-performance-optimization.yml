# Tier-1380 OMEGA: Matrix Performance Optimization
# Preconnect, DNS-Prefetch, and Cache Configuration
# Version: 1.3.7-PERFORMANCE

---
# ═════════════════════════════════════════════════════════════════════════════
# PRECONNECT & DNS-PREFETCH HEADERS
# ═════════════════════════════════════════════════════════════════════════════

preconnect:
  # Critical origins for matrix dashboard
  origins:
    - url: "https://matrix.factory-wager.com"
      priority: "high"
      description: "Main matrix grid API"
      
    - url: "https://api.factory-wager.com"
      priority: "high"
      description: "Bun API catalog & matrix queries"
      
    - url: "https://profiles.factory-wager.com"
      priority: "medium"
      description: "CPU/Heap profile storage"
      
    - url: "https://cdn.factory-wager.com"
      priority: "high"
      description: "Static assets CDN"
      
    - url: "https://dash.cloudflare.com"
      priority: "medium"
      description: "Cloudflare analytics (column 30)"
      
    - url: "https://workers.cloudflare.com"
      priority: "low"
      description: "Cloudflare Workers (column 25)"

  # DNS prefetch for external resources
  dns_prefetch:
    - "https://fonts.googleapis.com"
    - "https://fonts.gstatic.com"
    - "https://cdn.jsdelivr.net"
    - "https://cdnjs.cloudflare.com"
    - "https://unpkg.com"

# ═════════════════════════════════════════════════════════════════════════════
# CACHE STRATEGY BY RESOURCE TYPE
# ═════════════════════════════════════════════════════════════════════════════

cache_strategy:
  # Static matrix assets (JS, CSS, fonts)
  static_assets:
    pattern: "*matrix.factory-wager.com/static/*"
    edge_cache_ttl: 86400      # 1 day at edge
    browser_cache_ttl: 3600    # 1 hour in browser
    cache_control: "public, max-age=3600, s-maxage=86400"
    immutable: true            # Versioned filenames
    
  # Matrix column definitions (rarely change)
  column_standards:
    pattern: "*matrix.factory-wager.com/standards/*"
    edge_cache_ttl: 604800     # 7 days at edge
    browser_cache_ttl: 86400   # 24 hours in browser
    cache_control: "public, max-age=86400, s-maxage=604800"
    
  # 90-column grid data (semi-dynamic)
  grid_data:
    pattern: "*matrix.factory-wager.com/api/matrix/grid"
    edge_cache_ttl: 60         # 1 minute at edge
    browser_cache_ttl: 0       # No browser cache (dynamic)
    cache_control: "public, max-age=0, s-maxage=60"
    stale_while_revalidate: 30 # Serve stale for 30s while revalidating
    
  # Zone-specific queries
  zone_data:
    pattern: "*matrix.factory-wager.com/api/matrix/zone/*"
    edge_cache_ttl: 300        # 5 minutes at edge
    browser_cache_ttl: 60      # 1 minute in browser
    cache_control: "public, max-age=60, s-maxage=300"
    
  # RSS feeds (frequently updated)
  rss_feeds:
    pattern: "*feeds.factory-wager.com/rss*"
    edge_cache_ttl: 300        # 5 minutes at edge
    browser_cache_ttl: 60      # 1 minute in browser
    cache_control: "public, max-age=60, s-maxage=300"
    vary: "Accept-Encoding"
    
  # Tension anomaly alerts (high priority, short cache)
  tension_alerts:
    pattern: "*tension.factory-wager.com/rss"
    edge_cache_ttl: 60         # 1 minute at edge
    browser_cache_ttl: 0       # No browser cache
    cache_control: "public, max-age=0, s-maxage=60, must-revalidate"
    
  # Profile uploads (never cache)
  profiles:
    pattern: "*profiles.factory-wager.com/*"
    edge_cache_ttl: 0          # No edge cache
    browser_cache_ttl: 0       # No browser cache
    cache_control: "no-store, no-cache, must-revalidate, private"
    
  # Cloudflare analytics profiles (column 30)
  cf_profiles:
    pattern: "*matrix.factory-wager.com/api/cf-profile*"
    edge_cache_ttl: 300        # 5 minutes
    browser_cache_ttl: 60
    cache_control: "public, max-age=60, s-maxage=300"
    
  # Team data (rarely changes)
  team_data:
    pattern: "*matrix.factory-wager.com/api/team/*"
    edge_cache_ttl: 3600       # 1 hour at edge
    browser_cache_ttl: 600     # 10 minutes in browser
    cache_control: "public, max-age=600, s-maxage=3600"

# ═════════════════════════════════════════════════════════════════════════════
# CACHE INVALIDATION RULES
# ═════════════════════════════════════════════════════════════════════════════

cache_invalidation:
  # Auto-purge triggers
  triggers:
    - name: "column-standards-update"
      condition: "file_changed:matrix/column-standards-*.ts"
      purge_paths:
        - "/api/matrix/*"
        - "/standards/*"
      
    - name: "team-update"
      condition: "file_changed:core/team/TeamManager.ts"
      purge_paths:
        - "/api/team/*"
        - "/grid*"
      
    - name: "zone-data-update"
      condition: "column_updated:21-90"
      purge_paths:
        - "/api/matrix/zone/*"
        - "/rss/*"
      
    - name: "tension-alert"
      condition: "anomaly_score > 0.90"
      purge_paths:
        - "/rss/tension"
        - "/api/matrix/zone/tension"
      priority: "high"
      
  # API endpoint for manual purge
  api:
    endpoint: "POST /api/cache/purge"
    auth: "bearer_token"
    rate_limit: "10/minute"

# ═════════════════════════════════════════════════════════════════════════════
# COMPRESSION SETTINGS
# ═════════════════════════════════════════════════════════════════════════════

compression:
  brotli: true
  gzip: true
  
  # Brotli quality by content type
  brotli_quality:
    "text/html": 4           # Fast compression for HTML
    "application/json": 6    # Balanced for JSON APIs
    "text/css": 11           # Max compression for CSS
    "application/javascript": 11
    
  # Minification
  minify:
    html: true
    css: true
    js: true

# ═════════════════════════════════════════════════════════════════════════════
# BROWSER RESOURCE HINTS
# ═════════════════════════════════════════════════════════════════════════════

resource_hints:
  # Link headers for critical resources
  link_headers:
    - path: "/"
      rel: "preconnect"
      href: "https://matrix.factory-wager.com"
      
    - path: "/"
      rel: "preconnect"
      href: "https://cdn.factory-wager.com"
      
    - path: "/grid"
      rel: "preload"
      href: "/static/matrix-grid.js"
      as: "script"
      
    - path: "/grid"
      rel: "preload"
      href: "/static/matrix-styles.css"
      as: "style"
      
    - path: "/zone/*"
      rel: "dns-prefetch"
      href: "https://dash.cloudflare.com"

  # Early hints (HTTP 103)
  early_hints:
    enabled: true
    resources:
      - "/static/matrix-styles.css"
      - "/static/matrix-grid.js"

# ═════════════════════════════════════════════════════════════════════════════
# SERVICE WORKER CACHE (PWA)
# ═════════════════════════════════════════════════════════════════════════════

service_worker:
  cache_name: "matrix-cache-v1"
  
  precache:
    - "/"
    - "/grid"
    - "/static/matrix-styles.css"
    - "/static/matrix-grid.js"
    - "/static/zone-colors.css"
    
  runtime_cache:
    - pattern: "/api/matrix/grid"
      strategy: "stale-while-revalidate"
      max_age: 60
      max_entries: 1
      
    - pattern: "/api/matrix/zone/*"
      strategy: "cache-first"
      max_age: 300
      max_entries: 10
      
    - pattern: "/api/team/*"
      strategy: "cache-first"
      max_age: 3600
      max_entries: 6
      
    - pattern: "/rss"
      strategy: "network-first"
      max_age: 60
      max_entries: 1

# ═════════════════════════════════════════════════════════════════════════════
# PERFORMANCE BUDGETS
# ═════════════════════════════════════════════════════════════════════════════

performance_budgets:
  matrix_dashboard:
    first_contentful_paint: 1200    # 1.2s
    largest_contentful_paint: 2500  # 2.5s
    time_to_interactive: 3500       # 3.5s
    cumulative_layout_shift: 0.1    # 0.1 max
    total_page_size: 500000         # 500KB
    
  matrix_api:
    response_time_p50: 50           # 50ms
    response_time_p95: 200          # 200ms
    response_time_p99: 500          # 500ms

# ═════════════════════════════════════════════════════════════════════════════
# DEPLOYMENT
# ═════════════════════════════════════════════════════════════════════════════

# Apply these settings:
#   ./bin/fw-domain deploy --config matrix-performance-optimization.yml
#
# Validate configuration:
#   ./bin/fw-domain validate --performance
#
# Test cache headers:
#   curl -I https://matrix.factory-wager.com/api/matrix/grid
#   curl -I https://feeds.factory-wager.com/rss
#
# ═════════════════════════════════════════════════════════════════════════════
