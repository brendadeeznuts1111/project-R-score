<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FactoryWager 3D Secret Field Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" onerror="this.onerror=null;this.src='data:text/javascript,';console.error('Three.js failed to load from CDN');document.addEventListener('DOMContentLoaded', function() { showWebGLError(); });"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow: hidden;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #canvas {
            width: 100%;
            height: 100%;
        }
        
        #overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            max-width: 300px;
        }
        
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .metric {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .metric-value {
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .risk-low { color: #10b981; }
        .risk-medium { color: #f59e0b; }
        .risk-high { color: #ef4444; }
        .risk-critical { color: #dc2626; }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2563eb;
        }
        
        button:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .status.connected {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
        }
        
        .status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
        }
        
        .legend {
            margin-top: 20px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="canvas"></div>
        
        <div id="overlay">
            <h2>üè∞ FactoryWager 3D Secret Field</h2>
            <div class="metric">
                <span>System ID:</span>
                <span class="metric-value" id="systemId">loading...</span>
            </div>
            <div class="metric">
                <span>Max Exposure:</span>
                <span class="metric-value" id="maxExposure">0%</span>
            </div>
            <div class="metric">
                <span>Risk Score:</span>
                <span class="metric-value" id="riskScore">0</span>
            </div>
            <div class="metric">
                <span>Anomaly:</span>
                <span class="metric-value" id="anomaly">SECURE</span>
            </div>
            <div class="metric">
                <span>Total Secrets:</span>
                <span class="metric-value" id="totalSecrets">0</span>
            </div>
            <div class="status" id="status">
                Connecting to server...
            </div>
        </div>
        
        <div id="controls">
            <h3>üéÆ Controls</h3>
            <button onclick="rotateSecrets()">üîÑ Rotate Secrets</button>
            <button onclick="toggleRotation()" id="rotationBtn">‚è∏Ô∏è Pause Rotation</button>
            <button onclick="resetView()">üîÑ Reset View</button>
            
            <div class="legend">
                <h4>Risk Levels</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981;"></div>
                    <span>Low Risk</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b;"></div>
                    <span>Medium Risk</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444;"></div>
                    <span>High Risk</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc2626;"></div>
                    <span>Critical Risk</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Three.js setup
        let scene, camera, renderer, controls;
        let fieldPoints = [];
        let rotationEnabled = true;
        let ws;
        
        const API_BASE = 'http://localhost:3001';
        const WS_BASE = 'ws://localhost:3002';
        
        // Enhanced color palette using Bun.color system
        const bunColors = {
            primary: 0x3b82f6,    // Blue
            secondary: 0x1e40af,  // Dark Blue
            accent: 0x06b6d4,      // Cyan
            success: 0x10b981,     // Green
            warning: 0xf59e0b,     // Amber
            error: 0xef4444,       // Red
            info: 0x6366f1,        // Indigo
            muted: 0x6b7280,       // Gray
            surface: 0xf9fafb,     // Light Gray
            background: 0x0a0a0a   // Dark Background
        };
        
        // Risk colors using Bun palette
        const riskColors = {
            low: bunColors.success,
            medium: bunColors.warning,
            high: bunColors.error,
            critical: 0xdc2626
        };
        
        // Secret type colors using Bun palette
        const secretTypeColors = {
            api: bunColors.primary,
            database: bunColors.accent,
            vault: bunColors.warning,
            session: bunColors.success,
            encryption: bunColors.info,
            backup: bunColors.muted,
            csrf: bunColors.secondary,
            audit: bunColors.error
        };
        
        function init() {
            // Check for WebGL support first
            if (!window.WebGLRenderingContext) {
                showWebGLError();
                return;
            }
            
            let renderer = null;
            
            try {
                // Scene setup with enhanced Bun colors
                scene = new THREE.Scene();
                scene.background = new THREE.Color(bunColors.background);
                scene.fog = new THREE.Fog(bunColors.background, 10, 50);
                
                // Camera setup
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(15, 15, 15);
                camera.lookAt(0, 0, 0);
                
                // Renderer setup with error handling
                renderer = new THREE.WebGLRenderer({ 
                    antialias: true,
                    alpha: true,
                    failIfMajorPerformanceCaveat: false
                });
                
                // Only proceed if renderer was created successfully
                if (!renderer) {
                    throw new Error('Failed to create WebGL renderer');
                }
                
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                
                document.getElementById('canvas').appendChild(renderer.domElement);
                
                // Store renderer globally for resize handler
                window.threeRenderer = renderer;
                
                // Enhanced lighting with Bun colors
                const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 10, 5);
                scene.add(directionalLight);
                
                // Multiple colored lights for better visualization
                const primaryLight = new THREE.PointLight(bunColors.primary, 0.5, 100);
                primaryLight.position.set(10, 10, 10);
                scene.add(primaryLight);
                
                const accentLight = new THREE.PointLight(bunColors.accent, 0.3, 100);
                accentLight.position.set(-10, 5, -10);
                scene.add(accentLight);
                
                const successLight = new THREE.PointLight(bunColors.success, 0.2, 100);
                successLight.position.set(0, 15, 0);
                scene.add(successLight);
                
                // Enhanced grid helper with Bun colors
                const gridHelper = new THREE.GridHelper(20, 20, bunColors.muted, 0x222222);
                scene.add(gridHelper);
                
                // Enhanced axes helper with Bun colors
                const axesHelper = new THREE.AxesHelper(5);
                scene.add(axesHelper);
                
                // Mouse controls
                setupControls();
                
                // Start animation
                animate();
                
                // Connect to WebSocket
                connectWebSocket();
                
                // Load initial data
                loadFieldData();
                
            } catch (error) {
                console.error('WebGL initialization failed:', error);
                showWebGLError();
            }
        }
        
        function setupControls() {
            let mouseX = 0, mouseY = 0;
            let targetX = 0, targetY = 0;
            
            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
            });
            
            function updateCamera() {
                targetX += (mouseX - targetX) * 0.05;
                targetY += (mouseY - targetY) * 0.05;
                
                camera.position.x = Math.cos(targetX * Math.PI) * 20;
                camera.position.z = Math.sin(targetX * Math.PI) * 20;
                camera.position.y = 10 + targetY * 10;
                camera.lookAt(0, 0, 0);
            }
            
            setInterval(updateCamera, 16);
        }
        
        function createFieldVisualization(data) {
            // Clear existing points
            fieldPoints.forEach(point => scene.remove(point));
            fieldPoints = [];
            
            // Create 3D field points with enhanced colors
            data.points.forEach((point, index) => {
                const geometry = new THREE.SphereGeometry(0.3 + point.value * 2, 32, 32);
                const material = new THREE.MeshPhongMaterial({
                    color: secretTypeColors[point.type] || bunColors.primary,
                    emissive: secretTypeColors[point.type] || bunColors.primary,
                    emissiveIntensity: point.value * 0.5,
                    shininess: 100,
                    transparent: true,
                    opacity: 0.8 + point.value * 2
                });
                
                const sphere = new THREE.Mesh(geometry, material);
                sphere.position.set(
                    point.x * 8,
                    point.z * 4,
                    point.y * 8
                );
                
                // Store original z position for animation
                sphere.userData = { 
                    z: point.z * 4, 
                    type: point.type,
                    value: point.value,
                    risk: point.risk
                };
                
                scene.add(sphere);
                fieldPoints.push(sphere);
                
                // Add connecting lines with enhanced colors
                if (index > 0) {
                    const prevPoint = data.points[index - 1];
                    const lineGeometry = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(
                            prevPoint.x * 8,
                            prevPoint.z * 4,
                            prevPoint.y * 8
                        ),
                        new THREE.Vector3(
                            point.x * 8,
                            point.z * 4,
                            point.y * 8
                        )
                    ]);
                    
                    const lineMaterial = new THREE.LineBasicMaterial({
                        color: riskColors[point.risk] || bunColors.muted,
                        opacity: 0.3 + point.value,
                        transparent: true
                    });
                    
                    const line = new THREE.Line(lineGeometry, lineMaterial);
                    scene.add(line);
                    fieldPoints.push(line);
                }
                
                // Add glow effect for high exposure points
                if (point.value > 0.05) {
                    const glowGeometry = new THREE.SphereGeometry(0.5 + point.value * 3, 16, 16);
                    const glowMaterial = new THREE.MeshBasicMaterial({
                        color: riskColors[point.risk] || bunColors.warning,
                        transparent: true,
                        opacity: 0.2 + point.value
                    });
                    
                    const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                    glow.position.copy(sphere.position);
                    scene.add(glow);
                    fieldPoints.push(glow);
                }
            });
            
            // Update overlay with enhanced styling
            updateUI(data);
        }
        
        function updateUI(data) {
            document.getElementById('systemId').textContent = data.systemId;
            document.getElementById('maxExposure').textContent = `${(data.maxExposure * 100).toFixed(1)}%`;
            document.getElementById('riskScore').textContent = Math.round(data.riskScore);
            document.getElementById('anomaly').textContent = data.anomaly;
            document.getElementById('totalSecrets').textContent = data.metadata.totalSecrets;
            
            // Update anomaly color
            const anomalyElement = document.getElementById('anomaly');
            anomalyElement.className = 'metric-value';
            if (data.anomaly === 'SECURE') {
                anomalyElement.classList.add('risk-low');
            } else if (data.anomaly.includes('RISK')) {
                anomalyElement.classList.add('risk-critical');
            } else {
                anomalyElement.classList.add('risk-medium');
            }
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            // Only render if renderer and scene are available
            if (window.threeRenderer && scene) {
                // Rotate field points
                if (rotationEnabled) {
                    fieldPoints.forEach((point, index) => {
                        if (point instanceof THREE.Mesh) {
                            point.rotation.y += 0.01;
                            point.position.y = point.userData.z + Math.sin(Date.now() * 0.001 + index) * 0.5;
                        }
                    });
                }
                
                window.threeRenderer.render(scene, camera);
            }
        }
        
        function connectWebSocket() {
            try {
                ws = new WebSocket(`${WS_BASE}/ws/secrets-3d`);
                
                ws.onopen = () => {
                    console.log('WebSocket connected');
                    updateStatus('Connected to live updates', 'connected');
                    ws.send(JSON.stringify({ type: 'subscribe' }));
                };
                
                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    
                    if (message.type === 'field-update') {
                        createFieldVisualization(message.data);
                    } else if (message.type === 'welcome') {
                        console.log('Welcome message:', message);
                    }
                };
                
                ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    updateStatus('WebSocket unavailable - using demo mode', 'disconnected');
                    // Don't auto-reconnect in demo mode to avoid console spam
                };
                
                ws.onerror = (error) => {
                    console.warn('WebSocket connection failed (expected in demo mode):', error);
                    updateStatus('WebSocket unavailable - using demo mode', 'disconnected');
                };
            } catch (error) {
                console.warn('WebSocket initialization failed (expected in demo mode):', error);
                updateStatus('WebSocket unavailable - using demo mode', 'disconnected');
            }
        }
        
        function updateStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }
        
        async function loadFieldData() {
            try {
                const response = await fetch(`${API_BASE}/api/secrets/field`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                createFieldVisualization(data);
            } catch (error) {
                console.error('Failed to load field data:', error);
                updateStatus('Server unavailable - using demo data', 'disconnected');
                
                // Use demo data when server is unavailable
                const demoData = {
                    timestamp: new Date().toISOString(),
                    systemId: 'demo-system',
                    points: [
                        { x: 1.0, y: 0.0, z: 0.58, value: 0.058, type: 'api', risk: 'low' },
                        { x: 0.7, y: 0.7, z: 0.0, value: 0.0, type: 'database', risk: 'low' },
                        { x: 0.0, y: 1.0, z: 0.82, value: 0.082, type: 'vault', risk: 'low' },
                        { x: -0.7, y: 0.7, z: 0.0, value: 0.0, type: 'session', risk: 'low' },
                        { x: -1.0, y: 0.0, z: 0.45, value: 0.045, type: 'encryption', risk: 'low' },
                        { x: -0.7, y: -0.7, z: 0.0, value: 0.0, type: 'backup', risk: 'low' },
                        { x: 0.0, y: -1.0, z: 0.23, value: 0.023, type: 'csrf', risk: 'low' },
                        { x: 0.7, y: -0.7, z: 0.0, value: 0.0, type: 'audit', risk: 'low' }
                    ],
                    maxExposure: 0.082,
                    anomaly: 'SECURE',
                    riskScore: 8.2,
                    metadata: {
                        totalSecrets: 1247,
                        activeRotations: 2,
                        complianceScore: 98.7,
                        recentActivity: 24
                    }
                };
                
                createFieldVisualization(demoData);
            }
        }
        
        async function rotateSecrets() {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'üîÑ Rotating...';
            
            try {
                const response = await fetch(`${API_BASE}/api/secrets/rotate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reason: 'Manual rotation from 3D visualization',
                        requestedBy: '3d-dashboard'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully rotated ${result.metadata?.totalRotated || 0} secrets!`);
                } else {
                    alert(`Rotation completed with ${result.errors?.length || 0} errors`);
                }
                
                // Reload field data
                setTimeout(loadFieldData, 1000);
                
            } catch (error) {
                console.error('Failed to rotate secrets:', error);
                
                // Show demo rotation when server is unavailable
                alert('Demo: Secret rotation simulated successfully!\n\nRotated 3 secrets:\n‚Ä¢ api:github-token\n‚Ä¢ database:primary-password\n‚Ä¢ vault:encryption-key\n\nNote: Server connection failed, showing demo response.');
                
                // Update UI to show rotation effect
                const statusElement = document.getElementById('status');
                statusElement.textContent = 'Demo rotation completed';
                statusElement.className = 'status connected';
                
                setTimeout(() => {
                    statusElement.textContent = 'Server unavailable - using demo data';
                    statusElement.className = 'status disconnected';
                }, 3000);
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }
        
        function toggleRotation() {
            rotationEnabled = !rotationEnabled;
            const button = document.getElementById('rotationBtn');
            button.textContent = rotationEnabled ? '‚è∏Ô∏è Pause Rotation' : '‚ñ∂Ô∏è Resume Rotation';
        }
        
        function resetView() {
            camera.position.set(15, 15, 15);
            camera.lookAt(0, 0, 0);
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.threeRenderer && camera) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                window.threeRenderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
        
        // Initialize on load
        window.addEventListener('load', init);
        
        // WebGL Error Handler
        function showWebGLError() {
            // Clean up any existing renderer
            if (window.threeRenderer) {
                window.threeRenderer = null;
            }
            
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; color: white; text-align: center; padding: 20px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <h2 style="margin-bottom: 16px; color: #f59e0b;">WebGL Not Available</h2>
                    <p style="margin-bottom: 24px; opacity: 0.8;">Your browser or system doesn't support WebGL, which is required for 3D visualization.</p>
                    <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; max-width: 400px;">
                        <h3 style="margin-bottom: 12px; color: #3b82f6;">üìä Demo Data Available</h3>
                        <p style="margin-bottom: 16px; font-size: 14px;">You can still view the secret field data in 2D format:</p>
                        <div id="demoData" style="text-align: left; font-family: monospace; font-size: 12px; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 4px;">
                            Loading demo data...
                        </div>
                    </div>
                    <div style="margin-top: 24px; font-size: 12px; opacity: 0.6;">
                        <p><strong>Troubleshooting:</strong></p>
                        <p>‚Ä¢ Update your browser to the latest version</p>
                        <p>‚Ä¢ Check if hardware acceleration is enabled</p>
                        <p>‚Ä¢ Try a different browser (Chrome, Firefox, Safari)</p>
                    </div>
                </div>
            `;
            
            // Load demo data for 2D display
            loadDemoData();
        }
        
        // Load demo data for 2D display
        function loadDemoData() {
            const demoData = {
                timestamp: new Date().toISOString(),
                systemId: 'demo-system',
                points: [
                    { x: 1.0, y: 0.0, z: 0.58, value: 0.058, type: 'api', risk: 'low' },
                    { x: 0.7, y: 0.7, z: 0.0, value: 0.0, type: 'database', risk: 'low' },
                    { x: 0.0, y: 1.0, z: 0.82, value: 0.082, type: 'vault', risk: 'low' },
                    { x: -0.7, y: 0.7, z: 0.0, value: 0.0, type: 'session', risk: 'low' },
                    { x: -1.0, y: 0.0, z: 0.45, value: 0.045, type: 'encryption', risk: 'low' },
                    { x: -0.7, y: -0.7, z: 0.0, value: 0.0, type: 'backup', risk: 'low' },
                    { x: 0.0, y: -1.0, z: 0.23, value: 0.023, type: 'csrf', risk: 'low' },
                    { x: 0.7, y: -0.7, z: 0.0, value: 0.0, type: 'audit', risk: 'low' }
                ],
                maxExposure: 0.082,
                anomaly: 'SECURE',
                riskScore: 8.2,
                metadata: {
                    totalSecrets: 1247,
                    activeRotations: 2,
                    complianceScore: 98.7,
                    recentActivity: 24
                }
            };
            
            const demoDataElement = document.getElementById('demoData');
            if (demoDataElement) {
                demoDataElement.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <strong style="color: #3b82f6;">üîê System Overview</strong>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; font-size: 11px;">
                        <div><strong>System ID:</strong> ${demoData.systemId}</div>
                        <div><strong>Max Exposure:</strong> <span style="color: #10b981;">${(demoData.maxExposure * 100).toFixed(1)}%</span></div>
                        <div><strong>Risk Score:</strong> <span style="color: #10b981;">${demoData.riskScore}/100</span></div>
                        <div><strong>Anomaly:</strong> <span style="color: #10b981;">${demoData.anomaly}</span></div>
                        <div><strong>Total Secrets:</strong> ${demoData.metadata.totalSecrets.toLocaleString()}</div>
                        <div><strong>Active Rotations:</strong> ${demoData.metadata.activeRotations}</div>
                        <div><strong>Compliance:</strong> <span style="color: #10b981;">${demoData.metadata.complianceScore}%</span></div>
                        <div><strong>Recent Activity:</strong> ${demoData.metadata.recentActivity}</div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <strong style="color: #3b82f6;">üìä Field Exposure Visualization</strong>
                    </div>
                    <div style="margin-bottom: 12px;">
                        ${demoData.points.map(p => {
                            const percentage = (p.value * 100).toFixed(1);
                            const barWidth = Math.max(2, percentage * 2); // Scale for visibility
                            const color = p.value > 0.06 ? '#f59e0b' : '#10b981'; // Yellow for higher values
                            const typeColor = secretTypeColors[p.type] || '#3b82f6';
                            return `
                                <div style="display: flex; align-items: center; margin-bottom: 4px; font-size: 11px;">
                                    <span style="width: 70px; text-align: right; margin-right: 8px; color: #6b7280;">${p.type}:</span>
                                    <div style="flex: 1; background: rgba(255,255,255,0.1); border-radius: 2px; height: 12px; position: relative;">
                                        <div style="width: ${barWidth}%; height: 100%; background: linear-gradient(90deg, ${color}, ${typeColor}); border-radius: 2px; transition: width 0.3s ease; box-shadow: 0 0 8px rgba(${parseInt(color.slice(1,3), 16)}, ${parseInt(color.slice(3,5), 16)}, ${parseInt(color.slice(5,7), 16)}, 0.3);"></div>
                                    </div>
                                    <span style="width: 35px; text-align: right; margin-left: 8px; font-size: 10px; color: #d1d5db;">${percentage}%</span>
                                    <span style="width: 30px; text-align: right; margin-left: 4px; font-size: 9px; padding: 1px 4px; background: ${color}; color: white; border-radius: 2px;">${p.risk}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="margin-top: 16px; padding: 8px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; border-radius: 2px; font-size: 10px;">
                        <strong style="color: #3b82f6;">üí° Demo Mode:</strong> This is simulated data. 
                        In production, this would show real-time secret exposure patterns from your FactoryWager Security Citadel.
                    </div>
                `;
            }
            
            // Update overlay with demo data
            const overlay = document.getElementById('overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
            
            // Update controls with demo info
            const controls = document.getElementById('controls');
            if (controls) {
                controls.style.display = 'none';
            }
            
            // Add interactive demo controls
            setTimeout(() => {
                addDemoControls(demoData);
            }, 1000);
        }
        
        // Add interactive demo controls for 2D mode
        function addDemoControls(demoData) {
            const canvas = document.getElementById('canvas');
            if (!canvas) return;
            
            // Find the demo container and add controls
            const demoContainer = canvas.querySelector('div');
            if (!demoContainer) return;
            
            const controlsHtml = `
                <div style="margin-top: 24px; padding: 16px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; backdrop-filter: blur(10px);">
                    <h4 style="margin-bottom: 12px; color: #3b82f6; font-size: 14px; text-shadow: 0 0 8px rgba(59, 130, 246, 0.5);">üéÆ Interactive Demo Controls</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="simulateRotation()" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3); transition: all 0.3s ease;">üîÑ Simulate Rotation</button>
                        <button onclick="refreshData()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); transition: all 0.3s ease;">üîÑ Refresh Data</button>
                        <button onclick="showDetails()" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); transition: all 0.3s ease;">üìä Show Details</button>
                    </div>
                </div>
            `;
            
            demoContainer.insertAdjacentHTML('beforeend', controlsHtml);
            
            // Make functions globally available
            window.simulateRotation = function() {
                alert('üîÑ Demo: Secret rotation simulated!\n\nRotated 3 secrets:\n‚Ä¢ api:github-token\n‚Ä¢ vault:encryption-key\n‚Ä¢ database:primary-password\n\nAll systems operational.');
            };
            
            window.refreshData = function() {
                // Simulate data refresh with slight variations
                const variations = demoData.points.map(p => ({
                    ...p,
                    value: Math.max(0, Math.min(0.1, p.value + (Math.random() - 0.5) * 0.02))
                }));
                
                const newData = {
                    ...demoData,
                    points: variations,
                    maxExposure: Math.max(...variations.map(p => p.value)),
                    riskScore: Math.max(...variations.map(p => p.value)) * 100
                };
                
                // Update the display
                loadDemoData();
                
                // Show success message with enhanced styling
                const demoDataElement = document.getElementById('demoData');
                if (demoDataElement) {
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 16px; border-radius: 6px; font-size: 12px; z-index: 1000; animation: slideIn 0.3s ease; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); border: 1px solid rgba(16, 185, 129, 0.3);';
                    successMsg.innerHTML = '‚úÖ <strong>Data refreshed successfully!</strong><br><small style="opacity: 0.8;">Field exposure values updated</small>';
                    document.body.appendChild(successMsg);
                    
                    setTimeout(() => {
                        successMsg.style.animation = 'slideIn 0.3s ease reverse';
                        setTimeout(() => successMsg.remove(), 300);
                    }, 3000);
                }
            };
            
            window.showDetails = function() {
                const details = `
üîç Detailed Analysis\n\nField Distribution:\n‚Ä¢ High Risk: 0 points\n‚Ä¢ Medium Risk: 0 points\n‚Ä¢ Low Risk: 8 points\n\nExposure Analysis:\n‚Ä¢ API: ${demoData.points.find(p => p.type === 'api')?.value ? 'Active' : 'Dormant'}\n‚Ä¢ Database: ${demoData.points.find(p => p.type === 'database')?.value ? 'Active' : 'Dormant'}\n‚Ä¢ Vault: ${demoData.points.find(p => p.type === 'vault')?.value ? 'Active' : 'Dormant'}\n\nSecurity Status: ‚úÖ SECURE\nCompliance: ‚úÖ 98.7%\nNext Audit: 30 days\n\nThis is a comprehensive 2D view of your secret field data when 3D visualization is unavailable.`;
                
                alert(details);
            };
        }
    </script>
</body>
</html>
