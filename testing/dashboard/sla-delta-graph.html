<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Performance SLA Delta Visualization</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #e0e0e0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #fff;
    }
    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 30px;
    }
    .chart-container {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .tooltip {
      position: absolute;
      background: rgba(30, 30, 50, 0.95);
      border: 1px solid #444;
      border-radius: 8px;
      padding: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 13px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      min-width: 200px;
    }
    .tooltip .title {
      font-weight: bold;
      color: #fff;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .tooltip .row {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
    }
    .tooltip .label {
      color: #888;
    }
    .tooltip .value {
      font-weight: 600;
      font-family: 'SF Mono', Monaco, monospace;
    }
    .tooltip .optimization { color: #4ade80; }
    .tooltip .security { color: #f472b6; }
    .tooltip .neutral { color: #60a5fa; }
    .legend {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }
    .axis-label {
      fill: #888;
      font-size: 12px;
    }
    .bar-label {
      fill: #fff;
      font-size: 11px;
    }
    .delta-indicator {
      font-size: 10px;
      font-weight: bold;
    }
    .grid line {
      stroke: rgba(255,255,255,0.1);
    }
    .grid .domain {
      stroke: rgba(255,255,255,0.2);
    }
    .feature-label {
      fill: #ccc;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>ðŸš€ Performance SLA Delta Visualization</h1>
  <p class="subtitle">Base vs Active State Performance - Nanoseconds (Log Scale)</p>
  
  <div class="chart-container">
    <div id="chart"></div>
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background: #4ade80;"></div>
        <span>Optimization (Faster)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #f472b6;"></div>
        <span>Security Overhead</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #60a5fa;"></div>
        <span>Neutral Change</span>
      </div>
    </div>
  </div>
  
  <div class="tooltip" id="tooltip"></div>

  <script>
    // Performance data: base (without optimization) vs active (with optimization)
    const performanceData = [
      { 
        feature: "stringWidth Emoji", 
        category: "optimization",
        base: 363875, 
        active: 98959,
        description: "Grapheme width calculation with caching"
      },
      { 
        feature: "stringWidth ANSI", 
        category: "optimization",
        base: 833, 
        active: 459,
        description: "ANSI escape code detection optimization"
      },
      { 
        feature: "stringWidth ZWJ", 
        category: "optimization",
        base: 2792, 
        active: 1500,
        description: "ZWJ sequence grapheme clustering"
      },
      { 
        feature: "Bun.write", 
        category: "optimization",
        base: 846250, 
        active: 143417,
        description: "File write with buffer optimization"
      },
      { 
        feature: "Bun.build DCE", 
        category: "optimization",
        base: 2403625, 
        active: 1614792,
        description: "Dead code elimination at compile time"
      },
      { 
        feature: "Bun.spawn", 
        category: "security",
        base: 15184000, 
        active: 14882000,
        description: "Process isolation overhead"
      },
      { 
        feature: "Feature Flag Check", 
        category: "optimization",
        base: 150, 
        active: 15,
        description: "Compile-time feature resolution"
      },
      { 
        feature: "Bundle Import", 
        category: "neutral",
        base: 2500, 
        active: 2800,
        description: "Module resolution overhead"
      },
      { 
        feature: "Minification", 
        category: "optimization",
        base: 890, 
        active: 120,
        description: "Whitespace removal and var renaming"
      },
      { 
        feature: "AST Walk", 
        category: "security",
        base: 450, 
        active: 680,
        description: "Security validation during parsing"
      }
    ];

    // Calculate delta percentage
    performanceData.forEach(d => {
      d.delta = ((d.active - d.base) / d.base * 100).toFixed(1);
      d.isFaster = d.active < d.base;
    });

    // Chart dimensions
    const margin = { top: 40, right: 120, bottom: 60, left: 180 };
    const width = 1100 - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;

    // Create SVG
    const svg = d3.select("#chart")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    // X scale (logarithmic for nanoseconds)
    const xMax = Math.max(...performanceData.map(d => d.base)) * 1.2;
    const x = d3.scaleLog()
      .domain([10, xMax])
      .range([0, width])
      .nice();

    // Y scale
    const y = d3.scaleBand()
      .domain(performanceData.map(d => d.feature))
      .range([0, height])
      .padding(0.3);

    // Color scale
    const colors = {
      optimization: "#4ade80",
      security: "#f472b6",
      neutral: "#60a5fa"
    };

    // Add grid
    const xAxis = d3.axisBottom(x)
      .ticks(5, "~s")
      .tickFormat(d => {
        if (d >= 1000000) return (d / 1000000) + "ms";
        if (d >= 1000) return (d / 1000) + "Î¼s";
        return d + "ns";
      });

    svg.append("g")
      .attr("class", "grid")
      .attr("transform", `translate(0,${height})`)
      .call(xAxis.tickSize(-height).tickFormat(""))
      .selectAll("line")
      .style("stroke", "rgba(255,255,255,0.1)");

    svg.append("g")
      .attr("class", "grid")
      .attr("transform", `translate(0,${height})`)
      .call(xAxis);

    // X axis label
    svg.append("text")
      .attr("class", "axis-label")
      .attr("x", width / 2)
      .attr("y", height + 45)
      .attr("text-anchor", "middle")
      .text("Time (nanoseconds, log scale)");

    // Y axis
    svg.append("g")
      .call(d3.axisLeft(y))
      .selectAll("text")
      .attr("class", "feature-label");

    svg.selectAll(".domain, .tick line").style("stroke", "#444");

    // Tooltip
    const tooltip = d3.select("#tooltip");

    // Create grouped bars
    const barGroups = svg.selectAll(".bar-group")
      .data(performanceData)
      .enter()
      .append("g")
      .attr("class", "bar-group")
      .attr("transform", d => `translate(0, ${y(d.feature)})`);

    // Base state bars (background)
    barGroups.append("rect")
      .attr("class", "bar-base")
      .attr("x", d => x(10)) // Start from minimum
      .attr("y", 0)
      .attr("width", d => x(d.base) - x(10))
      .attr("height", y.bandwidth())
      .attr("fill", d => colors[d.category])
      .attr("opacity", 0.3)
      .attr("rx", 4);

    // Active state bars (foreground)
    barGroups.append("rect")
      .attr("class", "bar-active")
      .attr("x", d => x(10))
      .attr("y", y.bandwidth() * 0.15)
      .attr("width", d => x(d.active) - x(10))
      .attr("height", y.bandwidth() * 0.7)
      .attr("fill", d => colors[d.category])
      .attr("opacity", 0.9)
      .attr("rx", 3)
      .style("cursor", "pointer")
      .on("mouseover", function(event, d) {
        d3.select(this).attr("opacity", 1).attr("stroke", "#fff").attr("stroke-width", 2);
        
        const deltaClass = d.isFaster ? "optimization" : (d.category === "security" ? "security" : "neutral");
        const deltaSign = d.isFaster ? "â†“" : "â†‘";
        const deltaColor = d.isFaster ? "#4ade80" : (d.category === "security" ? "#f472b6" : "#60a5fa");
        
        tooltip.html(`
          <div class="title">${d.feature}</div>
          <div class="row"><span class="label">Base:</span><span class="value">${d.base.toLocaleString()}ns</span></div>
          <div class="row"><span class="label">Active:</span><span class="value">${d.active.toLocaleString()}ns</span></div>
          <div class="row"><span class="label">Delta:</span><span class="value ${deltaClass}">${deltaSign} ${Math.abs(d.delta)}%</span></div>
          <div class="row" style="margin-top: 8px; border-top: 1px solid #444; padding-top: 8px;">
            <span class="label">${d.description}</span>
          </div>
        `)
        .style("left", (event.pageX + 15) + "px")
        .style("top", (event.pageY - 10) + "px")
        .style("opacity", 1);
      })
      .on("mousemove", function(event) {
        tooltip
          .style("left", (event.pageX + 15) + "px")
          .style("top", (event.pageY - 10) + "px");
      })
      .on("mouseout", function() {
        d3.select(this).attr("opacity", 0.9).attr("stroke", "none");
        tooltip.style("opacity", 0);
      });

    // Delta percentage labels
    barGroups.append("text")
      .attr("class", "delta-indicator")
      .attr("x", d => Math.max(x(d.base), x(d.active)) + 8)
      .attr("y", y.bandwidth() / 2 + 4)
      .attr("fill", d => d.isFaster ? "#4ade80" : (d.category === "security" ? "#f472b6" : "#60a5fa"))
      .text(d => {
        const sign = d.isFaster ? "â†“" : "â†‘";
        return `${sign}${Math.abs(d.delta)}%`;
      });

    // Add minimum scale indicator
    svg.append("text")
      .attr("x", x(10))
      .attr("y", -10)
      .attr("text-anchor", "middle")
      .attr("fill", "#666")
      .attr("font-size", "10px")
      .text("10ns");

    // Title
    svg.append("text")
      .attr("x", width / 2)
      .attr("y", -15)
      .attr("text-anchor", "middle")
      .attr("fill", "#fff")
      .attr("font-size", "14px")
      .attr("font-weight", "bold")
      .text("Performance Comparison: Base State â†’ Active State");
  </script>
</body>
</html>
